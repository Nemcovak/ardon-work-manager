<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARDONÂ® Work Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;800&display=swap');
        * { font-family: 'Barlow', sans-serif; }
        .ardon-red { background-color: #E30613; }
        .ardon-red-text { color: #E30613; }
        .priority-1 { border-left: 4px solid #E30613 !important; background: rgba(227,6,19,0.08) !important; }
        .priority-2 { border-left: 4px solid #F59E0B !important; background: rgba(245,158,11,0.08) !important; }
        .priority-3 { border-left: 4px solid #10B981 !important; background: rgba(16,185,129,0.08) !important; }
        .timer-active { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
        .modal-bg { background: rgba(0,0,0,0.75); backdrop-filter: blur(6px); }
        input, select, textarea { color: white !important; }
        input::placeholder { color: rgba(255,255,255,0.4) !important; }
        option { background: #1f2937; color: white; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #E30613; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

<!-- LOGIN -->
<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4" style="background:#000000">
    <div class="absolute top-4 right-4">
        <select onchange="setLang(this.value)" class="bg-gray-800 text-white px-3 py-2 rounded-lg border border-gray-700 text-sm">
            <option value="cs">ğŸ‡¨ğŸ‡¿ ÄŒeÅ¡tina</option>
            <option value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
            <option value="en">ğŸ‡¬ğŸ‡§ English</option>
        </select>
    </div>
    <div class="w-full max-w-md">
        <div class="text-center mb-8">
            <div class="mb-2">
                <img src="data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCAHAA0MDASIAAhEBAxEB/8QAHQABAAMBAQEBAQEAAAAAAAAAAAcICQYFBAMBAv/EAFoQAQABAwICBAQODQcKBgMBAAABAgMEBQYHEQgSITETGEFRCSIyN1ZhcXR1gZGVs9MUFzY4QlRVV5SxstHSFVJ2kqGitBYjJDM1Q2Jyc5M0goOjwcJTY2XD/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/AKZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD0dtaJqe5NwYOg6LiV5eo59+mxj2aO+qqqeXxR5ZmeyIiZlotwB6N+zuHOm42frGFi69ueaYrvZmRbi5ax6/wCbYpqjlTEfz5jrT7UTygM+tJ2LvfVsaMrStnbiz7E913G0y9don46aZh9n2sOJX5vN3fMuR/A1qAZK/aw4lfm83d8y5H8B9rDiV+bzd3zLkfwNagGSv2sOJX5vN3fMuR/Afaw4lfm83d8y5H8DWoBkr9rDiV+bzd3zLkfwH2sOJX5vN3fMuR/A1qAZK/aw4lfm83d8y5H8B9rDiV+bzd3zLkfwNagGSv2sOJX5vN3fMuR/Afaw4lfm83d8y5H8DWoBkr9rDiV+bzd3zLkfwP5Xwy4kUUzVXw+3ZTTHbMzo2RER/ca1gMbs3Ey8HJqxs3FvY1+j1Vu9bmiqn3Ynth+DXLiDsLaG/tIr0zdmhYepWppmm3cuUcrtnn5bdyPTUT7ks7ek5wS1HhBua1Ni9dz9uahVVOn5lcenpmO2bV3lHLrxE98dlUdscuUxAQ+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC23ocG0cbO3TuLemVa69emWLeHhzMc4prvdablUeaYpoin3LkrxKo+hs+t9uqf/wCrR9FC1wAAA/lyui3bquXKqaKKYmaqqp5RER3zMqtcd+l1oe3L2RoXDqxY17U6Jmi5qNyZnDs1f8HKed2Y88TFPt1dwLQZuXi4OJcy83Js4uPajrXLt6uKKKI88zPZEIj3h0meDW267lmvddGq5FE8vBaXZqyOfuXIjwf95nnxC4ib13/qH2Zu3cWbqcxVzt2a6+rZtf8AJbp5UU/FDlQXx1PptbEtXJp03aW48qj+dfmzZ5/FFdT5MbpvbVqr5ZOx9at0+e3k2q5+SeSjJPZ3g0W230vuD+q10UZ2RrWiVVdkzm4PWpifdszX2e3yTHs7em0t44s5O1tx6ZrFumOdcYuRTXVb/wCamJ61PxxDIZ9OmZ+dpedaztNzcnCy7U9a3fx7tVu5RPniqmYmAbHigXBnpebw23dx9N35aq3NpMcqZyo5U51qnz9bspu+5Vymf5y7XDzfG19/7et67tTVrOoYdU9Wvq9ldmvy0XKJ7aavan3Y5x2g6MABG/SZ2jjb14Ibm0q7a6+RYw683DmI9NTfs0zXRy83PlNM+1VKSHmbtjntXV4n8RvfsSDHoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAF6vQ2fW+3T8K0fRQtcqj6Gz6326fhWj6KFrgH4ahmYun4N/Pzsm1jYuPbqu3r12uKaLdFMc5qqmeyIiI5837qN9O/jRd1XV73C7bmVNOnYNyP5ZvW6v/ABF+O2LPZ+DRPqvPV2fg9ocr0p+kdqXEPLydrbTv3sDaVuuaK66Zmi7qXL8Kvyxb81Hl76u3lFNdRcvoa8NOFOLawN17h3ZtvW91XOrcxdLnOtVRgTPqeduZ513fb5cqZ7ucx1gRnwX6K+/N+WLOq63MbV0W5EVUXcu1NWRep89FnnExHt1TT5JjmtZsLoucIdrWbVWRoNW4c2j1WRqtybsVT/0o5W+Xu0zPtym0B5mj7e0DRqYp0fQ9M06mI5RGLiUWoj+rEPtzMTFzLM2czGs5Fqe+i7biumfil+wCPd3cE+FO6bVVGr7F0br1R23sWxGNd93r2urVPxyrnxX6FtVFu/qHDbXqrkxE1U6Xqcxzn/hovRER7URVHu1LnAMe907d13a2tXtF3FpWXpeoWJ9PYyLc01cvJMeemfJMc4nyS9fhbxB3Rw33Ra1/a+oVY96mYi/YqmZs5NHPtt3Kfwqf7Y74mJ7WkHSE2hwy3jtT+T+IepaXpE0U1VYWo5GVbx72NV5ZoqrmOcd3OmecT7sRMZnb30TG27unP0fC1vT9cxce7NNnPwbnWtX6O+Ko808u+PJPPtnvkNO+A/Fjb/FraEazpP8Ao2dYmLeoafXXE3Ma5Mf3qJ5T1avLynumJiJDZNcGuImtcMd94W59GuVVRbq6mXi9blRlWJmOvbq93vifJMRPkambJ3LpO8dp6bubQsjw+nahYi9Zq7pjyTTVHkqpmJpmPJMSD2Xmbs+5bVveN79iXpvM3Z9y2re8b37Egx6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABer0Nn1vt0/CtH0ULXKo+hs+t9un4Vo+iha4Ec9JDiFRw04SatuK3XTGo10/Ymm0z+Fk3ImKZ5eXqxFVcx5YolljkXr2TkXMjIu13b12ua7lyuqZqrqmeczMz3zMrW+iO7uuZm9NB2VYu/6Pp2JOdkUxPZN67M00xPt00Uc4/6kq0bE27mbu3no+2MCJ+yNTzLeNRVy59TrVRE1T7URzmfagHijUvO4A8Hs7ScbTsvYWkV0Y9iixTdtW5sXq4ppimJquW5pqqq7O2qZ5yiviP0NdjajpOTd2Tn6houqU0zVYtZF/w+NXPL1NXWjrxz7ut1p5eaQVu4EdIfe3DTUcfFyM3I1zbfWim9puTdmqbdPns1z225jzepnyx5Y0c2duPSN3bY0/cmg5VOVpufZi7YuRHKeXdMTHkqiYmJjyTEwyG1TBy9M1PK03Ps1WMvEvV2L9qrvouUVTTVTPuTEwuh6G7uzJyNI3NsvJu1V2sO5bz8OJq59WLnOi7EeaOdNE+7VPnBb8ABUXpbdJjO27q+VsPh3k0WtQx5m3qeqxEVTYr8tm1E9nWjuqq7eU84jlMc4shxe3LXs7hfuTc9rq+H07Trt6xFXdN3qzFuJ9rrTSyVyb97JyLuTkXa7167XNdy5XVzqrqmeczMz3zMg/fVtS1HV8+7qGq5+Vn5l6etcv5N2q5crnzzVVMzL5FlOit0a7HE3Qqt37r1LLwdCm9XZxcfE6sXsqaeyqvr1RMU0RVzp7pmZie7lzm0m2ujPwX0Pq10bOs6hep77moZFzI63u0VVdT+6DMdbv0O/iPcxNb1DhnqWRzx82mrN0uKp9Tepj/O24/5qI6/LydSrzuf6fHDLS9n7s0bc229KxNN0nVcece7j4lmm1atZFqI5TFNMRFPWomnsiO+iqfKgHh/uPK2hvfRd0YfOb2mZtrJimJ5deKaomqj3Ko5xPtSDXt5m7PuW1b3je/Yl9mn5djPwMfOxbkXMfJtU3rVcfhU1RExPyS+Pdn3Lat7xvfsSDHoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAF6vQ2fW+3T8K0fRQtcqj6Gz6326fhWj6KFrgZa9KvWKtb6Q288uapqizqNWHHPyRYpizy/wDbd16H5oNGrceY1O5TE06Npl/Komf59fVsx/Zdqn4kQcXq67vFjeFy7/rK9dzaqvdm/XzWO9DUt253bvG7Mf5ynAx6aZ9qblXP9UAvCADKPpEU008d98xTERH8vZc9nt3apTR6G7M/bX3DHk/kKr6e0hnpFevxvn4dy/panVdETint7hRv/UdY3Lj6hdw83TpxIqw7dNdVuqblFfOYmqOzlTPdzn2gaYCGdJ6UPBHULMVzvH7Dr8tvJwMiiqPjiiYn4pfZf6SXBGzRNde/cOYiOfKjFyK5+SLcg/nTEmY6Nm8eX4vZ/wARaZhLq9JfpLcNt3cKdd2btqrVs/M1Ki3bt35xPBWaOrdormZmuYq7qZjsp8qlQNPOhxTTT0atnxTERHgL89nnnJu80uIk6HP3tezv+hf/AMRdS2CCunVoFGtdHjVcrwcVXtIycfOteePTxaq/uXap+Jm41T6TVui70f8Ae9NyImI0i9VHPzxHOP7YhlYDUvor6xXrnR62ZnXK+vXRp8Ys1eX/ADFdVn//ADd1uz7ltW943v2JRB0Fa6qujbodMxPKjJy4j3PD1z/8yl/dn3Lat7xvfsSDHoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAF6vQ2fW+3T8K0fRQtcqj6Gz6326fhWj6KFrgZR9IbTqtK46b2w5pmmP5byrtMT/ADblyblP9lUJj9Dk1anF4ua1pNyuKYz9GqroiZ9VXbu25iP6tVc/E8z0QPbFzRuN9OvUWuWNr2BavRXEdk3bUeCrj3Ypptz/AOZFvAHeFGw+MO29z365oxMXLijLmPJYuRNu5PLy8qa5nl54gGrw/lFVNdFNdFUVU1RziYnnEx539BlX0l8W/h8ft72si3VRXVrF+7ETH4NdXXpn46aon40dr89OHgle3jo8b+2theF17TbPVz8e1T6fMxqe3rRH4Vyjzd80847ZpphQYAT30XNS4Natm29m8VNqafN+/c5afrNV+7Ziaqp/1V6aK6Yjt9TXPuT5JTd0gNodG/g9t2Mq/sTDz9eyaJ/k7TJ1DJqm5Pd16+dyerbie+fL3R7QUWH7Zt/7KzL2T4GzZ8Lcqr8HZo6tFHOefKmPJEeSEvdFbg1m8Vt7W7ubYuW9rabcpr1PI7Yi75YsUT5aqvLy9TTznv6vMLv9EbFv4fRx2ZayLc0V1Ydd2ImPwa71yumfjpqifjSq/PFx7GJi2sXFs27NizRFu1bt0xTTRTEcopiI7oiOzk/QEQdMrVqNI6OO6q5qiLmVatYluOfqpuXqKZ/u9afiZjLp+iQb0tU4W3uH+Ne53q7k6pm0xPqaYiq3aifdmbk8v+GJU003CydR1HG0/CtVXsnKvUWbNunvrrqmKaYj3ZmAaZ9DjTbml9G7aNm7HKu9ZvZM+3F2/crp/u1UpK3Z9y2re8b37Ev8bM0SztraGjbdx5ibOmYNnDomPLFuiKefx8ub/e7PuW1b3je/YkGPQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL1ehs+t9un4Vo+iha5VH0Nn1vt0/CtH0ULXAgPpzcP6t5cHLusYVmbmp7brqzrUUxzmqxMcr9P8AViK//TZxtlrlFFy3VbuUU10VRNNVNUc4mJ74mGZfSu4R5HCziJd+wrFX+Teq115Gl3Yjstxz51WJnz0TMcvPTNM9/PkFtOhDxVt754b29s6nkxOv7dtU2K4qq9NfxY7LVyPPyjlRV7cRM+qWCZD8Pd365sTd2DujbuVOPn4dfWjn20XaZ9Vbrjy01R2TH6p5S0j4ccfeG+7di2tzZW5NL0K5REUZ2HqGXRauY93lzmmOtMdeJ7erVHfHmmJiAlVSTpldHa/hZWbxG2HgdfBuda/q+nWKe2xV31X7dMd9E99VMepnnMdnPqyNxG6YvDzQou421cPO3RmU84puU0zjY3P266460/FRMT51UeLvH7iRxKpu4eq6tGn6Pcn/AGZp8Tas1R5q55zVc9yqZjn3RAIqfTqGdnajfpv6hmZGXept024uX7tVdUUUxFNNPOZ7oiIiI8kQ+Z+l+zesVxRftXLVU0xVFNdMxM0zHOJ7fJMTEwCQOBPCXcnFnddOl6RbnH0+xVTVqOo1087eLbmf71c8p6tPl9qImY014fbQ0LYm0sHbG3MSMbAw6OUc+2u5VPqrlc/hVVT2zP6o5Qym2LvXdWxtYjVtp65maVl9kVVWa/S3Ij8GuiedNce1VEwtVww6atVFq1hcRduVXKo5ROoaTyiZ9uqzXPL3Zpq9ykFznlbv3BpW1NsajuPW8mMfTtPsVX79ye/lHkiPLVM8oiPLMxDkNo8b+FG6MCrL0zfOj2+pRNdyzmX4xrtERHOqZoudWZiPLMc49tS3pdcervEzWP8AJvbV+7a2jg3OdM8ppnPux/vao74oj8Gmf+ae2YikIn4tb11DiHxC1fd2pU+DuZ97nbsxVzizapiKbduPcpiI5+Wec+VLPQS4f3N2cYbW4smz1tL21TGXXVVHZVkTzizT7sTE1/8Ap+2gfRdMz9Z1bE0nSsS7l52Zeps49i1HOq5XVPKIj42pHR34Z4nCvhng7eoi3c1G7/pOp5FP+9yKojrcp/m0xEUx7VPPvmQSK8zdn3Lat7xvfsS9N5m7PuW1b3je/YkGPQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL1ehs+t9un4Vo+iha5VH0Nn1vt0/CtH0ULXAOU4sbB0DiVsvL2vuGx1rF6OvYv0xHhMa7ET1btE+SqOfxxMxPZMurAZN8YeGm5eF27bugbixuyedeJmW4nwOXb59ldE/rp74nv8nPi2uXEnYe1+Ie2rugbq0y3m4tfprdfqbtivl2V26++mqP7e6YmOcKDcdejHvbh7dv6notm9uXbsTNUZONamb+PT/wDttx29kfh086eznPV7gQMknhLwQ4icTJt39v6LVa0uquaatTzKvBY1PKeU8qu+vlPZyoipGz19s7o3JtjKnK25r+qaRemfTV4WVXZmr3erMc49qQX84MdFLYmybmPqu4p/yq1m3yqpnJtxTiWqvPTZ7etMeeuZ8kxESkrizwk2LxO02nF3Ro9FeRap6uPnY8xbybEeamuI7Y/4aomn2lBtJ6T3G7TqaaKd6VZVun8HJwce5z92qaOt/a+7K6V/G69E+D3Lh4/P/wDHpmPPL+tRIOh4u9ETfW2K7uds25G69MjnMWrcRbzLce3bmeVfu0Tzn+bCuOXj5GJlXcXKsXbGRZrmi7au0TTXRVE8ppmJ7YmJ8kux3ZxZ4l7qouWte3vrmXYuRMV48ZVVuzVHt26OVH9jiQH6Yti/lZNrGxbNy/fvVxRbtW6ZqqrqmeUUxEdszM+R1XDLhtvPiPq8adtLRL+b1aoi9kzHUx7ET5blyfS09nby758kSvv0dOjjtrhdTZ1rUqret7q6nbmVU/5rF5x202KZ7vN159NPk6sTMA53oedH3/IDEt713fjUzunJtTGNjVcpjTrdUdsf9WqOyZ/Bier5Z52VAB5m7PuW1b3je/Yl6bzN2fctq3vG9+xIMegAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAXU9DU1rHnTt47dqrppyKLuPm26efbXRMVUVTEeaJpo/rQuIyf4HcRNQ4X8RtP3Xg0TetW5mzm48Ty+yMeqY69HtT2RMT5KqaWoWwd4be3ztjF3HtnULebgZNPOJpn01ury0V099NceWJ/UD3gAAARVxP6PvC7iBcvZeqbfpwNTu85q1DTavse9Mz+FVERNFc+3VTMq9bw6EWr2667m0d64OTRM+ls6pj1WZpjzde31+f8AVhdoBnBq3RJ404VfVxtH0zUo5+qxdStUx/7s0Pjxuirxyu3YoubRs49Mz213NVxZiP6tyZ/saVgKCbb6FvEbNvUTrevbe0nHn1Xg7lzIu0/+WKaaZ/rpt4d9D/htt2/by9w5GfunJo5T1MmfAY3Pz+DonnPuVVTHtLHAPj0bS9M0XTrWnaPp2Jp2FZjlbx8WzTat0R7VNMREPsAAABy3F7WsfbvCzdGt5NdNNGJpWRXHWnl1q/BzFFPuzVMRHty6mZiI5zPKIUb6cvHLT9yUfa22hm0ZWn2L0XNXzLVUTbv3KJ502aJjsqppq9NM901RTy7p5hUsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0vD/AH7u/YOqzqW0dey9Kv18vC026om3diO6K6KudNce7EuaAWa0nppcTMbGi1naHtnPrj/ezYu26p92KbnL5Ih9njtb+9ie2fkv/WKsgLTeO1v72J7Z+S/9YeO1v72J7Z+S/wDWKsgLTeO1v72J7Z+S/wDWHjtb+9ie2fkv/WKsgLTeO1v72J7Z+S/9YeO1v72J7Z+S/wDWKsgLTeO1v72J7Z+S/wDWHjtb+9ie2fkv/WKsgLTeO1v72J7Z+S/9YeO1v72J7Z+S/wDWKsgLTeO1v72J7Z+S/wDWP5X02uIE0z1NqbYiryTNN+Y+kVaAS1xO6RHFPf8AhXdO1PXKdP0y7TNN3C0y34C3cie+Kp5zXVHtTVMe0iUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+uHjZOZlWsTDx7uRkXq4otWrVE1111T2RERHbMz5oTHtvovcaNbwqMyNrU6darpiqiM/Lt2a592jnNdM+1VEAhcT94onGX8Q0f5xp/ceKJxl/ENH+caf3AgET94onGX8Q0f5xp/ceKJxl/ENH+caf3AgET94onGX8Q0f5xp/ch3fu1dX2Tu7P2trtFq3qWBVTTfptXIrpiaqKa45VR39lUA8MeltfRc7cm5NN2/pdNFWdqWVbxcemurq0zcrqimnnPkjnMdqbPFE4y/iGj/ADjT+4EAifvFE4y/iGj/ADjT+48UTjL+IaP840/uBAIn7xROMv4ho/zjT+48UTjL+IaP840/uBAIm3Xuixxp0nDqyqdtWNQooiZqpws21criPaomYqq9ymJlDWpYObpmfewNSw8jCzLFXUvWMi3Nu5bq81VM8pifakHzg6zhXw+3HxK3LXt7a9rHu51GNXkzTfvRbp6lM0xPbPl51QDkxP3iicZfxDR/nGn9x4onGb8n6P8AONH7gQCJ+8UTjN+T9H+caP3HiicZvyfo/wA40fuBAIn7xROM35P0f5xo/c5venRx4w7Uwrmfm7RvZuJbjnXd069Rk9WPLM0UTNfKPLPV5AiUf2YmJ5THKX8AB2HDvhhv3iDdqp2htjO1O3RV1a8iIi3YonzTdrmKIn2ufMHHifaOiLxmqoiqdN0iiZj1M6jRzj5H98UTjL+IaP8AONP7gQCJ+8UTjL+IaP8AONP7ieiJxmiOf8n6PPtfyjQCAR3fEbhBxH4fWvsjdW1czDw+fL7LtzTfx+czyjnctzVTTM+SKpifacIACadn9GTipuva+nbj0jC0uvA1GxTfx6rmdTTVNFXdzjyAhYTrq3RQ4y6dpmTnzo2BlRj2qrk2cbNpru1xEc5imn8KfNEds+RBldFVuuqiumaa6Z5VUzHKYnzSD/IAA9XaGgajurc+nbc0ii3Xn6jfpx8em5X1aZrqnlHOfJCafFE4y/iGj/ONP7gQCO54ucK928Lc/Awt22MS1ez7VV2xGPkRdiaaZiJ58u7tlz+0Nra/u3U6tO29pl3Ov0W5u3erNNFFm3HfXcrqmKaKY5x6aqYjtB4w7PcPDLdejaNe1rwWmarpmNMRk5ej6nj59vGmZ5R4WbNdXg+2YjnVyjt73GAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9rYmHY1He+g6fk09exk6lj2blPnpqu0xMfJIL/AHQ84J6ZsHZmFunWMK3e3Xqtim/Xcu086sK1XHOm1Rz9TV1ZjrT385mO6FgBAfTM4u7n4Vbc0GratGHTmapk3aa7+Ra8J4Oi3TTPKmnu5zNcds93L2+wJ8Gcnjc8Z/ynpPzdQeNzxn/Kek/N1ANGxnJ43PGf8p6T83UJv6G/HHf/ABO4h6rou68vBvYeNpNeVbpsYlNqYuRetUxPOPJyrnsBaxmF0xfvk94++LH+HtNPWYXTF++T3j74sf4e0Dnuj56+uxf6QYX01LV5lD0fPX12L/SDC+mpavACtXTT4xb24WahtiztHKw7FGo2smrI8PjU3ec0Tbinlz7vVSrz43PGf8p6T83UA0bGcnjc8Z/ynpPzdQeNzxn/ACnpPzdQDRtCvSp4KaXxQ2dk5+Bh2rW7NPs1XMDJop5VZEUxz8BXP4UVd1PP1NUxMdkzE870L+M+7eKlO5MLdtOFdv6X4C7YyMez4KaqbnXiaaqY7OyaImJ9uVjAY0VRNNU01RMTE8pie+FjfQ8PX5yvgLI+lsoi434djT+M29MHGp6lizr2bRbpj8GmL9fKPihLvoeHr85XwFkfS2QaFApf0nekRxL2Dxp1ra23c3TrWm4lGPVapu4VNyqJrsW66udU9/bVILoDOTxuuM/5S0j5uoPG64z/AJS0j5uoBo2M5PG64z/lLSPm6hcnoucQdY4l8I8PcuvWca3qMZF3GvVWKerRcmieyrq+SZiY5x5/N3AhPp2cE9Mq0HI4o7YwreLm41dM6zYs08qb9uqYpi/FMfhxVMdafLE857YnnSVrpxTw7Go8Mt04GTT1rORo+Xbrj2ps1QyLBLPRZ4U/bX4k0abnTct6Hp9v7K1O5RPKqqjnyptUz5Kq57OfkiKpjthploek6Zoek42kaPg4+BgYtEW7GPYoiii3THkiIVa9DXw7FGxt2ahTT/n72p2rNdXnpotc6Y+W5V8q2QAz13N0uuLX+UWoU6ff0jCw6cm5TYsfYNNfg6IqmIiaqu2Z5d8/qed43PGf8p6T83UA0bGcnjc8Z/ynpPzdQ/3jdL3jHayLdy7maNfopqiardWn0xFcc+2JmJiY5+1INE83Fxs3Eu4ebj2cnGvUTRds3aIrouUzHKaaqZ7JifNLOTpk8HcbhfvbH1HQLVVG29b69eNa5zP2Ldp5de1z/m+miaefbymY7erznRPQM6dU0LT9Sm34KcvGt35o58+r16Yq5c/jQB6IVh2MjgNZyblPO5i6zj3LVXliZouUT/ZVP9gM82qXRk+9/wBkfBFn9TK1ql0ZPvf9kfBFn9QJGVO6Y3R0jX6MviFsPBiNXpibuqabZp/8ZEds3bcR/vfPT+H3x6b1VsQGNExMTMTHKY74fxdjpkdHP7PjM4i7BwP9Ljne1fTLNP8ArvLVftUx+H5aqY9V3x28+tScEi9Gf1/9kfDFj9pqmys6M/r/AOyPhix+01TBR70Sr7r9n+8Mj6SlzfAHC0+vaW1tNv4+n3tJ1i7rmXrU5tuq5j138PEirGovxR6abduJ8L1e+ZrmY7Yjl0nolX3X7P8AeGR9JSrzw/35k7Yws3Rs3TbOtaBnzFWTp969XammuImnwtq7RMVWrnVmaZmOcVUzMVRVHYCxWBa0rTtK2/uHRcLY2oZuq7ixdKwa9o6fl2rV61XVVTmYubF2eXVrt1UdWiqIme2qOyOcVZ3fiYOBuzWMHS7vhsDHz79rFudbrde1Tcqiiefl5xEdrt8fiVou2tOzLHDrauXoWbm25t3NQz9Xqzb1mmY5T4Gmm3bt0VcpmOvNNVURM9WaefNGYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADouGPrk7X+GMT6ahzrouGPrk7X+GMT6agGuyoHol3+wtke+cz9m0t+57euyNpb0tYtrde38HWKMSqqqxTlW+tFuauXWmPd5R8gMiBqj9ong9+bvQP0Y+0Twe/N3oH6MDK5aD0N/14de/o/c/xFhbH7RPB783egfoz3Nm8N9ibN1G7qO1traZpGXeszZuXsa11aqrczFXVmfNzpifiB1bMLpi/fJ7x98WP8PaaeswumL98nvH3xY/w9oHPdHz19di/0gwvpqWrzKHo+evrsX+kGF9NS1eBWLpvcJd+cTNR2te2bo9vUKNPs5NOTNWXas9Sa5tzT/rKo58+rPd5lcfFV44+xKx864v1jSsBmp4qvHH2JWPnXF+sPFV44+xKx864v1jSsBWvoR8H96cMY3NnbyxMfBu6l9j2sfHoyKL1fK34SZqqmiZpiJ68REc+fZPPl2c7KCIOlBxk0vhXsnIox8q1c3Rn2aremYkTE1UTPOPD1x5KKe/t9VMco8swGfHHPKs53Gne2Xj1RXZu6/m1UVR+FHh6+Upc9Dw9fnK+Asj6WyrnXXVcrqrrqqqrqnnVVM85mfPKxnoeHr85XwFkfS2QaFM1OnH98vuX/pYf+FtNK2anTj++X3L/ANLD/wALaBCQADRboA/e92PhTK/XSzpaLdAH73ux8KZX66QTPv8A+4PcHwXk/RVMgmvu/wD7g9wfBeT9FUyCBe/0Nv1tNzfDMfQ0LUqreht+tpub4Zj6GhakGOmu/wC28/3zc/al8T7dd/23n++bn7UviAABr/sT7h9B+Dcf6KlCvogP3vt34Vxv/smrYn3D6D8G4/0VKFfRAfvfbvwrjf8A2BnU1S6Mn3v+yPgiz+pla1S6Mn3v+yPgiz+oH59J/VtS0HgRufWdHzb2FqGHas3se/aq5VW64v2+Ux+7unulz/Rd466ZxZ0D7A1CbOFuzCtROZiRPKm/THZ4a1H82fLT30zPmmJn0+l797fvL3rb+nts0Nsa7q+2dfw9e0LOvYGpYV2Lti/anlNNUf2TExziYnsmJmJ7JBsMpj0yOjn1PsziNsDA9J6a9rGmWKO7y1X7VMeTy1Ux/wA0eVN3Rm436Rxc234K/wCBwdz4VuP5QwYnlFcd3hrXPtmiZ7476ZnlPkmZgBlZ0Z/X/wBkfDFj9pqmrJvTo729F4+7U4kbGxKbem/yzZu6vp1uOUY0zV23rcfzJmfTUx6nvj0vPq2bBR70Sr7r9n+8Mj6SlUhbf0Sr7r9n+8Mj6SlUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB0XDH1ydr/DGJ9NQ510XDH1ydr/AAxifTUA12cvxA4g7N2DZw728NdsaTbzKqqceq7RXV4SaYiaojqxPdzj5XUKgeiXf7C2R75zP2bQJp8Yzgp7P9P/AOze/gPGM4Kez/T/APs3v4GXoDULxjOCns/0/wD7N7+B0WwuKvD7feqXtL2lubF1XMsWJyLlq1buUzTbiqKZq9NTEd9VMfGybWg9Df8AXh17+j9z/EWAX4ZhdMX75PePvix/h7TT1mF0xfvk94++LH+HtA57o+evrsX+kGF9NS1eZQ9Hz19di/0gwvpqWrwK59MbjXvDhLn7asbWs6Vco1O1kV3/ALNsVXJibc24p6vKqnl6uUA+OVxb/FNr/oNz612fol/+2Nj+9839qyp8C6PAfpfZurbtp0bidY0vBwsyaaMbUcS1Vbox7nmuxVVV6Sez00curPf2TM03GoqproiuiqKqao5xMTziYY0LX9D/AKR9W3a8TYG/s6atFqmLWm6leq7cKe6LVyZ/3Xmq/A7p9L6kLccYtL3tq2w87G4fbgp0TX6aevj3a7NFdN3lE87czXE9Tn5K47p5Msd7zuX/ACr1GjeFeoV67RfqozZz66qr0XI7Jiqau3/45cuXY1+pqpqpiqmYqpmOcTE84mEF9KjgFp/FTSKta0Wizh7vxLXKxenlTRm0R3Wbs+f+bV5O6ezuDNxY70PD1+cr4CyPpbKvms6ZqGjarlaVquHews7Eu1Wr9i9TNNduuJ5TEwsH6Hh6/OV8BZH0tkGhSo3SM6MW+eI/F3V94aLrO3MbBzaLFNu3l371N2PB2aLc84ptVR30zy7e5bkBQPxKOJ3si2f+k5P1B4lHE72RbP8A0nJ+oX8AUD8Sjid7Itn/AKTk/ULa9HDhzl8LeFuHtXUNQsZ+bTfu5F+7YpmLcVVz6mnnymYiIjtmI5+aEjkzERMzMREd8yDmOLWo4+k8Ld1allVRTZx9Hyq6u3v5WquUR7czyiPdZHLg9ODjxpetaZc4abMz7ebj1XaatYzrFUVWq+pMVU2KKo7KvTRE1THZ2RETPplPgXi9DW1LHubQ3do8VR9k2M+zk1U8+2aLluaYn5bc/LC2zK3o78UMzhPxGxtxW7VeTp96icbUsWmY53bFUxM9Xn2damYiqPc5c4iZabbH3bt3e23rGvbY1XH1LAvR2V2qu2irl20V099NUeWmeUgpxuToV7wyNfz8jSt26DVg3ciu5YnJpu0XepNUzEVRTTMc+3yS8/xJd/8Asr2x/Wv/AFa+YChniS7/APZXtj+tf+rfpjdCTfNWRbjJ3dty3ZmqPCVW4vVVU0+WYiaIiZ9rnHur3gPl0bBo0zSMLTbVdVdGJj27FNVXfVFFMUxM/Irx6IdqWPicDsTArqjw+drNmm3Rz7eVFFyqqr3I5RH/AJoWA3Jruj7b0XI1nXtSxtN0/Gp613IyLkUUU+1298z3REdsz2QzZ6VfGGri3vu3e0+m7Z29pdNVnTbVyOVVfWmOveqjyTXyp7PJFNPl5gh5ql0ZPvf9kfBFn9TK1ql0ZPvf9kfBFn9QPO6Xv3t+8vetv6e2y+ag9L372/eXvW39PbZfA9bZ+5Na2juTC3Dt7Pu4OpYVzwlm9RPyxMd00zHOJieyYmYlpX0cONOi8Xdr+Fo8Fhbhw6IjUtP63qZ7vC2+fbNuZ+OmeyfJM5fPb2NuvXdlbow9ybczq8LUcSvrUV09sVR5aKo/CpmOyYnvBr6Ix6PXGLQuLm04zsSaMPWsWmmnUtOmrnVZrn8Ony1W6vJPxT2wk4FHvRKvuv2f7wyPpKVSFt/RKvuv2f7wyPpKVSAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH0abmZOnajjahhXZs5WLdovWbkRE9SumYmmeU9nZMQ+cBLvjLccPZ7k/oWN9W5TiLxQ33xDsYdneW4LurW8KqurGiuxat+DmqIiqfSU08+fVjv8zjQAAB0vD3fe7OH+rX9V2hrFzS82/YnHu3aLVu5NVuaqapp5V0zHfTTPxOaAS74y3HD2e5P6FjfVo33buLWd17iy9w7gzqs7U8yqKsjIqoppmuYpimOymIiOymI7I8jygH26DquoaFreFrWk5E42oYN+jIxr0UxVNu5RMVU1cpiYnlMR3xySl4zHHH2eZH6Di/VIgAdbxG4kb14iXsK7vLXLmq14NNdONNVi1b8HFfLreopp58+rHf5nJAAACTds8feL229CxND0fe2ZY0/Dt+Dx7VePZuzbojupiquiauUd0Rz7I5RHZD0vGY44+zzI/QcX6pEADod+703LvvWo1rdWoUahqEW4tTkfY1q1VVTHdFXg6aety7uc855dhsDeu59ha5Vre0tVr0zUKrFViq9TaouTNuqYmaeVdMx30x5PI54BL/AIzHHH2eZH6Di/VHjMccfZ5kfoOL9UiABL/jMccfZ5kfoOL9UeMxxx9nmR+g4v1SIAEv+Mxxx9nmR+g4v1Tm958YeJ28MOvC3DvXVsvEuRyuY9NyLNquPNVRbimmr44cIAAAPX2vubcW1s+c/beuajpGVMcqruHk12qqo809WY5x7U9jyAEqUdInjVRRFMcQNSmIjl227Uz8s0P9eMXxr9n+o/8Aas/wIpASt4xfGv2f6j/2rP8AA/k9IrjVMcv8v9R/7Vn+BFQD3t37y3Zu/JoyN0bj1TWLlHPwf2Xk1XKbfP8Am0zPKn4oh4IAJO23x+4u7c0HC0LRd5XsTTsG1FnGsxh49UW6I7o51W5mfjlGICSt2ceOLO6tvZm39f3fezdMzKYoyLE4mPRFcRVFURzptxMdsR3SjUAAAe3srde4tl6/a17a+rX9L1G1TVRTetcp501RymmqmYmmqJ80xMdkT5EieMxxx9nmR+g4v1SIAHVcReIm8uIeXiZW8dbr1W9h26rePVVZt2+pTVPOY9JTTz7Y8rlQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//9k=" alt="ARDON" style="height:110px;object-fit:contain;margin:0 auto;display:block;">
            </div>
            <p class="text-gray-400 mt-2 font-semibold tracking-widest text-sm uppercase">Work Manager</p>
        </div>
        <div class="bg-gray-900 rounded-2xl p-8 border border-gray-800">
            <form id="loginForm" class="space-y-4" onsubmit="event.preventDefault();doLogin();">
                <div>
                    <label class="block text-gray-400 text-sm mb-2" id="lbl_user">UÅ¾ivatelskÃ© jmÃ©no</label>
                    <input type="text" id="loginUser" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-red-500" placeholder="username">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2" id="lbl_pass">Heslo</label>
                    <input type="password" id="loginPass" onkeypress="if(event.key==='Enter')doLogin()" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-red-500" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div id="loginErr" class="hidden text-red-400 text-sm p-3 bg-red-900/20 rounded-lg border border-red-800"></div>
                <button type="submit" onclick="doLogin()" class="w-full ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold text-lg transition-colors" id="lbl_loginBtn">PÅ™ihlÃ¡sit se</button>
            </form>
        </div>
        <p class="text-center text-gray-600 text-xs mt-4">ARDONÂ® Work Manager v1.0</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden min-h-screen flex">
    <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col fixed h-full z-40 overflow-y-auto">
        <div class="p-5 border-b border-gray-800">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <img src="data:image/png;base64,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" alt="ARDON" style="height:32px;object-fit:contain;">
                </div>
                <div><div class="text-gray-400 text-xs">Work Manager</div></div>
            </div>
        </div>
        <div class="p-4 border-b border-gray-800">
            <div class="bg-gray-800 rounded-xl p-3">
                <p class="text-white font-semibold text-sm" id="sbName">-</p>
                <p class="text-gray-400 text-xs" id="sbRole">-</p>
                <p class="text-gray-500 text-xs" id="sbSection">-</p>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-1">
            <button onclick="showView('dashboard')" id="nav_dashboard" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                <span>ğŸ“Š</span><span class="font-medium">Dashboard</span>
            </button>
            <button onclick="showView('tasks')" id="nav_tasks" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                <span>ğŸ“‹</span><span class="font-medium" id="lbl_tasks">Ãškoly</span>
            </button>
            <div id="sectionNav">
                <p class="text-gray-600 text-xs font-bold uppercase px-4 py-2 mt-3">Ãšseky</p>
                <button onclick="showView('exqc')" id="nav_exqc" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ”</span><span class="font-medium">ExQC</span>
                </button>
                <button onclick="showView('blistrovani')" id="nav_blistrovani" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ’Š</span><span class="font-medium">BlistrovÃ¡nÃ­</span>
                </button>
                <button onclick="showView('potisk')" id="nav_potisk" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ–¨ï¸</span><span class="font-medium">Potisk</span>
                </button>
                
                <button onclick="showView('prijem')" id="nav_prijem" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ“¦</span><span class="font-medium">PÅ™Ã­jem</span>
                </button>
                <button onclick="showView('extra_prace')" id="nav_extra_prace" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ§¹</span><span class="font-medium">Extra prÃ¡ce</span>
                </button>
<button onclick="showView('prace_z_domu')" id="nav_prace_z_domu" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ </span><span class="font-medium">PrÃ¡ce z domu</span>
                </button>
                <button onclick="showView('grafika')" id="nav_grafika" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ¨</span><span class="font-medium">Grafika</span>
                </button>
            </div>
            <div id="adminNav" class="hidden">
                <p class="text-gray-600 text-xs font-bold uppercase px-4 py-2 mt-3">Admin</p>
                <button onclick="showView('users')" id="nav_users" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ‘¥</span><span class="font-medium" id="lbl_users">ZamÄ›stnanci</span>
                </button>
                <button onclick="showView('reports')" id="nav_reports" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ“ˆ</span><span class="font-medium" id="lbl_reports">VÃ½kazy</span>
                </button>
                <button onclick="openWarehouse()" id="nav_warehouse_btn" class="navbtn w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-gray-300 hover:bg-red-900/20 transition-colors">
                    <span>ğŸ“¦</span><span class="font-medium">Sklad materiÃ¡lÅ¯</span>
                </button>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-800">
            <button onclick="doLogout()" class="w-full bg-gray-800 hover:bg-red-900/20 text-gray-300 hover:text-red-400 px-4 py-3 rounded-xl flex items-center space-x-3 transition-colors">
                <span>ğŸšª</span><span id="lbl_logout">OdhlÃ¡sit se</span>
            </button>
        </div>
    </aside>
    <main class="ml-64 flex-1 p-6" id="mainContent"></main>
</div>

<!-- CREATE TASK MODAL -->
<div id="modalCreate" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">VytvoÅ™it Ãºkol</h2>
            <button onclick="closeModal('modalCreate')" class="text-gray-400 hover:text-white text-2xl leading-none">âœ•</button>
        </div>
        <form id="formCreate" onsubmit="submitCreate(event)" class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒÃ­slo Ãºkolu *</label><input type="text" name="task_number" required class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev Ãºkolu *</label><input type="text" name="task_name" required class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-1">Dodavatel *</label>
                    <div class="flex gap-2">
                        <input type="text" name="supplier" id="supplierInput" required list="suppliersList" class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                        <datalist id="suppliersList"></datalist>
                    </div>
                </div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev / Logo / Popis</label><input type="text" name="goods_type" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div id="customerFieldWrap" class="hidden"><label class="block text-gray-400 text-sm mb-1">ZÃ¡kaznÃ­k (Potisk)</label>
                <input type="text" name="customer" list="customersList" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                <datalist id="customersList"></datalist></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒÃ­slo objednÃ¡vky</label><input type="text" name="order_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒÃ­slo avÃ­za</label><input type="text" name="aviso_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Popis prÃ¡ce *</label><textarea name="description" required rows="3" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none resize-none"></textarea></div>
            <div><label class="block text-gray-400 text-sm mb-1">PracovnÃ­ postup</label><textarea name="work_procedure" rows="2" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none resize-none"></textarea></div>
            <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Ãšsek *</label>
                <select name="section" id="createSection" onchange="toggleSectionFields(this.value)" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="exqc">ExQC</option><option value="blistrovani">BlistrovÃ¡nÃ­</option><option value="potisk">Potisk</option><option value="prijem">PÅ™Ã­jem</option><option value="extra_prace">Extra prÃ¡ce</option><option value="prace_z_domu">PrÃ¡ce z domu</option><option value="grafika">Grafika</option>
                </select></div>
                <div><label class="block text-gray-400 text-sm mb-1">Priorita</label>
                <select name="priority" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="0">Bez priority</option><option value="1">ğŸ”´ Priorita 1 - UrgentnÃ­</option><option value="2">ğŸŸ¡ Priorita 2 - StÅ™ednÃ­</option><option value="3">ğŸŸ¢ Priorita 3 - NormÃ¡lnÃ­</option>
                </select></div>
                <div><label class="block text-gray-400 text-sm mb-1">Norma (ks/hod)</label><input type="number" name="norm" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div id="receiptFields" class="hidden p-4 rounded-xl border border-gray-700 bg-gray-900/30 space-y-3">
                <div class="text-sm font-semibold text-gray-200">ğŸ“¦ PÅ™Ã­jem â€“ Ãºdaje</div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Kontejner / zÃ¡silka</label>
                        <select name="container_type" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                            <option value="">â€”</option>
                            <option value="40TH">40TH</option>
                            <option value="20TH">20TH</option>
                            <option value="LCL">LCL</option>
                            <option value="JinÃ©">JinÃ©</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">PoÄet kartonÅ¯</label>
                        <input type="number" min="0" name="cartons" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">PoznÃ¡mka k pÅ™Ã­jmu</label>
                        <input type="text" name="receipt_note" placeholder="napÅ™. mokrÃ© kartonyâ€¦" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    </div>
                </div>
                <div class="text-xs text-gray-400">PoznÃ¡mky mÅ¯Å¾eÅ¡ doplÅˆovat i prÅ¯bÄ›Å¾nÄ› v detailu Ãºkolu (PÅ™Ã­jem).</div>
            </div>

            <div id="extraWorkFields" class="hidden p-4 rounded-xl border border-gray-700 bg-gray-900/30 space-y-3">
                <div class="text-sm font-semibold text-gray-200">ğŸ§¹ Extra prÃ¡ce</div>
                <label class="flex items-center gap-2 text-sm text-gray-200">
                    <input type="checkbox" name="open_ended" value="1" class="accent-red-600">
                    NekoneÄnÃ½ Ãºkol (vhodnÃ© pro mÄ›sÃ­ÄnÃ­ reporty â€“ Ãºklid, inventuraâ€¦)
                </label>
            </div>

            <div><label class="block text-gray-400 text-sm mb-1">PÅ™iÅ™adit zamÄ›stnancÅ¯m (Ctrl+klik = vÃ­ce)</label>
            <select name="assigned_to" id="assignSelect" multiple class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none h-28"></select></div>
            <div>
                <label class="block text-gray-400 text-sm mb-1">ğŸ“¸ Fotografie</label>
                <div class="space-y-2">
                    <input type="text" name="photo_url" placeholder="Odkaz z Teams/SharePoint (https://...)" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-500 text-xs">nebo</span>
                        <input type="file" name="photo_file" accept="image/*" id="photoFileInput" onchange="previewPhoto(this)" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm text-gray-400">
                    </div>
                    <div id="photoPreview" class="hidden"><img id="photoPreviewImg" class="rounded-xl max-h-32 object-cover" src=""><p class="text-gray-500 text-xs mt-1">NÃ¡hled</p></div>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-4" id="billingFormSection">
                <div class="flex items-center gap-2 mb-3">
                    <p class="text-gray-400 text-sm font-semibold">ğŸ’° VyÃºÄtovÃ¡no</p>
                    <span class="text-xs bg-yellow-900/40 text-yellow-400 px-2 py-0.5 rounded-full">pouze admin/vedoucÃ­</span>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">VyÃºÄtovÃ¡no komu</label><input type="text" name="billed_to" placeholder="napÅ™. KomÃ¡rek" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum vyÃºÄtovÃ¡nÃ­</label><input type="date" name="billed_date" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ¡stka (KÄ)</label><input type="number" name="billed_amount" placeholder="0.00" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label><input type="text" name="billed_note" placeholder="poznÃ¡mka..." class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>
            <div class="flex space-x-3 pt-2">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold transition-colors">ğŸ’¾ UloÅ¾it Ãºkol</button>
                <button type="button" onclick="closeModal('modalCreate')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold transition-colors">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>

<!-- TASK DETAIL MODAL -->
<div id="modalDetail" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto border border-gray-700" id="detailContent"></div>
</div>

<!-- ADD USER MODAL -->
<div id="modalUser" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-lg border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">PÅ™idat uÅ¾ivatele</h2>
            <button onclick="closeModal('modalUser')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formUser" onsubmit="submitUser(event)" class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">CelÃ© jmÃ©no *</label><input type="text" name="full_name" required class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">UÅ¾ivatelskÃ© jmÃ©no *</label><input type="text" name="username" required class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Heslo *</label><input type="text" name="password" required class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">Sazba (KÄ/hod)</label><input type="number" name="hourly_rate" value="180" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Role *</label>
                <select name="role" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="employee">ZamÄ›stnanec</option><option value="manager">VedoucÃ­</option><option value="superAdmin">Super Admin</option>
                </select></div>
                <div><label class="block text-gray-400 text-sm mb-1">Ãšseky * (Ctrl+klik = vÃ­ce)</label>
                <select name="section" multiple id="userSectionSelect" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none h-32">
                    <option value="all">ğŸŒ VÅ¡echny Ãºseky</option>
                    <option value="exqc">ğŸ” ExQC</option>
                    <option value="blistrovani">ğŸ’Š BlistrovÃ¡nÃ­</option>
                    <option value="potisk">ğŸ–¨ï¸ Potisk</option>
                    <option value="prace_z_domu">ğŸ  PrÃ¡ce z domu</option>
                    <option value="grafika">ğŸ¨ Grafika</option>
                </select></div>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Email (pro notifikace)</label><input type="email" name="email" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            <div class="flex space-x-3 pt-2">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold transition-colors">ğŸ’¾ UloÅ¾it</button>
                <button type="button" onclick="closeModal('modalUser')" class="flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>

<script>
const SURL = 'https://ludbbygsijdbzvtwgmwt.supabase.co';
const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1ZGJieWdzaWpkYnp2dHdnbXd0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MDg0NzAyNywiZXhwIjoyMDg2NDIzMDI3fQ.nZcjArKKvBnVDe7Zzm5avkeXnIRCFNbtt8E20jPpfZ0';
let db = null;
try{
  if(window.supabase && typeof window.supabase.createClient === 'function'){
    db = window.supabase.createClient(SURL, SKEY);
  }
}catch(e){ db = null; }


let CU = null, USERS = [], TASKS = [], VIEW = 'dashboard', TIMERS = {}, LANG = 'cs', PHASES = {};
function normSection(s){
  return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
}
function getPhase(tid, task){
  if(task && normSection(task.section)==='prijem') return PHASES[tid]||'vykladka';
  return 'general';
}
function setPhase(tid, phase){
  const t=TASKS.find(x=>x.id===tid);
  if(TIMERS[tid]){ notify('Nejprve dej pauzu/stop, pak mÅ¯Å¾eÅ¡ zmÄ›nit fÃ¡zi.'); return; }
  PHASES[tid]=phase;
  try{ localStorage.setItem('awm_phase_'+tid+'_'+(CU?.id||''), phase); }catch(e){}
  openDetail(tid);
}
function restorePhasePref(tid){
  try{
    const p=localStorage.getItem('awm_phase_'+tid+'_'+(CU?.id||''));
    if(p) PHASES[tid]=p;
  }catch(e){}
}


// ---------- Helpers for cost & exports ----------
function getUserById(uid){
    return USERS.find(u=>Number(u.id)===Number(uid)) || null;
}
function userHourlyRate(uid){
    const u=getUserById(uid)||{};
    const r=Number(u.hourly_rate||u.hourlyRate||u.rate||0);
    return r>0 ? r : 180; // default
}
function laborCostEntries(entries){
    try{
        return (entries||[]).reduce((sum,en)=> sum + ((en.duration||0)/3600)*userHourlyRate(en.userId), 0);
    }catch(e){ return 0; }
}
function fmtKc(n){
    const x=Number(n||0);
    return x.toLocaleString('cs-CZ',{maximumFractionDigits:0})+' KÄ';
}
function sanitizeFilename(s){
    return (s||'report').toString().replace(/[^a-z0-9\-_]+/gi,'_').slice(0,80);
}

// Export current Reports view to Excel (XLSX)
function exportReportsExcel(){
    const cont=document.getElementById('reportsContainer');
    if(!cont){ toast('Nelze exportovat: report nenÃ­ zobrazen.'); return; }
    const wb=XLSX.utils.book_new();

    // PÅ™ehled (filtry + KPI)
    const info = [];
    info.push(['Export', new Date().toLocaleString('cs-CZ')]);
    info.push(['ReÅ¾im', window.currentReportMode||'']);
    info.push(['Ãšseky', (window.currentReportFilter||['all']).join(', ')]);
    info.push(['ZamÄ›stnanec', window.currentReportEmpFilter||'all']);
    if(window.currentReportMode==='monthly') info.push(['MÄ›sÃ­c', window.currentReportMonth||'']);
    const wsInfo=XLSX.utils.aoa_to_sheet(info);
    XLSX.utils.book_append_sheet(wb, wsInfo, 'PÅ™ehled');

    // KaÅ¾dÃ¡ tabulka v reportu -> samostatnÃ½ sheet
    const tables=[...cont.querySelectorAll('table')];
    if(tables.length===0){
        // fallback: aspoÅˆ textovÃ½ export
        const txt=cont.innerText.split('\n').filter(Boolean).map(x=>[x]);
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(txt), 'Report');
    } else {
        tables.forEach((t,i)=>{
            const ws=XLSX.utils.table_to_sheet(t);
            const name = (t.getAttribute('data-sheet') || ('Tabulka_'+(i+1))).slice(0,31);
            XLSX.utils.book_append_sheet(wb, ws, name);
        });
    }

    XLSX.writeFile(wb, sanitizeFilename('vykazy_'+(window.currentReportMode||'')+'_'+new Date().toISOString().slice(0,10))+'.xlsx');
}

// Export current Reports view to PDF (prints, includes images)
function exportReportsPDF(){
    const cont=document.getElementById('reportsContainer');
    if(!cont){ toast('Nelze exportovat: report nenÃ­ zobrazen.'); return; }

    const w=window.open('','_blank');
    const css = `
      <style>
        body{font-family:Arial, sans-serif; padding:20px;}
        h1{margin:0 0 10px 0;}
        .meta{color:#555; font-size:12px; margin-bottom:12px;}
        table{width:100%; border-collapse:collapse; margin:10px 0;}
        th,td{border:1px solid #ccc; padding:6px 8px; font-size:12px; vertical-align:top;}
        th{background:#f2f2f2;}
        img{max-width:100%; height:auto; border-radius:8px;}
        .card{border:1px solid #ddd; border-radius:10px; padding:10px; margin:10px 0; page-break-inside:avoid;}
      </style>
    `;
    const meta = `
      <h1>ARDONÂ® Work Manager â€“ VÃ½kazy</h1>
      <div class="meta">
        Export: ${new Date().toLocaleString('cs-CZ')}<br>
        ReÅ¾im: ${(window.currentReportMode||'')}<br>
        Ãšseky: ${(window.currentReportFilter||['all']).join(', ')}<br>
        ZamÄ›stnanec: ${(window.currentReportEmpFilter||'all')}<br>
        ${(window.currentReportMode==='monthly')?('MÄ›sÃ­c: '+(window.currentReportMonth||'')):''}
      </div>
    `;
    w.document.write(`<!doctype html><html><head><meta charset="utf-8">${css}</head><body>${meta}${cont.innerHTML}</body></html>`);
    w.document.close();
    setTimeout(()=>w.print(),500);
}

function _sessKey(tid,uid){ return `awm_active_${tid}_${uid}`; }
function _saveActiveSession(tid, prevTotal, phase){
    try{ localStorage.setItem(_sessKey(tid,CU.id), JSON.stringify({startedAt: Date.now(), prevTotal: prevTotal||0, phase: phase||'general'})); }catch(e){}
}
function _clearActiveSession(tid, uid){
    try{ localStorage.removeItem(_sessKey(tid,uid)); }catch(e){}
}
function _getActiveSession(tid, uid){
    try{ return JSON.parse(localStorage.getItem(_sessKey(tid,uid))||'null'); }catch(e){ return null; }
}
function restoreActiveTimers(){
    if(!CU) return;
    TASKS.forEach(t=>{
        const aw=t.active_workers?JSON.parse(t.active_workers):[];
        if(!aw.includes(CU.id)) return;
        const entries=t.time_entries?JSON.parse(t.time_entries):[];
        const prevTotal=entries.reduce((s,e)=>s+(e.duration||0),0);
        restorePhasePref(t.id);
        const sess=_getActiveSession(t.id,CU.id);
        if(sess && typeof sess.startedAt==='number'){
            // st is derived so that elapsed = prevTotal(at session start) + running duration
            const base = (typeof sess.prevTotal==='number') ? sess.prevTotal : prevTotal;
            const st = sess.startedAt - (base*1000);
            TIMERS[t.id]={st,iv:null,phase:(sess.phase||getPhase(t.id,t))};
        } else {
            // Fallback: if DB says I'm active worker but local session missing, start counting from now
            _saveActiveSession(t.id, prevTotal);
            const st = Date.now() - (prevTotal*1000);
            TIMERS[t.id]={st,iv:null,phase:(sess.phase||getPhase(t.id,t))};
        }
        startTmr(t.id, prevTotal, true);
    });
}


const TXT = {
  cs: { loginBtn:'PÅ™ihlÃ¡sit se', logout:'OdhlÃ¡sit se', invalidLogin:'NesprÃ¡vnÃ© pÅ™ihlaÅ¡ovacÃ­ Ãºdaje', tasks:'Ãškoly', users:'ZamÄ›stnanci', reports:'VÃ½kazy', superAdmin:'Super Admin', manager:'VedoucÃ­', employee:'ZamÄ›stnanec', pending:'ÄŒekÃ¡', inProgress:'ProbÃ­hÃ¡', completed:'DokonÄeno', start:'Start', pause:'Pauza', stop:'Stop', complete:'Hotovo' },
  uk: { loginBtn:'Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸', logout:'Ğ’Ğ¸Ğ¹Ñ‚Ğ¸', invalidLogin:'ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ– Ğ´Ğ°Ğ½Ñ–', tasks:'Ğ—Ğ°Ğ²Ğ´Ğ°Ğ½Ğ½Ñ', users:'Ğ¡Ğ¿Ñ–Ğ²Ñ€Ğ¾Ğ±Ñ–Ñ‚Ğ½Ğ¸ĞºĞ¸', reports:'Ğ—Ğ²Ñ–Ñ‚Ğ¸', superAdmin:'Ğ¡ÑƒĞ¿ĞµÑ€ ĞĞ´Ğ¼Ñ–Ğ½', manager:'ĞšĞµÑ€Ñ–Ğ²Ğ½Ğ¸Ğº', employee:'Ğ¡Ğ¿Ñ–Ğ²Ñ€Ğ¾Ğ±Ñ–Ñ‚Ğ½Ğ¸Ğº', pending:'ĞÑ‡Ñ–ĞºÑƒÑ”', inProgress:'Ğ’Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ñ‚ÑŒÑÑ', completed:'Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', start:'Ğ¡Ñ‚Ğ°Ñ€Ñ‚', pause:'ĞŸĞ°ÑƒĞ·Ğ°', stop:'Ğ¡Ñ‚Ğ¾Ğ¿', complete:'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾' },
  en: { loginBtn:'Log In', logout:'Logout', invalidLogin:'Invalid credentials', tasks:'Tasks', users:'Employees', reports:'Reports', superAdmin:'Super Admin', manager:'Manager', employee:'Employee', pending:'Pending', inProgress:'In Progress', completed:'Completed', start:'Start', pause:'Pause', stop:'Stop', complete:'Complete' }
};
function tx(k){ return TXT[LANG][k]||k; }

function setLang(l){ LANG=l; document.getElementById('lbl_loginBtn').textContent=tx('loginBtn'); }

function sn(s){ return {exqc:'ExQC',blistrovani:'BlistrovÃ¡nÃ­',potisk:'Potisk',prace_z_domu:'PrÃ¡ce z domu',all:'VÅ¡echny'}[s]||s; }

function getSections(sectionStr){
    if(!sectionStr)return 'VÅ¡echny';
    if(sectionStr==='all')return '<span class="px-2 py-0.5 rounded text-xs bg-gray-700 text-gray-300">ğŸŒ VÅ¡echny</span>';
    return sectionStr.split(',').map(s=>`<span class="px-2 py-0.5 rounded text-xs bg-gray-800 text-gray-300 mr-1">${sn(s)}</span>`).join('');
}

function fmt(s){ const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=Math.floor(s%60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

async function doLogin(){
    const u=document.getElementById('loginUser').value.trim();
    const p=document.getElementById('loginPass').value.trim();
    const err=document.getElementById('loginErr');
    if(!u||!p){err.textContent='VyplÅˆte pÅ™ihlaÅ¡ovacÃ­ Ãºdaje';err.classList.remove('hidden');return;}
    // If Supabase client is unavailable (e.g., CDN blocked), fall back to demo/local only
    const hasDb = !!db;
// First try Supabase
    if(hasDb){
    try{
        const res = await db.from('users').select('*').eq('username',u).eq('password',p).limit(1);
        console.log('Supabase response:', res);
        if(res.data && res.data.length>0){
            CU=res.data[0];
            err.classList.add('hidden');
            await loadData();
        restoreActiveTimers();
        showApp();
            return;
        } else if(res.error){
            console.log('Supabase error:', res.error);
        }
    }catch(e){
        console.log('Supabase exception:', e);
    }
    }

    // Fallback: try loading all users and match locally
    if(hasDb){
    try{
        const res2 = await db.from('users').select('*');
        console.log('All users:', res2);
        if(res2.data && res2.data.length>0){
            USERS = res2.data;
            const user = res2.data.find(x=>x.username===u && x.password===p);
            if(user){
                CU=user;
                err.classList.add('hidden');
                await loadData();
        restoreActiveTimers();
        showApp();
                return;
            }
        }
    }catch(e2){
        console.log('Fallback error:', e2);
    }
    }

    // Last resort: hardcoded demo users
    const DEMO = [
        {id:1,username:'admin',password:'admin123',full_name:'Admin ARDON',role:'superAdmin',section:'all',hourly_rate:300,email:'nemcova@ardon.cz'},
        {id:2,username:'admin2',password:'admin123',full_name:'Admin 2',role:'superAdmin',section:'all',hourly_rate:300,email:'nemcova@ardon.cz'},
        {id:3,username:'vedouci_exqc',password:'heslo123',full_name:'VedoucÃ­ ExQC',role:'manager',section:'exqc',hourly_rate:250,email:''},
        {id:4,username:'vedouci_blistr',password:'heslo123',full_name:'VedoucÃ­ BlistrovÃ¡nÃ­',role:'manager',section:'blistrovani',hourly_rate:250,email:''},
        {id:5,username:'vedouci_potisk',password:'heslo123',full_name:'VedoucÃ­ Potisk',role:'manager',section:'potisk',hourly_rate:250,email:''},
        {id:6,username:'zamestnanec1',password:'heslo123',full_name:'Jan NovÃ¡k',role:'employee',section:'exqc',hourly_rate:180,email:''},
        {id:7,username:'zamestnanec2',password:'heslo123',full_name:'ĞŸĞµÑ‚Ñ€Ğ¾ ĞšĞ¾Ğ²Ğ°Ğ»ÑŒ',role:'employee',section:'exqc',hourly_rate:180,email:''},
        {id:8,username:'zamestnanec3',password:'heslo123',full_name:'John Smith',role:'employee',section:'blistrovani',hourly_rate:180,email:''},
    ];
    const demoUser = DEMO.find(x=>x.username===u && x.password===p);
    if(demoUser){
        CU=demoUser;
        USERS=DEMO;
        err.classList.add('hidden');
        await loadData();
        restoreActiveTimers();
        showApp();
        return;
    }
    
    err.textContent=tx('invalidLogin');
    err.classList.remove('hidden');
}

function doLogout(){CU=null;sessionStorage.removeItem('cu');Object.values(TIMERS).forEach(t=>clearInterval(t.iv));TIMERS={};document.getElementById('loginScreen').classList.remove('hidden');document.getElementById('mainApp').classList.add('hidden');document.getElementById('loginUser').value='';document.getElementById('loginPass').value='';}

async function loadData(){
    try{
        const {data:u}=await db.from('users').select('*').order('full_name');
        if(u)USERS=u;
        const {data:t}=await db.from('tasks').select('*').order('created_at',{ascending:false});
        if(t)TASKS=t;
    }catch(e){USERS=JSON.parse(localStorage.getItem('au')||'[]');TASKS=JSON.parse(localStorage.getItem('at')||'[]');}
}

function saveLoc(){localStorage.setItem('au',JSON.stringify(USERS));localStorage.setItem('at',JSON.stringify(TASKS));}

// Auto-restore session on page load
window.addEventListener('DOMContentLoaded', async () => {
    const saved = sessionStorage.getItem('cu');
    if(saved){
        try{
            CU = JSON.parse(saved);
            await loadData();
        restoreActiveTimers();
        showApp();
        } catch(e){
            sessionStorage.removeItem('cu');
        }
    }
});

function showApp(){
    // Save logged-in user to sessionStorage so refresh doesn't log out
    sessionStorage.setItem('cu', JSON.stringify(CU));
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('sbName').textContent=CU.full_name;
    document.getElementById('sbRole').textContent=tx(CU.role);
    document.getElementById('sbSection').textContent=(CU.section||'all').split(',').map(s=>sn(s)).join(', ');
    if(CU.role==='superAdmin'){
        // Admin sees ALL - users, reports, warehouse
        document.getElementById('adminNav').classList.remove('hidden');
        const nuBtn = document.getElementById('nav_users');
        if(nuBtn) nuBtn.classList.remove('hidden');
        const nwBtn = document.getElementById('nav_warehouse_btn');
        if(nwBtn) nwBtn.classList.remove('hidden');
    } else if(CU.role==='manager'){
        // Manager sees users (own employees) + reports - NOT warehouse
        document.getElementById('adminNav').classList.remove('hidden');
        const nuBtn = document.getElementById('nav_users');
        if(nuBtn) nuBtn.classList.remove('hidden');
        const nwBtn = document.getElementById('nav_warehouse_btn');
        if(nwBtn) nwBtn.classList.add('hidden');
    } else {
        // Employee - hide everything
        document.getElementById('adminNav').classList.add('hidden');
    }
    // Show/hide section nav based on role
    const sNav = document.getElementById('sectionNav');
    if(CU.role === 'superAdmin') {
        // Admin sees ALL sections
        if(sNav) sNav.classList.remove('hidden');
    } else if(CU.role === 'employee') {
        // Employee sees NO sections
        if(sNav) sNav.classList.add('hidden');
    } else if(CU.role === 'manager') {
        // Manager sees only their assigned section(s)
        if(sNav) sNav.classList.remove('hidden');
        const userSecs = (CU.section||'all').split(',');
        if(!userSecs.includes('all') && sNav) {
            const allSecBtns = sNav.querySelectorAll('button[id^="nav_"]');
            allSecBtns.forEach(btn => {
                const sec = btn.id.replace('nav_','');
                if(!userSecs.includes(sec)) btn.classList.add('hidden');
            });
        }
    }
    showView('dashboard');
    loadWarehouse();loadSuppliers();loadCustomers();loadLogos();
    db.channel('tc').on('postgres_changes',{event:'*',schema:'public',table:'tasks'},async()=>{await loadData();showView(VIEW);}).subscribe();
}


let SECTION_SUB_MODE = {}; // {section: 'active'|'completed'}

function showSectionSub(section, mode){
    SECTION_SUB_MODE[section]=mode;
    showView(section);
    // After view renders list, apply filter
    setTimeout(()=>{
        if(mode==='completed') filterT('completed', section);
        else filterT('all', section);
    }, 0);
}

function updateSubnavVisibility(){
    ['exqc','blistrovani','potisk','prace_z_domu','grafika'].forEach(sec=>{
        const el=document.getElementById('subnav_'+sec);
        if(!el) return;
        el.classList.toggle('hidden', VIEW!==sec);
    });
}

function showView(v){
    VIEW=v;
    // Block employees from admin views
    if(CU.role==='employee' && ['users','reports','grafika','exqc','blistrovani','potisk','prace_z_domu'].includes(v)){
        v='tasks'; VIEW='tasks';
    }
    // Block manager from other sections
    if(CU.role==='manager'){
        const manSecs=(CU.section||'all').split(',');
        if(!manSecs.includes('all') && ['exqc','blistrovani','potisk','prace_z_domu','grafika'].includes(v) && !manSecs.includes(v)){
            v='tasks'; VIEW='tasks';
        }
    }
    document.querySelectorAll('.navbtn').forEach(b=>{b.classList.remove('bg-red-600','text-white');b.classList.add('text-gray-300');});
    const nb=document.getElementById('nav_'+v);
    if(nb){nb.classList.add('bg-red-600','text-white');nb.classList.remove('text-gray-300');}
    updateSubnavVisibility();
    const mc=document.getElementById('mainContent');
    if(v==='dashboard')mc.innerHTML=renderDash();
    else if(v==='users')mc.innerHTML=renderUsers();
    else if(v==='reports'){currentReportFilter=['all'];currentReportEmpFilter='all';mc.innerHTML=renderReports(currentReportFilter,'all');}
    else if(v==='grafika')mc.innerHTML=renderTasks('grafika');
    else mc.innerHTML=renderTasks(v==='tasks'?null:v);
    // Apply sidebar sub-mode (Ãškoly/Hotovo) for section views
    if(['exqc','blistrovani','potisk','prace_z_domu','grafika'].includes(v)){
        const mode=SECTION_SUB_MODE[v]||'active';
        setTimeout(()=>{
            if(mode==='completed') filterT('completed', v);
            else filterT('all', v);
        },0);
    }
}

function visibleTasks(sec){
    let t=[...TASKS];
    if(CU.role!=='superAdmin'){
        const userSecs=(CU.section||'all').split(',');
        const hasAll=userSecs.includes('all');
        if(CU.role==='manager'){
            t=t.filter(x=>hasAll||userSecs.includes(x.section)||x.created_by===CU.id);
        } else {
            // Employee: see assigned tasks + unassigned tasks from their section.
            // Completed tasks are visible ONLY if the employee was assigned or actually worked on them.
            t=t.filter(x=>{
                const a=x.assigned_to?JSON.parse(x.assigned_to):[];
                const isUnassigned = !a || a.length===0;
                const isAssigned = a.includes(CU.id);
                const inMySection = hasAll || userSecs.includes(x.section);

                const hasWorked = (() => {
                    try{
                        const te = x.time_entries ? JSON.parse(x.time_entries) : [];
                        if(te.some(e => e && e.userId === CU.id)) return true;
                    }catch(e){}
                    try{
                        const pe = x.production_entries ? JSON.parse(x.production_entries) : [];
                        if(pe.some(e => e && e.userId === CU.id)) return true;
                    }catch(e){}
                    return false;
                })();

                if(x.status==='completed'){
                    return isAssigned || hasWorked;
                }
                // Show if: directly assigned to me, OR unassigned and in my section
                return isAssigned || (isUnassigned && inMySection);
            });
        }
    }
    if(sec)t=t.filter(x=>x.section===sec);
    t.sort((a,b)=>{if(a.priority&&b.priority)return a.priority-b.priority;if(a.priority)return -1;if(b.priority)return 1;return new Date(b.created_at)-new Date(a.created_at);});
    return t;
}

function taskRowHTML(task){
    const pc={1:'border-l-4 border-red-600 bg-red-950/20',2:'border-l-4 border-yellow-500 bg-yellow-950/10',3:'border-l-4 border-green-500 bg-green-950/10',0:''};
    const sc={pending:'text-yellow-400 bg-yellow-900/30',inProgress:'text-blue-400 bg-blue-900/30',awaitingApproval:'text-purple-300 bg-purple-900/30',completed:'text-green-400 bg-green-900/30'};
    const sl={pending:'â³ '+tx('pending'),inProgress:'â–¶ï¸ '+tx('inProgress'),awaitingApproval:'ğŸŸ£ Hotovo â€“ ÄekÃ¡ na potvrzenÃ­',completed:'âœ… '+tx('completed')};
    const pl={1:'ğŸ”´ P1',2:'ğŸŸ¡ P2',3:'ğŸŸ¢ P3'};
    return `<div class="bg-gray-900 rounded-xl p-4 border border-gray-800 ${pc[task.priority||0]} cursor-pointer hover:bg-gray-800 transition-colors" onclick="openDetail(${task.id})">
        <div class="flex items-center justify-between">
            <div class="flex-1 min-w-0">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 bg-gray-800 rounded-xl px-4 py-3 text-center min-w-[60px] border border-gray-700">
                        <p class="text-gray-500 text-xs">ÄŒ.</p>
                        <p class="text-white font-black text-2xl leading-none">${task.task_number}</p>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center flex-wrap gap-2 mb-1">
                            <h3 class="font-bold text-white text-base">${task.task_name}</h3>
                            ${task.priority?`<span class="text-xs font-bold px-2 py-0.5 rounded-full bg-gray-800">${pl[task.priority]}</span>`:''}
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${sc[task.status]||'text-gray-400 bg-gray-800'}">${sl[task.status]||task.status}</span>
                            ${(()=>{
                                const secColors={exqc:'bg-blue-900/40 text-blue-300',blistrovani:'bg-purple-900/40 text-purple-300',potisk:'bg-green-900/40 text-green-300',prace_z_domu:'bg-orange-900/40 text-orange-300',grafika:'bg-pink-900/40 text-pink-300'};
                                const sc=secColors[task.section]||'bg-gray-800 text-gray-400';
                                return `<span class="text-xs px-2 py-0.5 rounded-full font-semibold ${sc}">${sn(task.section)}</span>`;
                            })()}
                            ${(()=>{const a=task.assigned_to?JSON.parse(task.assigned_to):[];return a.length===0?'<span class="text-xs px-2 py-0.5 rounded-full bg-yellow-900/40 text-yellow-400 font-bold">ğŸ‘¥ Pro vÅ¡echny</span>':'';})()} 
                        </div>
                        <p class="text-gray-500 text-sm">${task.supplier}${task.goods_type?' Â· '+task.goods_type:''}${task.order_number?' Â· Obj: '+task.order_number:''} Â· ğŸ• ${new Date(task.created_at).toLocaleString('cs-CZ')}</p>
                    </div>
                </div>
            </div>
            <span class="text-gray-600 ml-3">â€º</span>
        </div>
    </div>`;
}

function renderDash(){
    const t=visibleTasks(null);
    const inp=t.filter(x=>x.status==='inProgress').length;
    const comp=t.filter(x=>x.status==='completed').length;
    const awaitA=t.filter(x=>x.status==='awaitingApproval').length;
    const urg=t.filter(x=>x.priority===1 && x.status!=='completed');
    const now=new Date();
    const userName=(CU.full_name||CU.username||'');
    const extraTile = (CU.role==='employee')
        ? `<div class="bg-gray-900 rounded-2xl p-5 border border-purple-900/30">
              <p class="text-purple-300 text-sm">ÄŒekÃ¡ na potvrzenÃ­</p>
              <p class="text-4xl font-black text-purple-300 mt-1">${awaitA}</p>
           </div>`
        : '';

    return `<div class="space-y-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-black">Dashboard</h1>
                <p class="text-gray-400 mt-1">VÃ­tejte, ${userName}</p>
            </div>
            <div class="text-right">
                <p class="text-gray-400 text-sm">${now.toLocaleDateString('cs-CZ',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p>
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-900 rounded-2xl p-5 border border-gray-800"><p class="text-gray-400 text-sm">Celkem ÃºkolÅ¯</p><p class="text-4xl font-black mt-1">${t.length}</p></div>
            <div class="bg-gray-900 rounded-2xl p-5 border border-yellow-900/30"><p class="text-yellow-400 text-sm">ProbÃ­hÃ¡</p><p class="text-4xl font-black text-yellow-400 mt-1">${inp}</p></div>
            <div class="bg-gray-900 rounded-2xl p-5 border border-green-900/30"><p class="text-green-400 text-sm">DokonÄeno</p><p class="text-4xl font-black text-green-400 mt-1">${comp}</p></div>
            ${CU.role==='employee' ? extraTile : `<div class="bg-gray-900 rounded-2xl p-5 border border-red-900/30"><p class="text-red-400 text-sm">ğŸ”´ UrgentnÃ­</p><p class="text-4xl font-black text-red-400 mt-1">${urg.length}</p></div>`}
        </div>
        ${CU.role!=='employee' && urg.length?`<div class="bg-red-950/30 border border-red-800 rounded-2xl p-4"><h3 class="text-red-400 font-bold mb-3">ğŸ”´ UrgentnÃ­ Ãºkoly!</h3><div class="space-y-2">${urg.map(x=>taskRowHTML(x)).join('')}</div></div>`:''}
        <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800"><h3 class="font-bold text-lg mb-4">NedÃ¡vnÃ© Ãºkoly</h3><div class="space-y-2">${t.slice(0,8).map(x=>taskRowHTML(x)).join('')||'<p class="text-gray-500 text-center py-8">Å½Ã¡dnÃ© Ãºkoly</p>'}</div></div>
    </div>`;
}


function renderTasks(sec){
    const t=visibleTasks(sec);
    const title=sec?sn(sec):'VÅ¡echny Ãºkoly';
    const canC=CU.role==='superAdmin'||CU.role==='manager';
    return `<div class="space-y-4">
        <div class="flex items-center justify-between">
            <div><h1 class="text-3xl font-black">${title}</h1><p class="text-gray-400">${t.length} ÃºkolÅ¯</p></div>
            ${canC?`<div class="flex gap-2">
                <button onclick="openCreate('${sec||''}')" class="ardon-red hover:bg-red-700 text-white px-5 py-2.5 rounded-xl font-bold transition-colors shadow-lg">+ NovÃ½ Ãºkol</button>
                <button onclick="openManualTask('${sec||''}')" class="bg-gray-700 hover:bg-gray-600 text-white px-5 py-2.5 rounded-xl font-bold transition-colors" title="Zadat archivnÃ­ Ãºkol s ruÄnÃ­mi Äasy">ğŸ“‹ HistorickÃ½</button>
            </div>`:''}
        </div>
        <div class="flex flex-wrap gap-2">
            <button onclick="filterT('all','${sec||''}')" class="px-4 py-2 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700 text-sm">VÅ¡e</button>
            <button onclick="filterT('pending','${sec||''}')" class="px-4 py-2 rounded-lg bg-yellow-900/30 text-yellow-400 text-sm">â³ ÄŒekÃ¡</button>
            <button onclick="filterT('inProgress','${sec||''}')" class="px-4 py-2 rounded-lg bg-blue-900/30 text-blue-400 text-sm">â–¶ï¸ ProbÃ­hÃ¡</button>
            <button onclick="filterT('awaitingApproval','${sec||''}')" class="px-4 py-2 rounded-lg bg-purple-900/30 text-purple-300 text-sm">ğŸŸ£ Ke schvÃ¡lenÃ­</button>
            <button onclick="filterT('completed','${sec||''}')" class="px-4 py-2 rounded-lg bg-green-900/30 text-green-400 text-sm">âœ… DokonÄeno</button>
            <button onclick="filterT('priority','${sec||''}')" class="px-4 py-2 rounded-lg bg-red-900/30 text-red-400 text-sm">ğŸ”´ UrgentnÃ­</button>
        </div>
        <div id="tlist" class="space-y-3">${t.map(x=>taskRowHTML(x)).join('')||'<div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800"><p class="text-gray-500">Å½Ã¡dnÃ© Ãºkoly</p></div>'}</div>
    </div>`;
}

function filterT(status,sec){
    let t=visibleTasks(sec||null);
    if(status==='priority')t=t.filter(x=>x.priority==1&&x.status!=='completed'&&x.status!=='awaitingApproval');
    else if(status!=='all')t=t.filter(x=>x.status===status);
    else t=t.filter(x=>x.status!=='completed');
    const el=document.getElementById('tlist');
    if(el)el.innerHTML=t.map(x=>taskRowHTML(x)).join('')||'<p class="text-gray-500 text-center py-8">Å½Ã¡dnÃ© Ãºkoly</p>';
}

async function openDetail(tid){
    const task=TASKS.find(x=>x.id===tid);
    if(!task)return;
    const creator=USERS.find(u=>u.id===task.created_by);
    const aIds=task.assigned_to?JSON.parse(task.assigned_to):[];
    const aNames=aIds.map(id=>USERS.find(u=>u.id===id)?.full_name||id).join(', ');
    const mats=task.materials?JSON.parse(task.materials):[];
    const entries=task.time_entries?JSON.parse(task.time_entries):[];
    const totalSec=entries.reduce((s,e)=>s+(e.duration||0),0);
    const dispPhase = (normSection(task.section)==='prijem') ? getPhase(task.id, task) : 'general';
    const dispSec = (normSection(task.section)==='prijem')
        ? entries.filter(e=>(e.phase||'general')===dispPhase).reduce((s,e)=>s+(e.duration||0),0)
        : totalSec;
    const hrs=totalSec/3600;
    const labor=hrs*(CU.hourly_rate||180);
    const matC=mats.reduce((s,m)=>s+(m.qty*m.price),0);
    const pieces=task.completed_pieces||0;
    const avg=pieces>0?(labor+matC)/pieces:0;
    const normP=task.norm&&hrs>0?(pieces/(task.norm*hrs)*100).toFixed(1):null;
    const isW=task.active_workers?JSON.parse(task.active_workers).includes(CU.id):false;
    const isEmp=CU.role==='employee';
    const canE=CU.role==='superAdmin'||CU.role==='manager';
    const pl={1:'ğŸ”´ Priorita 1 - UrgentnÃ­',2:'ğŸŸ¡ Priorita 2 - StÅ™ednÃ­',3:'ğŸŸ¢ Priorita 3 - NormÃ¡lnÃ­'};
    const pBg={1:'bg-red-900/40 text-red-400',2:'bg-yellow-900/40 text-yellow-400',3:'bg-green-900/40 text-green-400'};

    document.getElementById('detailContent').innerHTML=`
        <div class="flex justify-between items-start p-6 border-b border-gray-800">
            <div><div class="flex items-center gap-3 flex-wrap">
                <h2 class="text-2xl font-black">${task.task_name}</h2>
                ${task.priority?`<span class="px-3 py-1 rounded-full text-sm font-bold ${pBg[task.priority]}">${pl[task.priority]}</span>`:''}
            </div>
            <p class="text-gray-400 mt-1">#${task.task_number} Â· ${task.supplier} Â· ${sn(task.section)}</p></div>
            <button onclick="closeModal('modalDetail')" class="text-gray-400 hover:text-white text-2xl leading-none ml-4">âœ•</button>
        </div>
        <div class="p-6 space-y-5">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                ${task.goods_type?`<div class="bg-gray-800 rounded-xl p-3"><p class="text-gray-500 text-xs">NÃ¡zev / Logo / Popis</p><p class="font-semibold">${task.goods_type}</p></div>`:''}
                ${task.order_number?`<div class="bg-gray-800 rounded-xl p-3"><p class="text-gray-500 text-xs">ÄŒ. objednÃ¡vky</p><p class="font-semibold">${task.order_number}</p></div>`:''}
                ${task.aviso_number?`<div class="bg-gray-800 rounded-xl p-3"><p class="text-gray-500 text-xs">ÄŒ. avÃ­za</p><p class="font-semibold">${task.aviso_number}</p></div>`:''}
                <div class="bg-gray-800 rounded-xl p-3"><p class="text-gray-500 text-xs">Zadal/a Â· kdy</p><p class="font-semibold">${creator?.full_name||'-'}</p><p class="text-gray-500 text-xs">${new Date(task.created_at).toLocaleString('cs-CZ')}</p></div>
                <div class="bg-gray-800 rounded-xl p-3"><p class="text-gray-500 text-xs">PÅ™iÅ™azeno</p><p class="font-semibold text-sm">${aNames||'-'}</p></div>
                ${task.norm?`<div class="bg-gray-800 rounded-xl p-3"><p class="text-gray-500 text-xs">Norma</p><p class="font-semibold">${task.norm} ks/hod</p></div>`:''}
            </div>
            ${task.description?`<div class="bg-gray-800 rounded-xl p-4"><p class="text-gray-500 text-xs mb-1">Popis prÃ¡ce</p><p>${task.description}</p></div>`:''}
            ${task.work_procedure?`<div class="bg-gray-800 rounded-xl p-4"><p class="text-gray-500 text-xs mb-1">PracovnÃ­ postup</p><p>${task.work_procedure}</p></div>`:''}
            ${task.photo_url?`
            <div>
                <p class="text-gray-500 text-xs mb-2">ğŸ“¸ Fotografie</p>
                <img src="${task.photo_url}" class="rounded-xl max-h-64 object-cover w-full cursor-pointer" onclick="window.open('${task.photo_url}','_blank')" onerror="this.parentElement.innerHTML='<p class=\'text-gray-500 text-sm\'>Foto nelze naÄÃ­st - <a href=\'${task.photo_url}\' target=\'_blank\' class=\'text-blue-400\'>otevÅ™Ã­t odkaz</a></p>'">
                <p class="text-gray-500 text-xs mt-1">Klikni pro zobrazenÃ­ v plnÃ© velikosti</p>
            </div>`:''}

            ${canE?(()=>{
                const b=task.billing?JSON.parse(task.billing):{};
                if(!b.billed_to&&!b.billed_date&&!b.billed_amount)return '';
                return `<div class="bg-green-900/20 border border-green-800 rounded-xl p-4">
                    <p class="text-green-400 font-bold mb-3">ğŸ’° VyÃºÄtovÃ¡no</p>
                    <div class="grid grid-cols-2 gap-3">
                        ${b.billed_to?`<div><p class="text-gray-500 text-xs">Komu</p><p class="text-white font-semibold">${b.billed_to}</p></div>`:''}
                        ${b.billed_date?`<div><p class="text-gray-500 text-xs">Datum</p><p class="text-white font-semibold">${new Date(b.billed_date).toLocaleDateString('cs-CZ')}</p></div>`:''}
                        ${b.billed_amount?`<div><p class="text-gray-500 text-xs">ÄŒÃ¡stka</p><p class="text-green-400 font-bold text-lg">${b.billed_amount.toFixed(2)} KÄ</p></div>`:''}
                        ${b.billed_note?`<div><p class="text-gray-500 text-xs">PoznÃ¡mka</p><p class="text-white">${b.billed_note}</p></div>`:''}
                    </div>
                </div>`;
            })():''}

            ${(isEmp||isW)?`
            <div class="bg-gray-800 rounded-2xl p-5">
                <h3 class="font-bold text-lg mb-4">â±ï¸ ÄŒasomÃ­ra</h3>
                ${ (normSection(task.section)==='prijem') ? (()=>{
                    const ph=getPhase(task.id, task);
                    const eAll=entries;
                    const a=eAll.filter(e=>(e.phase||'general')==='vykladka').reduce((s,e)=>s+(e.duration||0),0);
                    const b=eAll.filter(e=>(e.phase||'general')==='trideni').reduce((s,e)=>s+(e.duration||0),0);
                    const aTxt=fmt(a), bTxt=fmt(b);
                    return `
                    <div class="flex items-center justify-between gap-3 mb-4 flex-wrap">
                        <div class="flex gap-2">
                            <button onclick="setPhase(${task.id},'vykladka')" class="px-3 py-2 rounded-xl font-bold ${ph==='vykladka'?'bg-blue-600 text-white':'bg-gray-700 text-gray-200 hover:bg-gray-600'}">ğŸ“¦ VyklÃ¡dka</button>
                            <button onclick="setPhase(${task.id},'trideni')" class="px-3 py-2 rounded-xl font-bold ${ph==='trideni'?'bg-blue-600 text-white':'bg-gray-700 text-gray-200 hover:bg-gray-600'}">ğŸ§º TÅ™Ã­dÄ›nÃ­</button>
                        </div>
                        <div class="text-xs text-gray-400">
                            <span class="mr-3">VyklÃ¡dka: <b class="text-white">${aTxt}</b></span>
                            <span>TÅ™Ã­dÄ›nÃ­: <b class="text-white">${bTxt}</b></span>
                        </div>
                    </div>`;
                })() : '' }

                <div class="text-center mb-5">
                    <div id="tmr_${task.id}" class="text-6xl font-black ${isW?'ardon-red-text timer-active':''}">${fmt(dispSec)}</div>
                    <p class="text-gray-400 mt-1 text-sm">${canE?'CelkovÃ½ Äas vÅ¡ech':'TvÅ¯j Äas dnes'}</p>
                </div>
                <div class="flex justify-center gap-3 flex-wrap">
                    ${task.status==='completed'
                        ? `<span class="px-4 py-2 rounded-xl bg-green-900/30 text-green-300 font-bold">âœ… DokonÄeno</span>`
                        : task.status==='awaitingApproval'
                            ? (canE
                                ? `<button onclick="approveW(${task.id})" class="bg-green-700 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold">âœ… Potvrdit dokonÄenÃ­</button>
                                   <button onclick="returnW(${task.id})" class="bg-yellow-700 hover:bg-yellow-600 text-white px-6 py-3 rounded-xl font-bold">â†© VrÃ¡tit zpÄ›t</button>`
                                : `<span class="px-4 py-2 rounded-xl bg-purple-900/30 text-purple-200 font-bold">ğŸŸ£ Hotovo â€“ ÄekÃ¡ na potvrzenÃ­ vedoucÃ­ho</span>`)
                            : (!isW
                                ? `<button onclick="startW(${task.id})" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold">â–¶ ${tx('start')}</button>`
                                : `<button onclick="pauseW(${task.id})" class="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-3 rounded-xl font-bold">â¸ ${tx('pause')}</button>
                                   <button onclick="stopW(${task.id})" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-xl font-bold">â¹ ${tx('stop')}</button>
                                   <button onclick="completeW(${task.id})" class="ardon-red hover:bg-red-700 text-white px-6 py-3 rounded-xl font-bold">âœ… ${isEmp?'Odeslat ke schvÃ¡lenÃ­':tx('complete')}</button>`)
                    }
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div><label class="block text-gray-400 text-sm mb-1">PoÄet kusÅ¯</label><input type="number" id="pcs_${task.id}" value="${pieces}" onchange="updPcs(${task.id},this.value)" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                    <div><label class="block text-gray-400 text-sm mb-1">ÄŒas pÅ™evozu (min)</label><input type="number" id="trp_${task.id}" value="${task.transport_time||0}" onchange="updTrp(${task.id},this.value)" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                </div>
            </div>`:''}

            
            <div class="bg-gray-800 rounded-2xl p-5 mt-3">
                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h3 class="font-bold text-lg">ğŸ“¦ DennÃ­ kusy (vÃ½roba)</h3>
                    <p class="text-gray-400 text-sm">${canE?'vidÃ­Å¡ vÅ¡echny zÃ¡znamy':'vidÃ­Å¡ jen svoje zÃ¡znamy'}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Datum</label>
                        <input type="date" id="prod_date_${task.id}" value="${new Date().toISOString().slice(0,10)}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-1">Hotovo (ks)</label>
                        <input type="number" min="0" id="prod_pcs_${task.id}" placeholder="napÅ™. 120" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addProd(${task.id})" class="w-full bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-bold">â• PÅ™idat zÃ¡znam</button>
                    </div>
                </div>
                <div class="mt-4">
                    ${(()=>{
                        const prod = task.production_entries ? JSON.parse(task.production_entries) : [];
                        const rows = prod
                          .filter(e=>e && e.ts)
                          .filter(e=>canE || e.userId===CU.id)
                          .sort((a,b)=>new Date(b.ts)-new Date(a.ts));
                        if(!rows.length) return `<p class="text-gray-500 text-sm">ZatÃ­m Å¾Ã¡dnÃ© dennÃ­ kusy. DoporuÄenÃ­: zapisuj po smÄ›nÄ› (1Ã— dennÄ›).</p>`;
                        return `<div class="space-y-2">
                            ${rows.slice(0,40).map(e=>{
                                const u=USERS.find(x=>x.id===e.userId);
                                const d=new Date(e.ts);
                                return `<div class="bg-gray-900 rounded-xl p-3 border border-gray-700 flex items-center justify-between gap-3">
                                    <div>
                                        <p class="font-semibold">${u?.full_name||e.userId} <span class="text-gray-500 font-normal">Â· ${d.toLocaleDateString('cs-CZ')}</span></p>
                                        ${e.note?`<p class="text-gray-400 text-sm">${e.note}</p>`:''}
                                    </div>
                                    <div class="text-right">
                                        <p class="text-xl font-black">${e.pieces||0} ks</p>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>`;
                    })()}
                </div>
            </div>

<div class="bg-gray-800 rounded-2xl p-5 mt-3 ${canE?'':'hidden'}">
                <h3 class="font-bold text-lg mb-3">ğŸ§¾ PracovnÃ­ zÃ¡znamy</h3>
                ${(()=>{
                    const all=entries.slice().filter(x=>x && x.ts).sort((a,b)=>new Date(a.ts)-new Date(b.ts));
                    const vis = (CU.role==='employee') ? all.filter(e=>e.userId===CU.id) : all;
                    if(vis.length===0) return `<p class="text-gray-500 text-sm">ZatÃ­m bez zÃ¡znamu.</p>`;
                    return `<div class="overflow-x-auto"><table class="w-full text-sm">
                        <thead class="bg-gray-700"><tr>
                            <th class="text-left p-2 text-gray-300">ZamÄ›stnanec</th>
                            <th class="text-left p-2 text-gray-300">ZaÄÃ¡tek</th>
                            <th class="text-left p-2 text-gray-300">Konec</th>
                            <th class="text-left p-2 text-gray-300">DÃ©lka</th>
                            <th class="text-left p-2 text-gray-300">PoznÃ¡mka</th>
                        </tr></thead><tbody>
                        ${vis.map(e=>{
                            const u=USERS.find(x=>x.id===e.userId);
                            const end=new Date(e.ts);
                            const start=new Date(end.getTime()-(e.duration||0)*1000);
                            return `<tr class="border-t border-gray-700">
                                <td class="p-2 text-white font-medium">${u?.full_name||('ID:'+e.userId)}</td>
                                <td class="p-2 text-gray-300">${start.toLocaleString('cs-CZ')}</td>
                                <td class="p-2 text-gray-300">${end.toLocaleString('cs-CZ')}</td>
                                <td class="p-2 font-mono text-white">${fmt(e.duration||0)}</td>
                                <td class="p-2 text-gray-400">${e.note||''}</td>
                            </tr>`;
                        }).join('')}
                        </tbody></table></div>`;
                })()}
            </div>


            <div class="bg-gray-800 rounded-2xl p-5">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg">ğŸ“¦ MateriÃ¡ly</h3>
                    <div class="flex gap-2 flex-wrap">
                        ${task.section==='potisk'?`<button onclick="openSelectLogo(${task.id})" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">ğŸ–¨ï¸ Logo</button>`:`<button onclick="openSelectMat(${task.id})" class="ardon-red hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold">ğŸ“¦ Ze skladu</button>`}
                        <button onclick="addMatManual(${task.id})" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold">âœï¸ RuÄnÄ›</button>
                    </div>
                </div>
                <div id="mlist_${task.id}">${mats.length?mats.map(m=>`<div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg mb-2"><span>${m.name}</span><span class="text-gray-400">${m.qty} ks Ã— ${m.price} KÄ = <strong class="text-white">${(m.qty*m.price).toFixed(2)} KÄ</strong></span></div>`).join(''):'<p class="text-gray-500 text-sm text-center py-2">Å½Ã¡dnÃ© materiÃ¡ly</p>'}</div>
            </div>

            <div class="bg-gray-800 rounded-2xl p-5">
                <h3 class="font-bold text-lg mb-4">ğŸ“Š VÃ½kaz</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div class="bg-gray-700 p-4 rounded-xl"><p class="text-gray-400 text-xs">StrÃ¡venÃ½ Äas</p><p class="text-xl font-black">${fmt(totalSec)}</p></div>
                    <div class="bg-gray-700 p-4 rounded-xl"><p class="text-gray-400 text-xs">NÃ¡klady prÃ¡ce</p><p class="text-xl font-black">${labor.toFixed(2)} KÄ</p></div>
                    <div class="bg-gray-700 p-4 rounded-xl"><p class="text-gray-400 text-xs">NÃ¡klady materiÃ¡lu</p><p class="text-xl font-black">${matC.toFixed(2)} KÄ</p></div>
                    <div class="bg-gray-700 p-4 rounded-xl"><p class="text-gray-400 text-xs">CelkovÃ© nÃ¡klady</p><p class="text-xl font-black ardon-red-text">${(labor+matC).toFixed(2)} KÄ</p></div>
                    <div class="bg-gray-700 p-4 rounded-xl"><p class="text-gray-400 text-xs">PrÅ¯mÄ›r/kus</p><p class="text-xl font-black">${avg.toFixed(2)} KÄ</p></div>
                    ${normP?`<div class="bg-gray-700 p-4 rounded-xl"><p class="text-gray-400 text-xs">PlnÄ›nÃ­ normy</p><p class="text-xl font-black ${parseFloat(normP)>=100?'text-green-400':'text-yellow-400'}">${normP}%</p></div>`:''}
                </div>
                ${canE&&(task.hidden_extra_time||task.hidden_extra_cost)?`
                <div class="mt-3 p-4 bg-gray-900 rounded-xl border border-gray-700">
                    <p class="text-gray-500 text-xs font-semibold mb-2">ğŸ”’ SkrytÃ© nÃ¡klady (jen admin)</p>
                    <div class="grid grid-cols-3 gap-3">
                        ${task.hidden_extra_time?`<div class="bg-gray-800 p-3 rounded-lg"><p class="text-gray-500 text-xs">Extra Äas</p><p class="text-white font-bold">${task.hidden_extra_time} min</p></div>`:''}
                        ${task.hidden_extra_cost?`<div class="bg-gray-800 p-3 rounded-lg"><p class="text-gray-500 text-xs">Extra nÃ¡klady</p><p class="text-white font-bold">${task.hidden_extra_cost} KÄ</p></div>`:''}
                        <div class="bg-gray-800 p-3 rounded-lg"><p class="text-gray-500 text-xs">Celkem skrytÃ©</p><p class="text-red-400 font-bold">${(((task.hidden_extra_time||0)/60*(CU.hourly_rate||180))+(task.hidden_extra_cost||0)).toFixed(2)} KÄ</p></div>
                    </div>
                    ${task.hidden_extra_note?`<p class="text-gray-500 text-xs mt-2">${task.hidden_extra_note}</p>`:''}
                </div>`:''}
            </div>

            ${canE?`
            <div class="bg-gray-800 rounded-2xl p-5">
                <h3 class="font-bold text-lg mb-4">ğŸ’° VyÃºÄtovÃ¡nÃ­</h3>
                ${(()=>{const b=task.billing?JSON.parse(task.billing):{};return `
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="block text-gray-400 text-xs mb-1">VyÃºÄtovÃ¡no komu</label><input type="text" id="bt_${task.id}" value="${b.billed_to||''}" placeholder="jmÃ©no" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-400 text-xs mb-1">Datum</label><input type="date" id="bd_${task.id}" value="${b.billed_date||''}" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-400 text-xs mb-1">ÄŒÃ¡stka (KÄ)</label><input type="number" id="ba_${task.id}" value="${b.billed_amount||''}" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-400 text-xs mb-1">PoznÃ¡mka</label><input type="text" id="bn_${task.id}" value="${b.billed_note||''}" placeholder="poznÃ¡mka" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button onclick="saveBilling(${task.id})" class="ardon-red hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">ğŸ’¾ UloÅ¾it vyÃºÄtovÃ¡nÃ­</button>
                `;})()} 
            </div>
            <div class="bg-gray-800 rounded-2xl p-5">
                <h3 class="font-bold text-lg mb-4">âš™ï¸ Admin Ãºpravy</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block text-gray-400 text-sm mb-1">PÅ™idat Äas navÃ­c (min)</label>
                    <div class="flex gap-2"><input type="number" id="ext_${task.id}" placeholder="minuty" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"><button onclick="addExt(${task.id})" class="ardon-red text-white px-4 py-2 rounded-lg font-bold">+</button></div></div>
                    <div><label class="block text-gray-400 text-sm mb-1">ZmÄ›nit stav</label>
                    <select onchange="updStatus(${task.id},this.value)" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none">
                        <option value="pending" ${task.status==='pending'?'selected':''}>â³ ÄŒekÃ¡</option>
                        <option value="inProgress" ${task.status==='inProgress'?'selected':''}>â–¶ï¸ ProbÃ­hÃ¡</option>
                        <option value="completed" ${task.status==='completed'?'selected':''}>âœ… DokonÄeno</option>
                    </select></div>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <p class="text-gray-400 text-sm font-semibold mb-3">ğŸ”’ SkrytÃ© nÃ¡klady (vidÃ­ jen admin)</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-gray-500 text-xs mb-1">Extra Äas (min)</label>
                        <div class="flex gap-2"><input type="number" id="hext_${task.id}" value="${task.hidden_extra_time||0}" placeholder="min" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><button onclick="saveHiddenCosts(${task.id})" class="ardon-red text-white px-3 py-2 rounded-lg text-sm font-bold">ğŸ’¾</button></div></div>
                        <div><label class="block text-gray-500 text-xs mb-1">Extra nÃ¡klady (KÄ)</label>
                        <input type="number" id="hexc_${task.id}" value="${task.hidden_extra_cost||0}" placeholder="KÄ" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    </div>
                    <div class="mt-2"><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka ke skrytÃ½m nÃ¡kladÅ¯m</label>
                    <input type="text" id="hexn_${task.id}" value="${task.hidden_extra_note||''}" placeholder="popis skrytÃ½ch nÃ¡kladÅ¯..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    ${task.hidden_extra_time||task.hidden_extra_cost?`<div class="mt-2 p-3 bg-gray-900 rounded-lg"><p class="text-gray-500 text-xs">SkrytÃ© nÃ¡klady celkem: <span class="text-white font-bold">${(((task.hidden_extra_time||0)/60*(CU.hourly_rate||180))+(task.hidden_extra_cost||0)).toFixed(2)} KÄ</span></p></div>`:''}
                </div>
            </div>`:''}

            ${canE?`
            <button onclick="openEditTask(${task.id})" class="w-full bg-blue-700 hover:bg-blue-600 text-white py-3 rounded-xl font-bold transition-colors mb-3">
                âœï¸ Upravit Ãºkol / zmÄ›nit pÅ™iÅ™azenÃ­
            </button>`:''}
            <div class="flex gap-3">
                <button onclick="expXls(${task.id})" class="flex-1 bg-green-700 hover:bg-green-600 text-white py-3 rounded-xl font-bold">ğŸ“¥ Excel</button>
                <button onclick="expPDF(${task.id})" class="flex-1 bg-red-800 hover:bg-red-700 text-white py-3 rounded-xl font-bold">ğŸ“„ PDF</button>
            </div>
        </div>`;
    document.getElementById('modalDetail').classList.remove('hidden');
    if(isW)startTmr(task.id,totalSec,true);
}

function startTmr(tid,init,keepRunning){
    // init = seconds already recorded in time_entries
    // If timer already exists and keepRunning=true, only (re)bind UI + interval, do not reset start time.
    if(TIMERS[tid] && keepRunning){
        const st = TIMERS[tid].st;
        const phase = TIMERS[tid].phase;
        if(TIMERS[tid].iv) clearInterval(TIMERS[tid].iv);
        const tick=()=>{
            const el=document.getElementById('tmr_'+tid);
            if(el) el.textContent=fmt(Math.floor((Date.now()-st)/1000));
        };
        tick();
        TIMERS[tid].iv=setInterval(tick,1000);
        return;
    }
    if(TIMERS[tid] && TIMERS[tid].iv) clearInterval(TIMERS[tid].iv);
    const st=Date.now()-(init*1000);
    const tick=()=>{
        const el=document.getElementById('tmr_'+tid);
        if(el) el.textContent=fmt(Math.floor((Date.now()-st)/1000));
    };
    tick();
    TIMERS[tid]={st,iv:setInterval(tick,1000),phase:(TIMERS[tid]?.phase||'general')};
}

async function startW(tid){
    const task=TASKS.find(t=>t.id===tid);if(!task)return;
    const aw=task.active_workers?JSON.parse(task.active_workers):[];
    if(!aw.includes(CU.id))aw.push(CU.id);

    const entries=task.time_entries?JSON.parse(task.time_entries):[];
    const phase = getPhase(tid, task);
    const prevTotal = (normSection(task.section)==='prijem')
        ? entries.filter(e=>(e.phase||'general')===phase).reduce((s,e)=>s+(e.duration||0),0)
        : entries.reduce((s,e)=>s+(e.duration||0),0);

    // Persist running session locally so timer survives view switch / tab sleep
    _saveActiveSession(tid, prevTotal, phase);

    await updDB(tid,{active_workers:JSON.stringify(aw),status:'inProgress'});
    // Store phase into TIMERS so pause can write it
    startTmr(tid,prevTotal,false);
    if(TIMERS[tid]) TIMERS[tid].phase = phase;
    openDetail(tid);
}


function _pDate(ts){
    try{
        const d=new Date(ts);
        const y=d.getFullYear();
        const m=String(d.getMonth()+1).padStart(2,'0');
        const da=String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${da}`;
    }catch(e){return '';}
}

async function addProd(tid){
    const task=TASKS.find(t=>t.id===tid); if(!task) return;
    const dateEl=document.getElementById(`prod_date_${tid}`);
    const pcsEl=document.getElementById(`prod_pcs_${tid}`);
    if(!pcsEl) return;
    const pcs=parseInt(pcsEl.value||'0',10);
    if(!Number.isFinite(pcs) || pcs<=0){
        notify('Zadej poÄet kusÅ¯ (>0).');
        return;
    }
    const dStr = dateEl?.value || new Date().toISOString().slice(0,10);
    // store ts as end-of-day-ish timestamp for consistency
    const ts = new Date(dStr + 'T12:00:00').toISOString();
    const prev = task.production_entries ? JSON.parse(task.production_entries) : [];
    prev.push({userId: CU.id, pieces: pcs, ts});
    await updDB(tid,{production_entries: JSON.stringify(prev)});
    notify('âœ… DennÃ­ kusy uloÅ¾eny.');
    openDetail(tid);
}


async function pauseW(tid){
    if(!TIMERS[tid])return;
    const elapsed=Math.floor((Date.now()-TIMERS[tid].st)/1000); // total seconds (including already recorded)
    const task=TASKS.find(t=>t.id===tid);
    const prev=task?.time_entries?JSON.parse(task.time_entries):[];
    const phase = (TIMERS[tid]?.phase) || getPhase(tid, task);
    const prevT = (task && normSection(task.section)==='prijem')
        ? prev.filter(e=>(e.phase||'general')===phase).reduce((s,e)=>s+(e.duration||0),0)
        : prev.reduce((s,e)=>s+(e.duration||0),0);

    // Stop UI timer
    if(TIMERS[tid].iv) clearInterval(TIMERS[tid].iv);
    delete TIMERS[tid];

    // Segment = what was done since last start
    const seg=Math.max(0, elapsed-prevT);
    const ne={userId:CU.id,duration:seg,ts:new Date().toISOString(), phase};

    // Remove me from active workers and clear local session
    const aw=task?.active_workers?JSON.parse(task.active_workers).filter(id=>id!==CU.id):[];
    _clearActiveSession(tid, CU.id);

    await updDB(tid,{time_entries:JSON.stringify([...prev,ne]),active_workers:JSON.stringify(aw)});
    openDetail(tid);
}

async function stopW(tid){await pauseW(tid);}

async function completeW(tid){
    // Always store current segment first
    await pauseW(tid);

    const task = TASKS.find(t=>t.id===tid);
    const isEmp = CU.role==='employee';

    if(isEmp){
        // Require daily pieces entry before sending to approval (so we can build real daily reports)
        const today = new Date().toISOString().slice(0,10);
        let pcs = null;
        while(true){
            const ans = prompt('Kolik kusÅ¯ je dnes hotovo? (povinnÃ© pro odeslÃ¡nÃ­ ke schvÃ¡lenÃ­)', '');
            if(ans === null){
                notify('OdeslÃ¡nÃ­ ke schvÃ¡lenÃ­ zruÅ¡eno.');
                return;
            }
            const n = parseInt((ans||'').trim(),10);
            if(Number.isFinite(n) && n>=0){
                pcs = n;
                break;
            }
            alert('Zadej celÃ© ÄÃ­slo (0 nebo vÃ­ce).');
        }
        const note = prompt('PoznÃ¡mka (volitelnÃ©)', '') || '';
        const ts = new Date(today + 'T12:00:00').toISOString();

        const prev = task?.production_entries ? JSON.parse(task.production_entries) : [];
        prev.push({userId: CU.id, pieces: pcs, ts, note});

        await updDB(tid,{
            production_entries: JSON.stringify(prev),
            status:'awaitingApproval',
            completed_at:new Date().toISOString()
        });
        notify('ğŸŸ£ Ãškol odeslÃ¡n ke schvÃ¡lenÃ­ vedoucÃ­mu (dennÃ­ kusy uloÅ¾eny).');
    } else {
        await updDB(tid,{status:'completed',completed_at:new Date().toISOString()});
        notify('âœ… Ãškol dokonÄen!');
    }
    openDetail(tid);
}


async function approveW(tid){
    const task=TASKS.find(t=>t.id===tid); if(!task) return;
    await updDB(tid,{status:'completed'});
    notify('âœ… DokonÄenÃ­ potvrzeno.');
    openDetail(tid);
}
async function returnW(tid){
    const task=TASKS.find(t=>t.id===tid); if(!task) return;
    await updDB(tid,{status:'inProgress',completed_at:null});
    notify('â†© Ãškol vrÃ¡cen zpÄ›t do prÃ¡ce.');
    openDetail(tid);
}
async function updPcs(tid,v){await updDB(tid,{completed_pieces:parseInt(v)||0});}
async function updTrp(tid,v){await updDB(tid,{transport_time:parseInt(v)||0});}
async function updStatus(tid,v){await updDB(tid,{status:v});showView(VIEW);}

async function addExt(tid){
    const m=parseInt(document.getElementById('ext_'+tid)?.value)||0;if(!m)return;
    const task=TASKS.find(t=>t.id===tid);
    const e=task?.time_entries?JSON.parse(task.time_entries):[];
    e.push({userId:CU.id,duration:m*60,ts:new Date().toISOString(),note:'Admin'});
    await updDB(tid,{time_entries:JSON.stringify(e)});openDetail(tid);
}

async function addMatManual(tid){
    const n=prompt('NÃ¡zev materiÃ¡lu:');if(!n)return;
    const q=parseFloat(prompt('MnoÅ¾stvÃ­:')||'0');
    const p=parseFloat(prompt('Cena za kus (KÄ):')||'0');
    const task=TASKS.find(t=>t.id===tid);
    const m=task?.materials?JSON.parse(task.materials):[];
    m.push({name:n,qty:q,price:p});
    await updDB(tid,{materials:JSON.stringify(m)});openDetail(tid);
}

let currentMatTaskId=null;
let selectedWarehouseItem=null;

function openSelectMat(tid){
    currentMatTaskId=tid;
    selectedWarehouseItem=null;
    document.getElementById('matQtySection').classList.add('hidden');
    document.getElementById('matSearchInput').value='';
    renderMatSelectList(WAREHOUSE);
    document.getElementById('modalSelectMat').classList.remove('hidden');
}

function filterWarehouse(){
    const q=document.getElementById('matSearchInput').value.toLowerCase();
    const filtered=WAREHOUSE.filter(w=>w.name.toLowerCase().includes(q)||w.category?.toLowerCase().includes(q));
    renderMatSelectList(filtered);
}

function renderMatSelectList(items){
    const el=document.getElementById('matSelectList');
    if(!items||items.length===0){el.innerHTML='<p class="text-gray-500 text-center py-4">Å½Ã¡dnÃ© materiÃ¡ly ve skladu</p>';return;}
    el.innerHTML=items.map(w=>`
        <div onclick="selectWarehouseItem(${w.id})" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-xl cursor-pointer transition-colors border border-gray-700 hover:border-red-600">
            <div class="flex justify-between items-center">
                <div><p class="text-white font-semibold">${w.name}</p>${w.category?`<p class="text-gray-500 text-xs">${w.category}</p>`:''}</div>
                <div class="text-right"><p class="text-white font-bold">${w.price} KÄ</p><p class="text-gray-500 text-xs">/${w.unit||'ks'}</p></div>
            </div>
        </div>
    `).join('');
}

function selectWarehouseItem(wid){
    selectedWarehouseItem=WAREHOUSE.find(w=>w.id===wid);
    if(!selectedWarehouseItem)return;
    document.getElementById('matSelectedName').textContent=selectedWarehouseItem.name+' ('+selectedWarehouseItem.price+' KÄ/'+selectedWarehouseItem.unit+')';
    document.getElementById('matQtyInput').value=1;
    document.getElementById('matPriceInput').value=selectedWarehouseItem.price;
    document.getElementById('matQtySection').classList.remove('hidden');
}

async function confirmSelectMat(){
    if(!selectedWarehouseItem||!currentMatTaskId)return;
    const qty=parseFloat(document.getElementById('matQtyInput').value)||1;
    const price=parseFloat(document.getElementById('matPriceInput').value)||selectedWarehouseItem.price;
    const task=TASKS.find(t=>t.id===currentMatTaskId);
    const m=task?.materials?JSON.parse(task.materials):[];
    m.push({name:selectedWarehouseItem.name,qty:qty,price:price,unit:selectedWarehouseItem.unit||'ks'});
    await updDB(currentMatTaskId,{materials:JSON.stringify(m)});
    closeModal('modalSelectMat');
    openDetail(currentMatTaskId);
    notify('ğŸ“¦ MateriÃ¡l pÅ™idÃ¡n!');
}

async function updDB(tid,upd){
    try{await db.from('tasks').update(upd).eq('id',tid);}catch(e){}
    const i=TASKS.findIndex(t=>t.id===tid);
    if(i!==-1)TASKS[i]={...TASKS[i],...upd};
    saveLoc();
}

function openCreate(sec){
    document.getElementById('formCreate').reset();
    if(sec)document.getElementById('createSection').value=sec;
    const as=document.getElementById('assignSelect');
    as.innerHTML=USERS.filter(u=>u.role==='employee').map(u=>`<option value="${u.id}">${u.full_name} (${sn(u.section)})</option>`).join('');
    // Show billing section only for admin/manager
    const billingSection=document.getElementById('billingFormSection');
    if(billingSection){
        if(CU.role==='superAdmin'||CU.role==='manager') billingSection.classList.remove('hidden');
        else billingSection.classList.add('hidden');
    }
    document.getElementById('modalCreate').classList.remove('hidden');
}

async function submitCreate(ev){
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const at=Array.from(ev.target.assigned_to.selectedOptions).map(o=>parseInt(o.value));
    
    // Handle photo - file upload or URL
    let photoUrl = fd.get('photo_url') || '';
    const photoFile = document.getElementById('photoFileInput')?.files[0];
    if(photoFile && !photoUrl){
        photoUrl = await fileToBase64(photoFile);
    }
    
    // Billing info
    const billing = {
        billed_to: fd.get('billed_to')||'',
        billed_date: fd.get('billed_date')||'',
        billed_amount: parseFloat(fd.get('billed_amount'))||0,
        billed_note: fd.get('billed_note')||''
    };
    
    const nt={task_number:fd.get('task_number'),task_name:fd.get('task_name'),supplier:fd.get('supplier'),goods_type:fd.get('goods_type'),order_number:fd.get('order_number'),aviso_number:fd.get('aviso_number'),description:fd.get('description'),work_procedure:fd.get('work_procedure'),section:fd.get('section'),container_type:fd.get('container_type')||'',cartons:fd.get('cartons')?parseInt(fd.get('cartons')):null,receipt_note:fd.get('receipt_note')||'',open_ended:fd.get('open_ended')?true:false,priority:parseInt(fd.get('priority'))||0,norm:fd.get('norm')?parseFloat(fd.get('norm')):null,assigned_to:JSON.stringify(at),photo_url:photoUrl,billing:JSON.stringify(billing),created_by:CU.id,status:'pending',time_entries:'[]',materials:'[]',active_workers:'[]',completed_pieces:0,created_at:new Date().toISOString()};
    try{const{data,error}=await db.from('tasks').insert([nt]).select();if(data&&data[0])TASKS.unshift(data[0]);else throw error;}
    catch(e){nt.id=Date.now();TASKS.unshift(nt);saveLoc();}
    closeModal('modalCreate');showView(VIEW);notify('âœ… Ãškol byl vytvoÅ™en!');
}

function fileToBase64(file){
    return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>resolve(e.target.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
    });
}

function previewPhoto(input){
    if(input.files&&input.files[0]){
        const reader=new FileReader();
        reader.onload=e=>{
            document.getElementById('photoPreviewImg').src=e.target.result;
            document.getElementById('photoPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function renderUsers(){
    const isAdmin = CU.role==='superAdmin';
    const isManager = CU.role==='manager';

    // Filter visible users by role
    let visibleUsers;
    if(isAdmin){
        visibleUsers = USERS;
    } else if(isManager){
        const manSecs = (CU.section||'all').split(',');
        const hasAll = manSecs.includes('all');
        visibleUsers = USERS.filter(u=>{
            if(u.role!=='employee') return false;
            if(hasAll) return true;
            const uSecs = (u.section||'').split(',');
            return uSecs.some(s=>manSecs.includes(s));
        });
    } else {
        visibleUsers = [];
    }

    // MANAGER VIEW - employees with work report
    if(isManager){
        const empCards = visibleUsers.map(u=>{
            const empTasks = TASKS.filter(t=>{
                const a = t.assigned_to?JSON.parse(t.assigned_to):[];
                return a.includes(u.id);
            });
            const done = empTasks.filter(t=>t.status==='completed').length;
            const inProg = empTasks.filter(t=>t.status==='inProgress').length;
            let totalSecs=0;
            empTasks.forEach(t=>{
                const entries=t.time_entries?JSON.parse(t.time_entries):[];
                entries.filter(e=>e.userId===u.id).forEach(e=>totalSecs+=(e.duration||0));
            });
            const totalCost=(totalSecs/3600)*(u.hourly_rate||180);

            const taskRows = empTasks.map(t=>{
                const entries=t.time_entries?JSON.parse(t.time_entries):[];
                const myEntries=entries.filter(e=>e.userId===u.id);
                const mySecs=myEntries.reduce((s,e)=>s+(e.duration||0),0);
                const mats=t.materials?JSON.parse(t.materials):[];
                const matC=mats.reduce((s,m)=>s+(m.qty*m.price),0);
                const statusColor=t.status==='completed'?'text-green-400':t.status==='inProgress'?'text-blue-400':'text-yellow-400';
                const statusLabel=t.status==='completed'?'âœ… Hotovo':t.status==='inProgress'?'â–¶ï¸ ProbÃ­hÃ¡':'â³ ÄŒekÃ¡';
                return `<div class="bg-gray-800 rounded-xl p-3 cursor-pointer hover:bg-gray-700 transition-colors" onclick="openDetail(${t.id})">
                    <div class="flex justify-between items-start gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="bg-gray-700 text-white font-black px-2 py-0.5 rounded text-sm">#${t.task_number}</span>
                                <span class="font-semibold text-white">${t.task_name}</span>
                                <span class="text-xs font-bold ${statusColor}">${statusLabel}</span>
                            </div>
                            <p class="text-gray-500 text-xs mt-1">${t.supplier}${t.goods_type?' Â· '+t.goods_type:''}</p>
                            <div class="mt-1 space-y-0.5">
                                ${myEntries.map(e=>`<p class="text-gray-600 text-xs">ğŸ“… ${e.ts?new Date(e.ts).toLocaleString('cs-CZ'):'-'} Â· â±ï¸ ${fmt(e.duration||0)}</p>`).join('')}
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-white font-bold font-mono">${fmt(mySecs)}</p>
                            <p class="text-gray-400 text-xs">${((mySecs/3600)*(u.hourly_rate||180)).toFixed(2)} KÄ</p>
                            ${matC>0?`<p class="text-gray-500 text-xs">mat: ${matC.toFixed(2)} KÄ</p>`:''}
                        </div>
                    </div>
                </div>`;
            }).join('');

            return `<div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
                <div class="p-5 flex items-center justify-between gap-4 cursor-pointer hover:bg-gray-800 transition-colors" onclick="toggleEmpDetail('emp_${u.id}')">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-red-900/40 border border-red-800 flex items-center justify-center text-xl font-black text-red-400">
                            ${u.full_name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-bold text-white text-lg">${u.full_name}</p>
                            <p class="text-gray-500 text-sm">${getSections(u.section)} Â· ${u.hourly_rate} KÄ/hod</p>
                        </div>
                    </div>
                    <div class="flex gap-3 text-center">
                        <div class="bg-gray-800 rounded-xl px-3 py-2 min-w-[60px]"><p class="text-gray-500 text-xs">Ãškoly</p><p class="text-white font-black text-xl">${empTasks.length}</p></div>
                        <div class="bg-green-900/20 border border-green-900 rounded-xl px-3 py-2 min-w-[60px]"><p class="text-green-400 text-xs">Hotovo</p><p class="text-green-400 font-black text-xl">${done}</p></div>
                        <div class="bg-yellow-900/20 border border-yellow-900 rounded-xl px-3 py-2 min-w-[60px]"><p class="text-yellow-400 text-xs">ProbÃ­hÃ¡</p><p class="text-yellow-400 font-black text-xl">${inProg}</p></div>
                        <div class="bg-gray-800 rounded-xl px-3 py-2 min-w-[70px]"><p class="text-gray-500 text-xs">ÄŒas</p><p class="text-white font-bold text-sm">${fmt(totalSecs)}</p></div>
                        <div class="bg-red-900/20 border border-red-900 rounded-xl px-3 py-2 min-w-[80px]"><p class="text-red-400 text-xs">NÃ¡klady</p><p class="text-red-400 font-bold">${totalCost.toFixed(0)} KÄ</p></div>
                        <span class="text-gray-500 self-center text-xl">â€º</span>
                    </div>
                </div>
                <div id="emp_${u.id}" class="hidden border-t border-gray-800 p-5 space-y-3">
                    <h3 class="font-bold text-gray-300 mb-2">ğŸ“‹ PÅ™iÅ™azenÃ© Ãºkoly a Äasy</h3>
                    ${empTasks.length===0?'<p class="text-gray-500 text-sm py-4 text-center">Å½Ã¡dnÃ© pÅ™iÅ™azenÃ© Ãºkoly</p>':taskRows}
                </div>
            </div>`;
        }).join('');

        return `<div class="space-y-5">
            <h1 class="text-3xl font-black">Moji zamÄ›stnanci</h1>
            ${visibleUsers.length===0
                ? '<div class="bg-gray-900 rounded-2xl p-10 text-center border border-gray-800"><p class="text-gray-500">Å½Ã¡dnÃ­ zamÄ›stnanci v tvÃ©m Ãºseku</p></div>'
                : empCards}
        </div>`;
    }

    // ADMIN VIEW - full table
    return `<div class="space-y-4">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-black">ZamÄ›stnanci</h1>
            <button onclick="document.getElementById('modalUser').classList.remove('hidden')" class="ardon-red hover:bg-red-700 text-white px-6 py-3 rounded-xl font-bold">+ PÅ™idat</button>
        </div>
        <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-x-auto">
            <table class="w-full text-sm"><thead class="bg-gray-800"><tr>
                <th class="text-left p-4 text-gray-400">JmÃ©no</th>
                <th class="text-left p-4 text-gray-400">Login</th>
                <th class="text-left p-4 text-gray-400">Role</th>
                <th class="text-left p-4 text-gray-400">Ãšseky</th>
                <th class="text-left p-4 text-gray-400">Sazba</th>
                <th class="text-left p-4 text-gray-400">Akce</th>
            </tr></thead><tbody>
                ${visibleUsers.map(u=>`<tr class="border-t border-gray-800 hover:bg-gray-800">
                    <td class="p-4 font-semibold">${u.full_name}</td>
                    <td class="p-4 text-gray-400">${u.username}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${u.role==='superAdmin'?'bg-red-900/40 text-red-400':u.role==='manager'?'bg-blue-900/40 text-blue-400':'bg-gray-700 text-gray-300'}">${tx(u.role)}</span></td>
                    <td class="p-4">${getSections(u.section)}</td>
                    <td class="p-4 text-gray-300">${u.hourly_rate} KÄ/hod</td>
                    <td class="p-4"><div class="flex gap-2">
                        <button onclick="editUser(${u.id})" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold">âœï¸ Upravit</button>
                        ${u.id!==CU.id?`<button onclick="deleteUser(${u.id})" class="bg-red-800 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-xs font-bold">ğŸ—‘ï¸ Smazat</button>`:'<span class="text-gray-600 text-xs">aktuÃ¡lnÃ­</span>'}
                    </div></td>
                </tr>`).join('')}
            </tbody></table>
        </div>
    </div>`;
}

function toggleEmpDetail(id){
    const el=document.getElementById(id);
    if(el) el.classList.toggle('hidden');
}


function renderReports(filterSecs, filterEmp){
    filterSecs = filterSecs || ['all'];
    filterEmp = filterEmp || 'all';

    // MODE: summary | detailed | monthly
    if(!window.currentReportMode) window.currentReportMode = 'detailed';
    if(!window.currentReportMonth) window.currentReportMonth = new Date().toISOString().slice(0,7); // YYYY-MM

    const managerSecs = CU.role==='manager' ? (CU.section||'all').split(',') : ['all'];
    const allSections = [
        {val:'all', label:'ğŸŒ VÅ¡echny Ãºseky'},
        {val:'exqc', label:'ğŸ” ExQC'},
        {val:'blistrovani', label:'ğŸ’Š BlistrovÃ¡nÃ­'},
        {val:'potisk', label:'ğŸ–¨ï¸ Potisk'},
        {val:'prijem', label:'ğŸ“¦ PÅ™Ã­jem'},
        {val:'extra_prace', label:'ğŸ§¹ Extra prÃ¡ce'},
        {val:'prace_z_domu', label:'ğŸ  PrÃ¡ce z domu'},
        {val:'grafika', label:'ğŸ¨ Grafika'},
    ];
    const sections = CU.role==='superAdmin' ? allSections : allSections.filter(s=>s.val==='all'||managerSecs.includes(s.val));
    const employees = USERS.filter(u=>u.role==='employee');

    const allCompleted = visibleTasks(null).filter(t=>t.status==='completed');
    let tasks = filterSecs.includes('all') ? allCompleted : allCompleted.filter(t=>filterSecs.includes(t.section));

    // helper parsers
    const pEntries = (t)=> t.time_entries ? JSON.parse(t.time_entries) : [];
    const pProd = (t)=> t.production_entries ? JSON.parse(t.production_entries) : [];

    function dateKeyFromISO(iso){
        const d=new Date(iso);
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${da}`;
    }
    function normMinPerPiece(task){
        const n = Number(task.norm||0); // ks/hod
        return n>0 ? (60/n) : 0;
    }
    function fmtMin(x){return `${Math.round(x*10)/10}`;}

    // filter by employee
    if(filterEmp !== 'all'){
        const empId = parseInt(filterEmp,10);
        tasks = tasks.filter(t=>{
            const e = pEntries(t);
            const prod = pProd(t);
            return e.some(x=>x.userId===empId) || prod.some(x=>x.userId===empId);
        });
    }

    // SUMMARY totals
    let totSec=0, totCost=0, totPieces=0, totBilled=0;
    tasks.forEach(t=>{
        const e=pEntries(t);
        const s=e.reduce((x,y)=>x+(y.duration||0),0);
        const mats=t.materials?JSON.parse(t.materials):[];
        totSec+=s;
        totCost += laborCostEntries(e) + mats.reduce((x,y)=>x+(y.qty*y.price),0);
        // monthly/detailed uses production entries; keep total pieces as completed_pieces for headline
        totPieces += (t.completed_pieces||0);
        try{ const b=t.billing?JSON.parse(t.billing):{}; totBilled += Number(b.billed_amount||0); }catch(e){}
    });

    // DETAILED aggregation (per task -> per day -> per employee)
    function buildDetailed(task){
        const segs = pEntries(task).filter(x=>x && x.ts);
        const prod = pProd(task).filter(x=>x && x.ts);
        const map = {}; // date -> empId -> {sec,pieces}
        for(const s of segs){
            const dk=dateKeyFromISO(s.ts);
            map[dk] ||= {};
            map[dk][s.userId] ||= {sec:0,pieces:0};
            map[dk][s.userId].sec += (s.duration||0);
        }
        for(const p of prod){
            const dk=dateKeyFromISO(p.ts);
            map[dk] ||= {};
            map[dk][p.userId] ||= {sec:0,pieces:0};
            map[dk][p.userId].pieces += (p.pieces||0);
        }
        const days = Object.keys(map).sort();
        const rows = [];
        let tSec=0, tPieces=0;
        for(const day of days){
            const empIds = Object.keys(map[day]).map(x=>parseInt(x,10));
            empIds.sort((a,b)=>{
                const an=USERS.find(u=>u.id===a)?.full_name||'';
                const bn=USERS.find(u=>u.id===b)?.full_name||'';
                return an.localeCompare(bn,'cs');
            });
            for(const eid of empIds){
                const v=map[day][eid];
                tSec += v.sec;
                tPieces += v.pieces;
                const mins=v.sec/60;
                const mpp = v.pieces>0 ? (mins/v.pieces) : 0;
                const norm = normMinPerPiece(task);
                const diff = norm>0 && v.pieces>0 ? (mpp-norm) : null;
                rows.push({day,eid,sec:v.sec,pieces:v.pieces,mins,mpp,norm,diff});
            }
        }
        const totalMins=tSec/60;
        const totalMpp = tPieces>0 ? totalMins/tPieces : 0;
        const norm=normMinPerPiece(task);
        const totalDiff = norm>0 && tPieces>0 ? (totalMpp-norm) : null;
        return {rows, tSec, tPieces, totalMpp, norm, totalDiff};
    }

    
    function renderSummaryHTML(){
        if(!tasks.length) return `<p class="text-gray-500 text-center py-8">Å½Ã¡dnÃ¡ data</p>`;

        // Aggregace podle dodavatele a zamÄ›stnance
        const supAgg = {};
        const empAgg = {};
        const taskRows = tasks.map(t=>{
            const e=pEntries(t);
            const mats=t.materials?JSON.parse(t.materials):[];
            const matC=mats.reduce((x,y)=>x+(y.qty*y.price),0);
            const labor=laborCostEntries(e);
            let billed=0;
            try{ const b=t.billing?JSON.parse(t.billing):{}; billed=Number(b.billed_amount||0); }catch(err){}
            const cost=labor+matC;
            const supplier=t.supplier||'(bez dodavatele)';

            supAgg[supplier]=supAgg[supplier]||{billed:0,cost:0,tasks:0};
            supAgg[supplier].billed+=billed; supAgg[supplier].cost+=cost; supAgg[supplier].tasks+=1;

            // employee cost
            for(const en of e){
                const uid=en.userId;
                empAgg[uid]=empAgg[uid]||{sec:0,cost:0};
                empAgg[uid].sec+=(en.duration||0);
                empAgg[uid].cost+=((en.duration||0)/3600)*userHourlyRate(uid);
            }

            return {t, labor, matC, cost, billed};
        });

        const supRows = Object.entries(supAgg).map(([name,v])=>({name,...v,profit:v.billed-v.cost}))
            .sort((a,b)=>b.billed-a.billed);

        const empRows = Object.entries(empAgg).map(([uid,v])=>{
            const u=getUserById(uid)||{};
            return {uid:Number(uid), name:u.full_name||u.username||('ID '+uid), sec:v.sec, cost:v.cost};
        }).sort((a,b)=>b.sec-a.sec);

        return `
        <div class="space-y-4">
            <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800">
                <h3 class="font-black text-lg mb-3">Souhrn ÃºkolÅ¯</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm" data-sheet="Ukoly">
                        <thead class="text-gray-400">
                            <tr class="border-b border-gray-800">
                                <th class="text-left py-2 pr-4">Ãškol</th>
                                <th class="text-right py-2 pr-4">PrÃ¡ce</th>
                                <th class="text-right py-2 pr-4">MateriÃ¡l</th>
                                <th class="text-right py-2 pr-4">NÃ¡klady</th>
                                <th class="text-right py-2">VyÃºÄtovÃ¡no</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${taskRows.map(r=>`
                                <tr class="border-b border-gray-800/60">
                                    <td class="py-2 pr-4">
                                        <a href="#" onclick="openDetail(${r.t.id});return false;" class="font-semibold hover:underline">${r.t.task_name}</a>
                                        <span class="text-gray-500">#${r.t.task_number}</span>
                                        <span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-800 text-gray-300">${sn(r.t.section)}</span>
                                    </td>
                                    <td class="text-right py-2 pr-4">${fmtKc(r.labor)}</td>
                                    <td class="text-right py-2 pr-4">${fmtKc(r.matC)}</td>
                                    <td class="text-right py-2 pr-4 font-bold">${fmtKc(r.cost)}</td>
                                    <td class="text-right py-2 font-bold text-yellow-300">${fmtKc(r.billed)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800">
                    <h3 class="font-black text-lg mb-3">VyÃºÄtovÃ¡nÃ­ podle dodavatele</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" data-sheet="Dodavatele">
                            <thead class="text-gray-400">
                                <tr class="border-b border-gray-800">
                                    <th class="text-left py-2 pr-4">Dodavatel</th>
                                    <th class="text-right py-2 pr-4">VyÃºÄt.</th>
                                    <th class="text-right py-2 pr-4">NÃ¡klady</th>
                                    <th class="text-right py-2">RozdÃ­l</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${supRows.map(r=>`
                                    <tr class="border-b border-gray-800/60">
                                        <td class="py-2 pr-4">${r.name}<span class="ml-2 text-xs text-gray-500">(${r.tasks} ÃºkolÅ¯)</span></td>
                                        <td class="text-right py-2 pr-4 font-bold text-yellow-300">${fmtKc(r.billed)}</td>
                                        <td class="text-right py-2 pr-4">${fmtKc(r.cost)}</td>
                                        <td class="text-right py-2 font-bold">${fmtKc(r.profit)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800">
                    <h3 class="font-black text-lg mb-3">NÃ¡klady prÃ¡ce podle zamÄ›stnance</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" data-sheet="Zamestnanci">
                            <thead class="text-gray-400">
                                <tr class="border-b border-gray-800">
                                    <th class="text-left py-2 pr-4">ZamÄ›stnanec</th>
                                    <th class="text-right py-2 pr-4">ÄŒas</th>
                                    <th class="text-right py-2">NÃ¡klad prÃ¡ce</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${empRows.map(r=>`
                                    <tr class="border-b border-gray-800/60">
                                        <td class="py-2 pr-4">${r.name}</td>
                                        <td class="text-right py-2 pr-4">${fmt(r.sec)}</td>
                                        <td class="text-right py-2 font-bold">${fmtKc(r.cost)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>`;
    }

function renderDetailedHTML(){
        if(!tasks.length) return `<p class="text-gray-500 text-center py-8">Å½Ã¡dnÃ¡ data</p>`;
        return `<div class="space-y-4">
            ${tasks.map(task=>{
                const d=buildDetailed(task);
                const head = `<div class="flex items-center justify-between flex-wrap gap-3">
                    <div>
                        <p class="font-black text-lg">${task.task_name} <span class="text-gray-500 font-normal">#${task.task_number}</span></p>
                        <p class="text-gray-500 text-sm">${sn(task.section)} Â· ${task.supplier||''}</p>
                        ${task.photo_url?`<div class="mt-2"><img src="${task.photo_url}" class="rounded-xl max-h-40 object-cover" alt="Foto"></div>`:''}
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-400">Celkem</p>
                        <p class="font-black">${fmt(d.tSec)} Â· ${d.tPieces} ks</p>
                        <p class="text-gray-400 text-sm">PrÅ¯mÄ›r: ${d.tPieces?fmtMin(d.totalMpp):'-'} min/ks ${d.norm?`(norma ${fmtMin(d.norm)})`:''}</p>
                    </div>
                </div>`;
                if(!d.rows.length){
                    return `<div class="bg-gray-900 rounded-2xl p-5 border border-gray-800">${head}<p class="text-gray-500 mt-3">ChybÃ­ dennÃ­ kusy (ğŸ“¦ DennÃ­ kusy) nebo ÄasovÃ© zÃ¡znamy.</p></div>`;
                }
                return `<div class="bg-gray-900 rounded-2xl p-5 border border-gray-800">
                    ${head}
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full text-sm">
                            <thead class="text-gray-400">
                                <tr class="border-b border-gray-800">
                                    <th class="text-left py-2 pr-4">Den</th>
                                    <th class="text-left py-2 pr-4">ZamÄ›stnanec</th>
                                    <th class="text-right py-2 pr-4">ÄŒas</th>
                                    <th class="text-right py-2 pr-4">Kusy</th>
                                    <th class="text-right py-2 pr-4">Min/ks</th>
                                    <th class="text-right py-2">Vs norma</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${d.rows.map(r=>{
                                    const u=USERS.find(x=>x.id===r.eid);
                                    const vs = (r.diff===null) ? '-' : (r.diff>0?`+${fmtMin(r.diff)}`:fmtMin(r.diff));
                                    return `<tr class="border-b border-gray-800/60">
                                        <td class="py-2 pr-4 text-gray-300">${new Date(r.day).toLocaleDateString('cs-CZ')}</td>
                                        <td class="py-2 pr-4">${u?.full_name||r.eid}</td>
                                        <td class="py-2 pr-4 text-right">${fmt(r.sec)}</td>
                                        <td class="py-2 pr-4 text-right font-semibold">${r.pieces}</td>
                                        <td class="py-2 pr-4 text-right">${r.pieces?fmtMin(r.mpp):'-'}</td>
                                        <td class="py-2 text-right ${r.diff>0?'text-yellow-300':r.diff<0?'text-green-300':'text-gray-400'}">${vs}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // MONTHLY base for employee
    function renderMonthlyHTML(){
        const month = window.currentReportMonth; // YYYY-MM
        const empId = (filterEmp==='all') ? null : parseInt(filterEmp,10);
        if(!empId){
            return `<p class="text-gray-500">Vyber zamÄ›stnance vÃ½Å¡e (Filtrovat podle zamÄ›stnance) a pak mÄ›sÃ­c.</p>`;
        }
        // collect tasks where emp has entries in the month (including awaitingApproval if needed)
        const monthStart = new Date(month+'-01T00:00:00');
        const monthEnd = new Date(monthStart);
        monthEnd.setMonth(monthEnd.getMonth()+1);

        const allForMonth = visibleTasks(null).filter(t=>t.status==='completed' || t.status==='awaitingApproval');
        const scoped = filterSecs.includes('all') ? allForMonth : allForMonth.filter(t=>filterSecs.includes(t.section));

        const rows=[];
        let sumSec=0, sumPieces=0;
        for(const task of scoped){
            const segs = pEntries(task).filter(e=>e.userId===empId && e.ts);
            const prod = pProd(task).filter(p=>p.userId===empId && p.ts);
            const sec = segs.filter(e=>{
                const d=new Date(e.ts); return d>=monthStart && d<monthEnd;
            }).reduce((s,e)=>s+(e.duration||0),0);
            const pcs = prod.filter(p=>{
                const d=new Date(p.ts); return d>=monthStart && d<monthEnd;
            }).reduce((s,p)=>s+(p.pieces||0),0);
            if(sec===0 && pcs===0) continue;
            sumSec+=sec; sumPieces+=pcs;
            const mins=sec/60;
            const mpp=pcs>0?mins/pcs:0;
            rows.push({task,sec,pcs,mpp});
        }
        rows.sort((a,b)=>b.sec-a.sec);

        const u=USERS.find(x=>x.id===empId);
        return `<div class="bg-gray-900 rounded-2xl p-5 border border-gray-800">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div>
                    <p class="font-black text-lg">MÄ›sÃ­ÄnÃ­ pÅ™ehled: ${u?.full_name||empId}</p>
                    <p class="text-gray-500 text-sm">${month}</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-400 text-sm">SouÄet</p>
                    <p class="font-black">${fmt(sumSec)} Â· ${sumPieces} ks</p>
                    <p class="text-gray-400 text-sm">PrÅ¯mÄ›r: ${sumPieces?fmtMin((sumSec/60)/sumPieces):'-'} min/ks</p>
                </div>
            </div>

            <div class="mt-4 flex items-center gap-3 flex-wrap">
                <label class="text-gray-400 text-sm">MÄ›sÃ­c:</label>
                <input type="month" value="${month}" onchange="setReportMonth(this.value)" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg">
            </div>

            <div class="overflow-x-auto mt-4">
                <table class="min-w-full text-sm">
                    <thead class="text-gray-400">
                        <tr class="border-b border-gray-800">
                            <th class="text-left py-2 pr-4">Ãškol</th>
                            <th class="text-left py-2 pr-4">Foto</th>
                            <th class="text-right py-2 pr-4">ÄŒas</th>
                            <th class="text-right py-2 pr-4">Kusy</th>
                            <th class="text-right py-2">Min/ks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(r=>`<tr class="border-b border-gray-800/60">
                            <td class="py-2 pr-4">
                                <a href="#" onclick="openDetail(${r.task.id});return false;" class="font-semibold hover:underline">${r.task.task_name}</a>
                                <span class="text-gray-500">#${r.task.task_number}</span>
                                <span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-gray-800 text-gray-300">${sn(r.task.section)}</span>
                                ${r.task.status==='awaitingApproval'?`<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-purple-900/30 text-purple-200">ÄekÃ¡</span>`:''}
                            </td>
                            <td class="py-2 pr-4 text-right">${fmt(r.sec)}</td>
                            <td class="py-2 pr-4 text-right font-semibold">${r.pcs}</td>
                            <td class="py-2 text-right">${r.pcs?fmtMin(r.mpp):'-'}</td>
                        </tr>`).join('') || `<tr><td colspan="4" class="py-6 text-center text-gray-500">Å½Ã¡dnÃ¡ data pro tento mÄ›sÃ­c.</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>`;
    }

    const modeBtns = `
        <div class="flex gap-2 flex-wrap">
            <button onclick="setReportMode('summary')" class="px-4 py-2 rounded-xl font-bold text-sm border ${window.currentReportMode==='summary'?'ardon-red border-red-600 text-white':'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}">Souhrn</button>
            <button onclick="setReportMode('detailed')" class="px-4 py-2 rounded-xl font-bold text-sm border ${window.currentReportMode==='detailed'?'ardon-red border-red-600 text-white':'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}">PodrobnÃ½</button>
            <button onclick="setReportMode('monthly')" class="px-4 py-2 rounded-xl font-bold text-sm border ${window.currentReportMode==='monthly'?'ardon-red border-red-600 text-white':'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}">MÄ›sÃ­ÄnÃ­ (zamÄ›stnanec)</button>
        </div>
        <div class="flex gap-3 mt-3">
            <button onclick="exportReportsExcel()" class="flex-1 bg-green-700 hover:bg-green-600 text-white py-2 rounded-xl font-bold text-sm">ğŸ“¥ Excel</button>
            <button onclick="exportReportsPDF()" class="flex-1 bg-red-800 hover:bg-red-700 text-white py-2 rounded-xl font-bold text-sm">ğŸ“„ PDF (vÄ. fotek)</button>
        </div>`;

    const body = window.currentReportMode==='monthly'
        ? renderMonthlyHTML()
        : (window.currentReportMode==='detailed'
            ? renderDetailedHTML()
            : `<div class="bg-gray-900 rounded-2xl p-6 border border-gray-800">
                    <p class="text-gray-400 mb-3">Souhrn je stejnÃ½ jako dÅ™Ã­ve. Pro poÅ¾adovanÃ½ detail pÅ™epni na â€PodrobnÃ½â€œ.</p>
               </div>`);

    return `<div class="space-y-5">
        <h1 class="text-3xl font-black">VÃ½kazy</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800">
                <p class="text-gray-400 text-xs font-semibold mb-3">Filtrovat podle Ãºseku:</p>
                <div class="flex flex-wrap gap-2">
                    ${sections.map(s=>`<button onclick="toggleReportFilter('${s.val}')" class="px-3 py-1.5 rounded-xl font-bold text-xs transition-colors border ${filterSecs.includes(s.val)||(filterSecs.includes('all')&&s.val==='all') ? 'ardon-red border-red-600 text-white' : 'bg-gray-800 border-gray-700 text-gray-300 hover:bg-gray-700'}">${s.label}</button>`).join('')}
                </div>
            </div>
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800">
                <p class="text-gray-400 text-xs font-semibold mb-3">Filtrovat podle zamÄ›stnance:</p>
                <select onchange="setReportEmpFilter(this.value)" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                    <option value="all" ${filterEmp==='all'?'selected':''}>ğŸ‘¥ VÅ¡ichni zamÄ›stnanci</option>
                    ${employees.map(u=>`<option value="${u.id}" ${filterEmp==u.id?'selected':''}>${u.full_name}</option>`).join('')}
                </select>
            </div>
        </div>

        <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800 flex items-center justify-between flex-wrap gap-3">
            ${modeBtns}
            <div class="text-gray-400 text-sm">Zobrazuji: ${tasks.length} dokonÄenÃ½ch ÃºkolÅ¯</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800"><p class="text-gray-400 text-xs">DokonÄenÃ© Ãºkoly</p><p class="text-3xl font-black">${tasks.length}</p></div>
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800"><p class="text-gray-400 text-xs">CelkovÃ½ Äas</p><p class="text-3xl font-black">${fmt(totSec)}</p></div>
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800"><p class="text-gray-400 text-xs">Celkem kusÅ¯</p><p class="text-3xl font-black">${totPieces}</p></div>
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800"><p class="text-gray-400 text-xs">VyÃºÄtovÃ¡no</p><p class="text-3xl font-black text-yellow-300">${totBilled.toFixed(0)} KÄ</p></div>
            <div class="bg-gray-900 rounded-2xl p-4 border border-gray-800"><p class="text-gray-400 text-xs">CelkovÃ© nÃ¡klady</p><p class="text-3xl font-black ardon-red-text">${totCost.toFixed(0)} KÄ</p></div>
        </div>

        <div id="reportsContainer">${body}</div>
    </div>`;
}

function setReportMode(m){
    window.currentReportMode=m;
    document.getElementById('mainContent').innerHTML=renderReports(currentReportFilter,currentReportEmpFilter||'all');
}
function setReportMonth(m){
    window.currentReportMonth=m;
    document.getElementById('mainContent').innerHTML=renderReports(currentReportFilter,currentReportEmpFilter||'all');
}


function toggleReportDetail(id){
    const el=document.getElementById(id);
    if(el) el.classList.toggle('hidden');
}

let currentReportEmpFilter='all';

function setReportEmpFilter(val){
    currentReportEmpFilter=val;
    document.getElementById('mainContent').innerHTML=renderReports(currentReportFilter,currentReportEmpFilter);
}


function toggleReportFilter(sec){
    if(sec==='all'){
        currentReportFilter=['all'];
    } else {
        currentReportFilter=currentReportFilter.filter(s=>s!=='all');
        if(currentReportFilter.includes(sec)){
            currentReportFilter=currentReportFilter.filter(s=>s!==sec);
            if(currentReportFilter.length===0) currentReportFilter=['all'];
        } else {
            currentReportFilter.push(sec);
        }
    }
    document.getElementById('mainContent').innerHTML=renderReports(currentReportFilter,currentReportEmpFilter);
}

function expXls(tid){
    const t=TASKS.find(x=>x.id===tid);if(!t)return;
    const e=t.time_entries?JSON.parse(t.time_entries):[];
    const s=e.reduce((x,y)=>x+(y.duration||0),0);
    const m=t.materials?JSON.parse(t.materials):[];
    const labor=(s/3600)*(CU.hourly_rate||180);
    const matC=m.reduce((x,y)=>x+(y.qty*y.price),0);
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet([
        ['ARDONÂ® Work Manager - VÃ½kaz'],[''],
        ['ÄŒÃ­slo Ãºkolu',t.task_number],['NÃ¡zev',t.task_name],['Dodavatel',t.supplier],['Druh zboÅ¾Ã­',t.goods_type||''],
        ['ÄŒ. objednÃ¡vky',t.order_number||''],['ÄŒ. avÃ­za',t.aviso_number||''],['Ãšsek',sn(t.section)],
        ['ZadÃ¡no',new Date(t.created_at).toLocaleString('cs-CZ')],['Popis',t.description],[''],
        ['VÃPOÄŒTY'],['StrÃ¡venÃ½ Äas',fmt(s)],['PoÄet kusÅ¯',t.completed_pieces||0],
        ['NÃ¡klady prÃ¡ce',labor.toFixed(2)+' KÄ'],['NÃ¡klady materiÃ¡lu',matC.toFixed(2)+' KÄ'],['CELKEM',(labor+matC).toFixed(2)+' KÄ'],[''],
        ['MATERIÃLY','MnoÅ¾stvÃ­','Cena/ks','Celkem'],
        ...m.map(x=>[x.name,x.qty,x.price,(x.qty*x.price).toFixed(2)])
    ]);
    XLSX.utils.book_append_sheet(wb,ws,'VÃ½kaz');
    // ÄŒASY (detail)
    const rowsT=[['ZamÄ›stnanec','ZaÄÃ¡tek','Konec','OdpracovÃ¡no (hod)','PoznÃ¡mka']];
    if(e.length===0){
        rowsT.push(['','','',0,'Bez zÃ¡znamu']);
    } else {
        e.slice().filter(x=>x&&x.ts).sort((a,b)=>new Date(a.ts)-new Date(b.ts)).forEach(en=>{
            const u=USERS.find(us=>us.id===en.userId);
            const end=new Date(en.ts);
            const start=new Date(end.getTime()-(en.duration||0)*1000);
            rowsT.push([u?.full_name||('ID:'+en.userId), start.toLocaleString('cs-CZ'), end.toLocaleString('cs-CZ'), ((en.duration||0)/3600).toFixed(3), en.note||'']);
        });
    }
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rowsT), 'ÄŒasy');

    XLSX.writeFile(wb,`ARDON_${t.task_number}_${t.supplier}.xlsx`);
}

function expAllXls(filterSecs){
    filterSecs=filterSecs||['all'];
    const allTsk=visibleTasks(null).filter(t=>t.status==='completed');
    const tasks=filterSecs.includes('all')?allTsk:allTsk.filter(t=>filterSecs.includes(t.section));
    const wb=XLSX.utils.book_new();

    // === LIST 1: PÅ™ehled ÃºkolÅ¯ ===
    const rows1=[['ÄŒ. Ãºkolu','NÃ¡zev Ãºkolu','Dodavatel','ZÃ¡kaznÃ­k','NÃ¡zev/Logo/Popis','Ãšsek','Popis prÃ¡ce','ÄŒ. objednÃ¡vky','ÄŒ. avÃ­za','Zadal/a','Datum zadÃ¡nÃ­','Datum dokonÄenÃ­','Celk. Äas (hod)','PoÄet kusÅ¯','NÃ¡klady prÃ¡ce (KÄ)','NÃ¡klady materiÃ¡lu (KÄ)','Celkem (KÄ)','VyÃºÄt. komu','Datum vyÃºÄt.','ÄŒÃ¡stka vyÃºÄt. (KÄ)']];
    tasks.forEach(t=>{
        const entries=t.time_entries?JSON.parse(t.time_entries):[];
        const totalSec=entries.reduce((s,e)=>s+(e.duration||0),0);
    const dispPhase = (normSection(task.section)==='prijem') ? getPhase(task.id, task) : 'general';
    const dispSec = (normSection(task.section)==='prijem')
        ? entries.filter(e=>(e.phase||'general')===dispPhase).reduce((s,e)=>s+(e.duration||0),0)
        : totalSec;
        const mats=t.materials?JSON.parse(t.materials):[];
        const labor=(totalSec/3600)*180;
        const matC=mats.reduce((s,m)=>s+(m.qty*m.price),0);
        const creator=USERS.find(u=>u.id===t.created_by);
        const billing=t.billing?JSON.parse(t.billing):{};
        rows1.push([
            t.task_number, t.task_name, t.supplier, t.customer||'',
            t.goods_type||'', sn(t.section), t.description||'',
            t.order_number||'', t.aviso_number||'',
            creator?.full_name||'',
            new Date(t.created_at).toLocaleString('cs-CZ'),
            t.completed_at?new Date(t.completed_at).toLocaleString('cs-CZ'):'',
            (totalSec/3600).toFixed(2), t.completed_pieces||0,
            labor.toFixed(2), matC.toFixed(2), (labor+matC).toFixed(2),
            billing.billed_to||'', billing.billed_date||'', billing.billed_amount||''
        ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows1), 'PÅ™ehled ÃºkolÅ¯');

    // === LIST 2: DetailnÃ­ Äasy - kaÅ¾dÃ½ start/stop ===
    const rows2=[['ÄŒ. Ãºkolu','NÃ¡zev Ãºkolu','Dodavatel','Ãšsek','ZamÄ›stnanec','Datum a Äas','OdpracovÃ¡no (hod)','PoznÃ¡mka']];
    tasks.forEach(t=>{
        const entries=t.time_entries?JSON.parse(t.time_entries):[];
        if(entries.length===0){
            rows2.push([t.task_number, t.task_name, t.supplier, sn(t.section),'','','','Bez zÃ¡znamu']);
        } else {
            entries.forEach(e=>{
                const worker=USERS.find(u=>u.id===e.userId);
                rows2.push([
                    t.task_number, t.task_name, t.supplier, sn(t.section),
                    worker?.full_name||('ID:'+e.userId),
                    e.ts?new Date(e.ts).toLocaleString('cs-CZ'):'',
                    (e.duration/3600).toFixed(3),
                    e.note||''
                ]);
            });
        }
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows2), 'DetailnÃ­ Äasy');

    // === LIST 3: MateriÃ¡ly ===
    const rows3=[['ÄŒ. Ãºkolu','NÃ¡zev Ãºkolu','Dodavatel','Ãšsek','MateriÃ¡l','MnoÅ¾stvÃ­','Jednotka','Cena/ks (KÄ)','Celkem (KÄ)']];
    tasks.forEach(t=>{
        const mats=t.materials?JSON.parse(t.materials):[];
        if(mats.length===0){
            rows3.push([t.task_number, t.task_name, t.supplier, sn(t.section),'','','','','']);
        } else {
            mats.forEach(m=>{
                rows3.push([t.task_number, t.task_name, t.supplier, sn(t.section),
                    m.name, m.qty, m.unit||'ks', m.price, (m.qty*m.price).toFixed(2)]);
            });
        }
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows3), 'MateriÃ¡ly');

    // === LIST 4: NÃ¡klady podle dodavatelÅ¯ ===
    const suppCosts={};
    tasks.forEach(t=>{
        const sup=t.supplier||'NeznÃ¡mÃ½';
        const entries=t.time_entries?JSON.parse(t.time_entries):[];
        const sec=entries.reduce((s,e)=>s+(e.duration||0),0);
        const mats=t.materials?JSON.parse(t.materials):[];
        const cost=(sec/3600)*180+mats.reduce((s,m)=>s+(m.qty*m.price),0);
        if(!suppCosts[sup])suppCosts[sup]={count:0,cost:0,pieces:0};
        suppCosts[sup].count++;
        suppCosts[sup].cost+=cost;
        suppCosts[sup].pieces+=(t.completed_pieces||0);
    });
    const rows4=[['Dodavatel','PoÄet ÃºkolÅ¯','CelkovÃ© nÃ¡klady (KÄ)','Celkem kusÅ¯']];
    Object.entries(suppCosts).sort((a,b)=>b[1].cost-a[1].cost).forEach(([name,d])=>{
        rows4.push([name, d.count, d.cost.toFixed(2), d.pieces]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows4), 'DodavatelÃ© - nÃ¡klady');

    // === LIST 5: VÃ½kon zamÄ›stnancÅ¯ ===
    const empStats={};
    tasks.forEach(t=>{
        const entries=t.time_entries?JSON.parse(t.time_entries):[];
        entries.forEach(e=>{
            const worker=USERS.find(u=>u.id===e.userId);
            const name=worker?.full_name||('ID:'+e.userId);
            if(!empStats[name])empStats[name]={tasks:new Set(),secs:0,pieces:0,cost:0};
            empStats[name].tasks.add(t.id);
            empStats[name].secs+=(e.duration||0);
            empStats[name].pieces+=(t.completed_pieces||0);
            empStats[name].cost+=((e.duration||0)/3600)*(worker?.hourly_rate||180);
        });
    });
    const rows5=[['ZamÄ›stnanec','PoÄet ÃºkolÅ¯','Celk. Äas (hod)','Celkem kusÅ¯','NÃ¡klady prÃ¡ce (KÄ)']];
    Object.entries(empStats).sort((a,b)=>b[1].secs-a[1].secs).forEach(([name,d])=>{
        rows5.push([name, d.tasks.size, (d.secs/3600).toFixed(2), d.pieces, d.cost.toFixed(2)]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows5), 'VÃ½kon zamÄ›stnancÅ¯');

    const date=new Date().toLocaleDateString('cs-CZ').replace(/\./g,'_');
    XLSX.writeFile(wb, `ARDON_vykazy_${date}.xlsx`);
    notify('ğŸ“¥ Excel exportovÃ¡n - 5 listÅ¯!');
}


function expPDF(tid){
    const t=TASKS.find(x=>x.id===tid);if(!t)return;
    const e=t.time_entries?JSON.parse(t.time_entries):[];const s=e.reduce((x,y)=>x+(y.duration||0),0);
    const m=t.materials?JSON.parse(t.materials):[];const labor=laborCostEntries(e);const matC=m.reduce((x,y)=>x+(y.qty*y.price),0);
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ARDONÂ® VÃ½kaz</title><style>body{font-family:Arial,sans-serif;margin:30px;color:#222}h1{color:#E30613;margin-bottom:5px}h2{color:#333}table{width:100%;border-collapse:collapse;margin:10px 0}td,th{padding:8px 12px;border:1px solid #ddd;text-align:left}th{background:#f5f5f5;font-weight:bold}.total{background:#fff0f0;font-weight:bold;color:#E30613}.footer{color:#999;font-size:11px;margin-top:20px}</style></head>
    <body><h1>ARDONÂ® Work Manager</h1><h2>VÃ½kaz: ${t.task_name}</h2>
    <table><tr><th>ÄŒÃ­slo Ãºkolu</th><td>${t.task_number}</td><th>Dodavatel</th><td>${t.supplier}</td></tr>
    <tr><th>Druh zboÅ¾Ã­</th><td>${t.goods_type||'-'}</td><th>Ãšsek</th><td>${sn(t.section)}</td></tr>
    <tr><th>ÄŒ. objednÃ¡vky</th><td>${t.order_number||'-'}</td><th>ÄŒ. avÃ­za</th><td>${t.aviso_number||'-'}</td></tr>
    <tr><th>ZadÃ¡no</th><td>${new Date(t.created_at).toLocaleString('cs-CZ')}</td><th>DokonÄeno</th><td>${t.completed_at?new Date(t.completed_at).toLocaleString('cs-CZ'):'-'}</td></tr>
    <tr><th colspan="4">Popis: ${t.description}</th></tr></table>
    <h3>VÃ½poÄty</h3>
    <table><tr><th>StrÃ¡venÃ½ Äas</th><td>${fmt(s)}</td><th>PoÄet kusÅ¯</th><td>${t.completed_pieces||0}</td></tr>
    <tr><th>NÃ¡klady prÃ¡ce</th><td>${labor.toFixed(2)} KÄ</td><th>NÃ¡klady materiÃ¡lu</th><td>${matC.toFixed(2)} KÄ</td></tr>
    <tr class="total"><th>CELKEM</th><td colspan="3">${(labor+matC).toFixed(2)} KÄ</td></tr></table>
    ${m.length?`<h3>MateriÃ¡ly</h3><table><tr><th>NÃ¡zev</th><th>MnoÅ¾stvÃ­</th><th>Cena/ks</th><th>Celkem</th></tr>${m.map(x=>`<tr><td>${x.name}</td><td>${x.qty}</td><td>${x.price} KÄ</td><td>${(x.qty*x.price).toFixed(2)} KÄ</td></tr>`).join('')}</table>`:''}
    <p class="footer">VygenerovÃ¡no: ${new Date().toLocaleString('cs-CZ')} | ARDONÂ® Work Manager</p>
    
<!-- WAREHOUSE MODAL -->
<div id="modalWarehouse" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">ğŸ“¦ SprÃ¡va skladu materiÃ¡lÅ¯</h2>
            <button onclick="closeModal('modalWarehouse')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <div class="p-2 border-b border-gray-800 flex">
            <button onclick="whTab('materials')" id="wt_materials" class="flex-1 py-2 text-sm font-bold rounded-lg ardon-red text-white mx-1">ğŸ“¦ MateriÃ¡l</button>
            <button onclick="whTab('logos')" id="wt_logos" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ–¨ï¸ Loga (Potisk)</button>
            <button onclick="whTab('suppliers')" id="wt_suppliers" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ­ DodavatelÃ©</button>
            <button onclick="whTab('customers')" id="wt_customers" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ‘¤ ZÃ¡kaznÃ­ci</button>
        </div>

        <!-- MATERIALS TAB -->
        <div id="whTab_materials" class="p-6 space-y-4">
            <form id="formWarehouse" onsubmit="submitWarehouseItem(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat materiÃ¡l do skladu</p>
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2"><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label><input type="text" name="name" required placeholder="napÅ™. Karton A4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Cena/kus (KÄ) *</label><input type="number" name="price" required step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Jednotka</label><select name="unit" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><option value="ks">ks</option><option value="m">m</option><option value="kg">kg</option><option value="l">l</option><option value="bal">bal</option></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Kategorie</label><input type="text" name="category" placeholder="napÅ™. Obal" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="ardon-red hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat</button>
            </form>
            <div id="warehouseList" class="space-y-2"></div>
        </div>

        <!-- LOGOS TAB (Potisk) -->
        <div id="whTab_logos" class="hidden p-6 space-y-4">
            <form id="formLogo" onsubmit="submitLogoItem(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat typ loga pro Potisk</p>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label><input type="text" name="name" required placeholder="napÅ™. Logo zÃ¡kaznÃ­ka" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Velikost</label><select name="size" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><option value="S">S - MalÃ©</option><option value="M">M - StÅ™ednÃ­</option><option value="L">L - VelkÃ©</option></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Cena/ks (KÄ) *</label><input type="number" name="price" required step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat logo</button>
            </form>
            <div id="logoList" class="space-y-2"></div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="whTab_suppliers" class="hidden p-6 space-y-4">
            <form id="formSupplier" onsubmit="submitSupplier(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat dodavatele</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev dodavatele *</label><input type="text" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Kontakt (volitelnÃ©)</label><input type="text" name="contact" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat dodavatele</button>
            </form>
            <div id="supplierList" class="space-y-2"></div>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="whTab_customers" class="hidden p-6 space-y-4">
            <form id="formCustomer" onsubmit="submitCustomer(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat zÃ¡kaznÃ­ka (Potisk)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev zÃ¡kaznÃ­ka *</label><input type="text" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label><input type="text" name="note" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-purple-700 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat zÃ¡kaznÃ­ka</button>
            </form>
            <div id="customerList" class="space-y-2"></div>
        </div>
    </div>
</div>

<!-- SELECT MATERIAL MODAL -->
<div id="modalSelectMat" class="hidden fixed inset-0 modal-bg z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-5 border-b border-gray-800">
            <h2 class="text-lg font-bold">ğŸ“¦ Vybrat materiÃ¡l ze skladu</h2>
            <button onclick="closeModal('modalSelectMat')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <div class="p-5 space-y-3">
            <input type="text" id="matSearchInput" onkeyup="filterWarehouse()" placeholder="Hledat materiÃ¡l..." class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm">
            <div id="matSelectList" class="space-y-2"></div>
            <div id="matQtySection" class="hidden bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-white font-semibold" id="matSelectedName"></p>
                <div class="flex items-center gap-3">
                    <div class="flex-1"><label class="block text-gray-400 text-xs mb-1">MnoÅ¾stvÃ­</label><input type="number" id="matQtyInput" value="1" min="1" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                    <div class="flex-1"><label class="block text-gray-400 text-xs mb-1">Cena/ks</label><input type="number" id="matPriceInput" step="0.01" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                </div>
                <button onclick="confirmSelectMat()" class="w-full ardon-red hover:bg-red-700 text-white py-2 rounded-lg font-bold">âœ… PÅ™idat k Ãºkolu</button>
            </div>
        </div>
    </div>
</div>


<!-- EDIT TASK MODAL -->
<div id="modalEditTask" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">âœï¸ Upravit Ãºkol</h2>
            <button onclick="closeModal('modalEditTask')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formEditTask" onsubmit="submitEditTask(event)" class="p-6 space-y-4">
            <input type="hidden" name="task_id" id="editTaskId">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒÃ­slo Ãºkolu</label><input type="text" name="task_number" id="edit_task_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev Ãºkolu</label><input type="text" name="task_name" id="edit_task_name" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Dodavatel</label><input type="text" name="supplier" id="edit_supplier" list="suppliersList" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev / Logo / Popis</label><input type="text" name="goods_type" id="edit_goods_type" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒ. objednÃ¡vky</label><input type="text" name="order_number" id="edit_order_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒ. avÃ­za</label><input type="text" name="aviso_number" id="edit_aviso_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Popis prÃ¡ce</label><textarea name="description" id="edit_description" rows="2" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none resize-none"></textarea></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Priorita</label>
                <select name="priority" id="edit_priority" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="0">Bez priority</option>
                    <option value="1">ğŸ”´ Priorita 1 - UrgentnÃ­</option>
                    <option value="2">ğŸŸ¡ Priorita 2 - StÅ™ednÃ­</option>
                    <option value="3">ğŸŸ¢ Priorita 3 - NormÃ¡lnÃ­</option>
                </select></div>
                <div><label class="block text-gray-400 text-sm mb-1">Stav</label>
                <select name="status" id="edit_status" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="pending">â³ ÄŒekÃ¡</option>
                    <option value="inProgress">â–¶ï¸ ProbÃ­hÃ¡</option>
                    <option value="completed">âœ… DokonÄeno</option>
                </select></div>
            </div>
            <div>
                <label class="block text-gray-400 text-sm mb-1">ğŸ‘¥ PÅ™iÅ™adit zamÄ›stnancÅ¯m <span class="text-gray-500 text-xs">(Ctrl+klik = vÃ­ce)</span></label>
                <select name="assigned_to" id="edit_assigned_to" multiple class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none h-36">
                </select>
                <p class="text-gray-600 text-xs mt-1">PodrÅ¾te Ctrl (nebo Cmd na Mac) pro vÃ½bÄ›r vÃ­ce zamÄ›stnancÅ¯. <span class="text-yellow-500">Bez vÃ½bÄ›ru = vidÃ­ vÅ¡ichni zamÄ›stnanci Ãºseku.</span></p>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Norma (ks/hod)</label><input type="number" name="norm" id="edit_norm" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold transition-colors">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
                <button type="button" onclick="closeModal('modalEditTask')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>


<!-- MANUAL/HISTORICAL TASK MODAL -->
<div id="modalManualTask" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[95vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <div>
                <h2 class="text-xl font-bold">ğŸ“‹ HistorickÃ½ / archivnÃ­ Ãºkol</h2>
                <p class="text-gray-500 text-sm mt-1">RuÄnÃ­ zadÃ¡nÃ­ dokonÄenÃ©ho Ãºkolu s vlastnÃ­mi Äasy a materiÃ¡ly</p>
            </div>
            <button onclick="closeModal('modalManualTask')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formManualTask" onsubmit="submitManualTask(event)" class="p-6 space-y-5">

            <!-- ZÃ¡kladnÃ­ info -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ“ ZÃ¡kladnÃ­ informace</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ­slo Ãºkolu *</label>
                    <input type="text" name="task_number" required placeholder="napÅ™. 41" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev Ãºkolu *</label>
                    <input type="text" name="task_name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Dodavatel</label>
                    <input type="text" name="supplier" list="suppliersList" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev / Logo / Popis</label>
                    <input type="text" name="goods_type" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒ. objednÃ¡vky</label>
                    <input type="text" name="order_number" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒ. avÃ­za</label>
                    <input type="text" name="aviso_number" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ZÃ¡kaznÃ­k (Potisk)</label>
                    <input type="text" name="customer" list="customersList" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Ãšsek *</label>
                    <select name="section" id="manualSection" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                        <option value="exqc">ExQC</option>
                        <option value="blistrovani">BlistrovÃ¡nÃ­</option>
                        <option value="potisk">Potisk</option><option value="prijem">PÅ™Ã­jem</option><option value="extra_prace">Extra prÃ¡ce</option>
                        <option value="prace_z_domu">PrÃ¡ce z domu</option>
                        <option value="grafika">Grafika</option>
                    </select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Priorita</label>
                    <select name="priority" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                        <option value="0">Bez priority</option>
                        <option value="1">ğŸ”´ P1 - UrgentnÃ­</option>
                        <option value="2">ğŸŸ¡ P2 - StÅ™ednÃ­</option>
                        <option value="3">ğŸŸ¢ P3 - NormÃ¡lnÃ­</option>
                    </select></div>
                </div>
                <div><label class="block text-gray-500 text-xs mb-1">Popis prÃ¡ce</label>
                <textarea name="description" rows="2" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm resize-none"></textarea></div>
            </div>

            <!-- Kdo a kdy -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ‘¤ Kdo a kdy</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Zadal/a Ãºkol</label>
                    <select name="created_by_manual" id="manualCreatedBy" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum zadÃ¡nÃ­</label>
                    <input type="datetime-local" name="created_at_manual" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Datum dokonÄenÃ­</label>
                    <input type="datetime-local" name="completed_at_manual" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoÄet kusÅ¯</label>
                    <input type="number" name="completed_pieces" placeholder="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>

            <!-- ÄŒasy zamÄ›stnancÅ¯ -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-gray-300 font-bold text-sm">â±ï¸ ÄŒasy zamÄ›stnancÅ¯</p>
                    <button type="button" onclick="addManualTimeEntry()" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold">+ PÅ™idat Äas</button>
                </div>
                <p class="text-gray-600 text-xs">PÅ™idej Äas pro kaÅ¾dÃ©ho zamÄ›stnance kterÃ½ na Ãºkolu pracoval</p>
                <div id="manualTimeEntries" class="space-y-2"></div>
            </div>

            <!-- MateriÃ¡ly -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-gray-300 font-bold text-sm">ğŸ“¦ MateriÃ¡ly</p>
                    <button type="button" onclick="addManualMaterial()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold">+ PÅ™idat materiÃ¡l</button>
                </div>
                <div id="manualMaterials" class="space-y-2"></div>
            </div>

            <!-- VyÃºÄtovÃ¡nÃ­ -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ’° VyÃºÄtovÃ¡nÃ­ (volitelnÃ©)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">VyÃºÄtovÃ¡no komu</label>
                    <input type="text" name="billed_to" placeholder="napÅ™. KomÃ¡rek" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum vyÃºÄtovÃ¡nÃ­</label>
                    <input type="date" name="billed_date" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ¡stka (KÄ)</label>
                    <input type="number" name="billed_amount" step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label>
                    <input type="text" name="billed_note" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>

            <div class="flex gap-3">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold text-lg transition-colors">ğŸ’¾ UloÅ¾it historickÃ½ Ãºkol</button>
                <button type="button" onclick="closeModal('modalManualTask')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>

<datalist id="warehouseDatalist"></datalist>
</body></html>`);w.document.close();setTimeout(()=>w.print(),500);
}

function expAllPDF(filterSecs){
    filterSecs=filterSecs||['all'];
    const allTsk=visibleTasks(null).filter(t=>t.status==='completed');
    const tasks=filterSecs.includes('all')?allTsk:allTsk.filter(t=>filterSecs.includes(t.section));
    const rows=tasks.map(t=>{const e=t.time_entries?JSON.parse(t.time_entries):[];const s=e.reduce((x,y)=>x+(y.duration||0),0);const labor=laborCostEntries(e);const m=t.materials?JSON.parse(t.materials):[];const matC=m.reduce((x,y)=>x+(y.qty*y.price),0);
    return `<tr><td>${t.task_number}</td><td>${t.task_name}</td><td>${t.supplier}</td><td>${t.goods_type||'-'}</td><td>${sn(t.section)}</td><td>${new Date(t.created_at).toLocaleString('cs-CZ')}</td><td>${fmt(s)}</td><td>${t.completed_pieces||0}</td><td>${(labor+matC).toFixed(2)} KÄ</td></tr>`;}).join('');
    const w=window.open('','_blank');
    w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ARDONÂ® VÃ½kazy</title><style>body{font-family:Arial,sans-serif;margin:20px}h1{color:#E30613}table{width:100%;border-collapse:collapse;font-size:11px}td,th{padding:5px 8px;border:1px solid #ddd}th{background:#f5f5f5}</style></head>
    <body><h1>ARDONÂ® Work Manager - VÃ½kazy</h1><p>${new Date().toLocaleString('cs-CZ')}</p>
    <table><tr><th>ÄŒ. Ãºkolu</th><th>NÃ¡zev</th><th>Dodavatel</th><th>Druh zboÅ¾Ã­</th><th>Ãšsek</th><th>ZadÃ¡no</th><th>ÄŒas</th><th>Kusy</th><th>NÃ¡klady</th></tr>${rows}</table>
    
<!-- WAREHOUSE MODAL -->
<div id="modalWarehouse" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">ğŸ“¦ SprÃ¡va skladu materiÃ¡lÅ¯</h2>
            <button onclick="closeModal('modalWarehouse')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <div class="p-2 border-b border-gray-800 flex">
            <button onclick="whTab('materials')" id="wt_materials" class="flex-1 py-2 text-sm font-bold rounded-lg ardon-red text-white mx-1">ğŸ“¦ MateriÃ¡l</button>
            <button onclick="whTab('logos')" id="wt_logos" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ–¨ï¸ Loga (Potisk)</button>
            <button onclick="whTab('suppliers')" id="wt_suppliers" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ­ DodavatelÃ©</button>
            <button onclick="whTab('customers')" id="wt_customers" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ‘¤ ZÃ¡kaznÃ­ci</button>
        </div>

        <!-- MATERIALS TAB -->
        <div id="whTab_materials" class="p-6 space-y-4">
            <form id="formWarehouse" onsubmit="submitWarehouseItem(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat materiÃ¡l do skladu</p>
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2"><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label><input type="text" name="name" required placeholder="napÅ™. Karton A4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Cena/kus (KÄ) *</label><input type="number" name="price" required step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Jednotka</label><select name="unit" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><option value="ks">ks</option><option value="m">m</option><option value="kg">kg</option><option value="l">l</option><option value="bal">bal</option></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Kategorie</label><input type="text" name="category" placeholder="napÅ™. Obal" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="ardon-red hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat</button>
            </form>
            <div id="warehouseList" class="space-y-2"></div>
        </div>

        <!-- LOGOS TAB (Potisk) -->
        <div id="whTab_logos" class="hidden p-6 space-y-4">
            <form id="formLogo" onsubmit="submitLogoItem(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat typ loga pro Potisk</p>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label><input type="text" name="name" required placeholder="napÅ™. Logo zÃ¡kaznÃ­ka" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Velikost</label><select name="size" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><option value="S">S - MalÃ©</option><option value="M">M - StÅ™ednÃ­</option><option value="L">L - VelkÃ©</option></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Cena/ks (KÄ) *</label><input type="number" name="price" required step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat logo</button>
            </form>
            <div id="logoList" class="space-y-2"></div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="whTab_suppliers" class="hidden p-6 space-y-4">
            <form id="formSupplier" onsubmit="submitSupplier(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat dodavatele</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev dodavatele *</label><input type="text" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Kontakt (volitelnÃ©)</label><input type="text" name="contact" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat dodavatele</button>
            </form>
            <div id="supplierList" class="space-y-2"></div>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="whTab_customers" class="hidden p-6 space-y-4">
            <form id="formCustomer" onsubmit="submitCustomer(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat zÃ¡kaznÃ­ka (Potisk)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev zÃ¡kaznÃ­ka *</label><input type="text" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label><input type="text" name="note" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-purple-700 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat zÃ¡kaznÃ­ka</button>
            </form>
            <div id="customerList" class="space-y-2"></div>
        </div>
    </div>
</div>

<!-- SELECT MATERIAL MODAL -->
<div id="modalSelectMat" class="hidden fixed inset-0 modal-bg z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-5 border-b border-gray-800">
            <h2 class="text-lg font-bold">ğŸ“¦ Vybrat materiÃ¡l ze skladu</h2>
            <button onclick="closeModal('modalSelectMat')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <div class="p-5 space-y-3">
            <input type="text" id="matSearchInput" onkeyup="filterWarehouse()" placeholder="Hledat materiÃ¡l..." class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm">
            <div id="matSelectList" class="space-y-2"></div>
            <div id="matQtySection" class="hidden bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-white font-semibold" id="matSelectedName"></p>
                <div class="flex items-center gap-3">
                    <div class="flex-1"><label class="block text-gray-400 text-xs mb-1">MnoÅ¾stvÃ­</label><input type="number" id="matQtyInput" value="1" min="1" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                    <div class="flex-1"><label class="block text-gray-400 text-xs mb-1">Cena/ks</label><input type="number" id="matPriceInput" step="0.01" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                </div>
                <button onclick="confirmSelectMat()" class="w-full ardon-red hover:bg-red-700 text-white py-2 rounded-lg font-bold">âœ… PÅ™idat k Ãºkolu</button>
            </div>
        </div>
    </div>
</div>


<!-- EDIT TASK MODAL -->
<div id="modalEditTask" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">âœï¸ Upravit Ãºkol</h2>
            <button onclick="closeModal('modalEditTask')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formEditTask" onsubmit="submitEditTask(event)" class="p-6 space-y-4">
            <input type="hidden" name="task_id" id="editTaskId">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒÃ­slo Ãºkolu</label><input type="text" name="task_number" id="edit_task_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev Ãºkolu</label><input type="text" name="task_name" id="edit_task_name" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Dodavatel</label><input type="text" name="supplier" id="edit_supplier" list="suppliersList" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev / Logo / Popis</label><input type="text" name="goods_type" id="edit_goods_type" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒ. objednÃ¡vky</label><input type="text" name="order_number" id="edit_order_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒ. avÃ­za</label><input type="text" name="aviso_number" id="edit_aviso_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Popis prÃ¡ce</label><textarea name="description" id="edit_description" rows="2" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none resize-none"></textarea></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Priorita</label>
                <select name="priority" id="edit_priority" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="0">Bez priority</option>
                    <option value="1">ğŸ”´ Priorita 1 - UrgentnÃ­</option>
                    <option value="2">ğŸŸ¡ Priorita 2 - StÅ™ednÃ­</option>
                    <option value="3">ğŸŸ¢ Priorita 3 - NormÃ¡lnÃ­</option>
                </select></div>
                <div><label class="block text-gray-400 text-sm mb-1">Stav</label>
                <select name="status" id="edit_status" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="pending">â³ ÄŒekÃ¡</option>
                    <option value="inProgress">â–¶ï¸ ProbÃ­hÃ¡</option>
                    <option value="completed">âœ… DokonÄeno</option>
                </select></div>
            </div>
            <div>
                <label class="block text-gray-400 text-sm mb-1">ğŸ‘¥ PÅ™iÅ™adit zamÄ›stnancÅ¯m <span class="text-gray-500 text-xs">(Ctrl+klik = vÃ­ce)</span></label>
                <select name="assigned_to" id="edit_assigned_to" multiple class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none h-36">
                </select>
                <p class="text-gray-600 text-xs mt-1">PodrÅ¾te Ctrl (nebo Cmd na Mac) pro vÃ½bÄ›r vÃ­ce zamÄ›stnancÅ¯. <span class="text-yellow-500">Bez vÃ½bÄ›ru = vidÃ­ vÅ¡ichni zamÄ›stnanci Ãºseku.</span></p>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Norma (ks/hod)</label><input type="number" name="norm" id="edit_norm" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold transition-colors">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
                <button type="button" onclick="closeModal('modalEditTask')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>


<!-- MANUAL/HISTORICAL TASK MODAL -->
<div id="modalManualTask" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[95vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <div>
                <h2 class="text-xl font-bold">ğŸ“‹ HistorickÃ½ / archivnÃ­ Ãºkol</h2>
                <p class="text-gray-500 text-sm mt-1">RuÄnÃ­ zadÃ¡nÃ­ dokonÄenÃ©ho Ãºkolu s vlastnÃ­mi Äasy a materiÃ¡ly</p>
            </div>
            <button onclick="closeModal('modalManualTask')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formManualTask" onsubmit="submitManualTask(event)" class="p-6 space-y-5">

            <!-- ZÃ¡kladnÃ­ info -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ“ ZÃ¡kladnÃ­ informace</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ­slo Ãºkolu *</label>
                    <input type="text" name="task_number" required placeholder="napÅ™. 41" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev Ãºkolu *</label>
                    <input type="text" name="task_name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Dodavatel</label>
                    <input type="text" name="supplier" list="suppliersList" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev / Logo / Popis</label>
                    <input type="text" name="goods_type" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒ. objednÃ¡vky</label>
                    <input type="text" name="order_number" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒ. avÃ­za</label>
                    <input type="text" name="aviso_number" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ZÃ¡kaznÃ­k (Potisk)</label>
                    <input type="text" name="customer" list="customersList" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Ãšsek *</label>
                    <select name="section" id="manualSection" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                        <option value="exqc">ExQC</option>
                        <option value="blistrovani">BlistrovÃ¡nÃ­</option>
                        <option value="potisk">Potisk</option><option value="prijem">PÅ™Ã­jem</option><option value="extra_prace">Extra prÃ¡ce</option>
                        <option value="prace_z_domu">PrÃ¡ce z domu</option>
                        <option value="grafika">Grafika</option>
                    </select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Priorita</label>
                    <select name="priority" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                        <option value="0">Bez priority</option>
                        <option value="1">ğŸ”´ P1 - UrgentnÃ­</option>
                        <option value="2">ğŸŸ¡ P2 - StÅ™ednÃ­</option>
                        <option value="3">ğŸŸ¢ P3 - NormÃ¡lnÃ­</option>
                    </select></div>
                </div>
                <div><label class="block text-gray-500 text-xs mb-1">Popis prÃ¡ce</label>
                <textarea name="description" rows="2" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm resize-none"></textarea></div>
            </div>

            <!-- Kdo a kdy -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ‘¤ Kdo a kdy</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Zadal/a Ãºkol</label>
                    <select name="created_by_manual" id="manualCreatedBy" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum zadÃ¡nÃ­</label>
                    <input type="datetime-local" name="created_at_manual" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Datum dokonÄenÃ­</label>
                    <input type="datetime-local" name="completed_at_manual" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoÄet kusÅ¯</label>
                    <input type="number" name="completed_pieces" placeholder="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>

            <!-- ÄŒasy zamÄ›stnancÅ¯ -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-gray-300 font-bold text-sm">â±ï¸ ÄŒasy zamÄ›stnancÅ¯</p>
                    <button type="button" onclick="addManualTimeEntry()" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold">+ PÅ™idat Äas</button>
                </div>
                <p class="text-gray-600 text-xs">PÅ™idej Äas pro kaÅ¾dÃ©ho zamÄ›stnance kterÃ½ na Ãºkolu pracoval</p>
                <div id="manualTimeEntries" class="space-y-2"></div>
            </div>

            <!-- MateriÃ¡ly -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-gray-300 font-bold text-sm">ğŸ“¦ MateriÃ¡ly</p>
                    <button type="button" onclick="addManualMaterial()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold">+ PÅ™idat materiÃ¡l</button>
                </div>
                <div id="manualMaterials" class="space-y-2"></div>
            </div>

            <!-- VyÃºÄtovÃ¡nÃ­ -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ’° VyÃºÄtovÃ¡nÃ­ (volitelnÃ©)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">VyÃºÄtovÃ¡no komu</label>
                    <input type="text" name="billed_to" placeholder="napÅ™. KomÃ¡rek" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum vyÃºÄtovÃ¡nÃ­</label>
                    <input type="date" name="billed_date" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ¡stka (KÄ)</label>
                    <input type="number" name="billed_amount" step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label>
                    <input type="text" name="billed_note" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>

            <div class="flex gap-3">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold text-lg transition-colors">ğŸ’¾ UloÅ¾it historickÃ½ Ãºkol</button>
                <button type="button" onclick="closeModal('modalManualTask')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>

<datalist id="warehouseDatalist"></datalist>
</body></html>`);w.document.close();setTimeout(()=>w.print(),500);
}


async function submitUser(ev){
    ev.preventDefault();
    const fd = new FormData(ev.target);
    const editId = ev.target.dataset.editId ? parseInt(ev.target.dataset.editId) : null;

    // Collect sections
    const secSelect = document.getElementById('userSectionSelect');
    const selectedSecs = Array.from(secSelect.selectedOptions).map(o=>o.value);
    const section = selectedSecs.includes('all') ? 'all' : selectedSecs.join(',') || 'all';

    const userData = {
        full_name: fd.get('full_name'),
        username: fd.get('username'),
        password: fd.get('password'),
        hourly_rate: parseFloat(fd.get('hourly_rate'))||180,
        role: fd.get('role'),
        section: section,
        email: fd.get('email')||''
    };

    if(editId){
        // UPDATE existing user - pouÅ¾ij db klient stejnÄ› jako zbytek aplikace
        let dbOk = false;
        try{
            const {data, error} = await db.from('users').update(userData).eq('id', editId).select();
            if(error){ console.log('Supabase error:', error); throw new Error(error.message); }
            dbOk = true;
            if(data && data[0]){
                const idx = USERS.findIndex(u=>u.id===editId);
                if(idx!==-1) USERS[idx] = data[0];
            }
        } catch(e){
            console.log('DB update error:', e);
            const idx = USERS.findIndex(u=>u.id===editId);
            if(idx!==-1) USERS[idx] = {...USERS[idx], ...userData};
        }
        // If editing yourself, update CU so you don't get logged out
        if(CU.id === editId){
            CU = {...CU, ...userData};
            document.getElementById('sbName').textContent = CU.full_name;
            document.getElementById('sbRole').textContent = tx(CU.role);
        }
        notify(dbOk ? 'âœ… UÅ¾ivatel upraven a uloÅ¾en!' : 'âš ï¸ UloÅ¾eno lokÃ¡lnÄ› - zkontroluj pÅ™ipojenÃ­');
    } else {
        // INSERT new user
        const newUser = {...userData, created_at: new Date().toISOString()};
        let insOk = false;
        try{
            const {data, error} = await db.from('users').insert([newUser]).select();
            if(error){ console.log('Supabase insert error:', error); throw new Error(error.message); }
            insOk = true;
            if(data && data[0]) USERS.push(data[0]);
            else USERS.push(newUser);
        } catch(e){
            console.log('Insert error:', e);
            newUser.id = Date.now();
            USERS.push(newUser);
        }
        notify(insOk ? 'âœ… UÅ¾ivatel pÅ™idÃ¡n a uloÅ¾en!' : 'âš ï¸ UloÅ¾eno lokÃ¡lnÄ› - zkontroluj pÅ™ipojenÃ­');
    }

    saveLoc();
    closeModal('modalUser');
    // Reset editId
    ev.target.dataset.editId = '';
    document.querySelector('#modalUser h2').textContent = 'PÅ™idat uÅ¾ivatele';
    showView('users');
}

function editUser(uid){
    const u=USERS.find(x=>x.id===uid);
    if(!u)return;
    document.getElementById('formUser').reset();
    document.querySelector('#formUser [name="full_name"]').value=u.full_name||'';
    document.querySelector('#formUser [name="username"]').value=u.username||'';
    document.querySelector('#formUser [name="password"]').value=u.password||'';
    document.querySelector('#formUser [name="hourly_rate"]').value=u.hourly_rate||180;
    document.querySelector('#formUser [name="role"]').value=u.role||'employee';
    // Handle multiple sections
    const secSelect=document.getElementById('userSectionSelect');
    const userSecs=(u.section||'all').split(',');
    Array.from(secSelect.options).forEach(opt=>{opt.selected=userSecs.includes(opt.value);});
    document.querySelector('#formUser [name="email"]').value=u.email||'';
    document.getElementById('formUser').dataset.editId=uid;
    document.querySelector('#modalUser h2').textContent='Upravit uÅ¾ivatele';
    document.getElementById('modalUser').classList.remove('hidden');
}

async function deleteUser(uid){
    const u=USERS.find(x=>x.id===uid);
    if(!u)return;
    if(!confirm('Opravdu smazat uÅ¾ivatele "'+u.full_name+'"?'))return;
    try{await db.from('users').delete().eq('id',uid);}catch(e){console.log(e);}
    USERS=USERS.filter(x=>x.id!==uid);
    saveLoc();
    showView('users');
    notify('ğŸ—‘ï¸ UÅ¾ivatel byl smazÃ¡n!');
}

// ==================== WAREHOUSE ====================
let WAREHOUSE = [];

async function loadWarehouse(){
    try{
        const {data}=await db.from('warehouse').select('*').order('name');
        if(data)WAREHOUSE=data;
    }catch(e){
        WAREHOUSE=JSON.parse(localStorage.getItem('wh')||'[]');
    }
}

function openWarehouse(){
    Promise.all([loadWarehouse(), loadSuppliers(), loadCustomers(), loadLogos()]).then(()=>renderWarehouseList());
    document.getElementById('modalWarehouse').classList.remove('hidden');
}

function renderWarehouseList(){
    // Update datalist for manual task material autocomplete
    const dl = document.getElementById('warehouseDatalist');
    if(dl) dl.innerHTML = WAREHOUSE.map(w=>`<option value="${w.name}">`).join('');

    const el=document.getElementById('warehouseList');
    if(!WAREHOUSE||WAREHOUSE.length===0){el.innerHTML='<p class="text-gray-500 text-center py-4">Sklad je prÃ¡zdnÃ½</p>';return;}
    el.innerHTML=`<div class="bg-gray-800 rounded-xl overflow-hidden"><table class="w-full text-sm">
        <thead class="bg-gray-700"><tr>
            <th class="text-left p-3 text-gray-400">NÃ¡zev</th>
            <th class="text-left p-3 text-gray-400">Kategorie</th>
            <th class="text-left p-3 text-gray-400">Cena/ks</th>
            <th class="text-left p-3 text-gray-400">Jednotka</th>
            <th class="p-3 text-gray-400">Akce</th>
        </tr></thead><tbody>
        ${WAREHOUSE.map(w=>`<tr class="border-t border-gray-700">
            <td class="p-3 text-white font-medium">${w.name}</td>
            <td class="p-3 text-gray-400">${w.category||'-'}</td>
            <td class="p-3 text-white font-bold">${w.price} KÄ</td>
            <td class="p-3 text-gray-400">${w.unit||'ks'}</td>
            <td class="p-3 text-center"><button onclick="deleteWarehouseItem(${w.id})" class="bg-red-800 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button></td>
        </tr>`).join('')}
        </tbody></table></div>`;
}

async function submitWarehouseItem(ev){
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const item={name:fd.get('name'),price:parseFloat(fd.get('price')),unit:fd.get('unit'),category:fd.get('category'),created_at:new Date().toISOString()};
    try{
        const {data,error}=await db.from('warehouse').insert([item]).select();
        if(data&&data[0])WAREHOUSE.push(data[0]);else throw error;
    }catch(e){
        item.id=Date.now();WAREHOUSE.push(item);
        localStorage.setItem('wh',JSON.stringify(WAREHOUSE));
    }
    ev.target.reset();
    renderWarehouseList();
    notify('ğŸ“¦ MateriÃ¡l pÅ™idÃ¡n do skladu!');
}

async function deleteWarehouseItem(wid){
    if(!confirm('Smazat materiÃ¡l ze skladu?'))return;
    try{await db.from('warehouse').delete().eq('id',wid);}catch(e){}
    WAREHOUSE=WAREHOUSE.filter(w=>w.id!==wid);
    localStorage.setItem('wh',JSON.stringify(WAREHOUSE));
    renderWarehouseList();
    notify('ğŸ—‘ï¸ MateriÃ¡l smazÃ¡n!');
}

async function saveHiddenCosts(tid){
    const extraTime=parseFloat(document.getElementById('hext_'+tid)?.value)||0;
    const extraCost=parseFloat(document.getElementById('hexc_'+tid)?.value)||0;
    const extraNote=document.getElementById('hexn_'+tid)?.value||'';
    await updDB(tid,{hidden_extra_time:extraTime,hidden_extra_cost:extraCost,hidden_extra_note:extraNote});
    openDetail(tid);
    notify('ğŸ”’ SkrytÃ© nÃ¡klady uloÅ¾eny!');
}

async function saveBilling(tid){
    const billing={
        billed_to:document.getElementById('bt_'+tid)?.value||'',
        billed_date:document.getElementById('bd_'+tid)?.value||'',
        billed_amount:parseFloat(document.getElementById('ba_'+tid)?.value)||0,
        billed_note:document.getElementById('bn_'+tid)?.value||''
    };
    await updDB(tid,{billing:JSON.stringify(billing)});
    openDetail(tid);
    notify('ğŸ’° VyÃºÄtovÃ¡nÃ­ uloÅ¾eno!');
}


// ==================== SUPPLIERS & CUSTOMERS ====================
let SUPPLIERS = [];
let CUSTOMERS = [];
let LOGOS = [];

async function loadSuppliers(){
    try{const{data}=await db.from('suppliers').select('*').order('name');if(data)SUPPLIERS=data;}
    catch(e){SUPPLIERS=JSON.parse(localStorage.getItem('supp')||'[]');}
    updateSupplierDatalist();
}

async function loadCustomers(){
    try{const{data}=await db.from('customers').select('*').order('name');if(data)CUSTOMERS=data;}
    catch(e){CUSTOMERS=JSON.parse(localStorage.getItem('cust')||'[]');}
    updateCustomerDatalist();
}

async function loadLogos(){
    try{const{data}=await db.from('logos').select('*').order('name');if(data)LOGOS=data;}
    catch(e){LOGOS=JSON.parse(localStorage.getItem('logos')||'[]');}
}

function updateSupplierDatalist(){
    const dl=document.getElementById('suppliersList');
    if(dl)dl.innerHTML=SUPPLIERS.map(s=>`<option value="${s.name}">`).join('');
}

function updateCustomerDatalist(){
    const dl=document.getElementById('customersList');
    if(dl)dl.innerHTML=CUSTOMERS.map(c=>`<option value="${c.name}">`).join('');
}

function toggleSectionFields(sec){
    const cf=document.getElementById('customerFieldWrap');
    if(cf){
        if(sec==='potisk')cf.classList.remove('hidden');
        else cf.classList.add('hidden');
    }
    const rf=document.getElementById('receiptFields');
    if(rf){
        if(sec==='prijem') rf.classList.remove('hidden');
        else rf.classList.add('hidden');
    }
    const ef=document.getElementById('extraWorkFields');
    if(ef){
        if(sec==='extra_prace') ef.classList.remove('hidden');
        else ef.classList.add('hidden');
    }
}

function whTab(tab){
    ['materials','logos','suppliers','customers'].forEach(t=>{
        const el=document.getElementById('whTab_'+t);
        const btn=document.getElementById('wt_'+t);
        if(el)el.classList.add('hidden');
        if(btn){btn.classList.remove('ardon-red','text-white');btn.classList.add('bg-gray-800','text-gray-300');}
    });
    const active=document.getElementById('whTab_'+tab);
    const activBtn=document.getElementById('wt_'+tab);
    if(active)active.classList.remove('hidden');
    if(activBtn){activBtn.classList.add('ardon-red','text-white');activBtn.classList.remove('bg-gray-800','text-gray-300');}
    if(tab==='suppliers')renderSupplierList();
    if(tab==='customers')renderCustomerList();
    if(tab==='logos')renderLogoList();
}

async function submitSupplier(ev){
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const item={name:fd.get('name'),contact:fd.get('contact'),created_at:new Date().toISOString()};
    try{const{data}=await db.from('suppliers').insert([item]).select();if(data&&data[0])SUPPLIERS.push(data[0]);else throw '';}
    catch(e){item.id=Date.now();SUPPLIERS.push(item);localStorage.setItem('supp',JSON.stringify(SUPPLIERS));}
    updateSupplierDatalist();
    ev.target.reset();renderSupplierList();notify('âœ… Dodavatel pÅ™idÃ¡n!');
}

async function submitCustomer(ev){
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const item={name:fd.get('name'),note:fd.get('note'),created_at:new Date().toISOString()};
    try{const{data}=await db.from('customers').insert([item]).select();if(data&&data[0])CUSTOMERS.push(data[0]);else throw '';}
    catch(e){item.id=Date.now();CUSTOMERS.push(item);localStorage.setItem('cust',JSON.stringify(CUSTOMERS));}
    updateCustomerDatalist();
    ev.target.reset();renderCustomerList();notify('âœ… ZÃ¡kaznÃ­k pÅ™idÃ¡n!');
}

async function submitLogoItem(ev){
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const item={name:fd.get('name'),size:fd.get('size'),price:parseFloat(fd.get('price')),unit:'ks',category:'logo',created_at:new Date().toISOString()};
    try{const{data}=await db.from('logos').insert([item]).select();if(data&&data[0])LOGOS.push(data[0]);else throw '';}
    catch(e){item.id=Date.now();LOGOS.push(item);localStorage.setItem('logos',JSON.stringify(LOGOS));}
    ev.target.reset();renderLogoList();notify('âœ… Logo pÅ™idÃ¡no!');
}

function renderSupplierList(){
    const el=document.getElementById('supplierList');
    if(!el)return;
    if(!SUPPLIERS.length){el.innerHTML='<p class="text-gray-500 text-sm text-center py-4">Å½Ã¡dnÃ­ dodavatelÃ©</p>';return;}
    // Show supplier costs from tasks
    const costs={};
    TASKS.forEach(t=>{
        if(!t.supplier)return;
        const e=t.time_entries?JSON.parse(t.time_entries):[];
        const s=e.reduce((x,y)=>x+(y.duration||0),0);
        const m=t.materials?JSON.parse(t.materials):[];
        const cost=laborCostEntries(e)+m.reduce((x,y)=>x+(y.qty*y.price),0);
        costs[t.supplier]=(costs[t.supplier]||0)+cost;
    });
    const sorted=[...SUPPLIERS].sort((a,b)=>(costs[b.name]||0)-(costs[a.name]||0));
    el.innerHTML=`<div class="bg-gray-800 rounded-xl overflow-hidden"><table class="w-full text-sm">
        <thead class="bg-gray-700"><tr><th class="text-left p-3 text-gray-400">Dodavatel</th><th class="text-left p-3 text-gray-400">Kontakt</th><th class="text-left p-3 text-gray-400">CelkovÃ© nÃ¡klady</th><th class="p-3"></th></tr></thead><tbody>
        ${sorted.map(s=>`<tr class="border-t border-gray-700">
            <td class="p-3 text-white font-medium">${s.name}</td>
            <td class="p-3 text-gray-400">${s.contact||'-'}</td>
            <td class="p-3 font-bold ${costs[s.name]>0?'text-red-400':''}">${costs[s.name]?(costs[s.name]).toFixed(2)+' KÄ':'-'}</td>
            <td class="p-3"><button onclick="deleteSupplier(${s.id})" class="bg-red-800 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button></td>
        </tr>`).join('')}
        </tbody></table></div>`;
}

function renderCustomerList(){
    const el=document.getElementById('customerList');
    if(!el)return;
    if(!CUSTOMERS.length){el.innerHTML='<p class="text-gray-500 text-sm text-center py-4">Å½Ã¡dnÃ­ zÃ¡kaznÃ­ci</p>';return;}
    const orders={};
    TASKS.filter(t=>t.section==='potisk'&&t.customer).forEach(t=>{orders[t.customer]=(orders[t.customer]||0)+1;});
    const sorted=[...CUSTOMERS].sort((a,b)=>(orders[b.name]||0)-(orders[a.name]||0));
    el.innerHTML=`<div class="bg-gray-800 rounded-xl overflow-hidden"><table class="w-full text-sm">
        <thead class="bg-gray-700"><tr><th class="text-left p-3 text-gray-400">ZÃ¡kaznÃ­k</th><th class="text-left p-3 text-gray-400">PoznÃ¡mka</th><th class="text-left p-3 text-gray-400">PoÄet zakÃ¡zek</th><th class="p-3"></th></tr></thead><tbody>
        ${sorted.map(c=>`<tr class="border-t border-gray-700">
            <td class="p-3 text-white font-medium">${c.name}</td>
            <td class="p-3 text-gray-400">${c.note||'-'}</td>
            <td class="p-3 font-bold ${orders[c.name]>0?'text-blue-400':''}">${orders[c.name]||0}</td>
            <td class="p-3"><button onclick="deleteCustomer(${c.id})" class="bg-red-800 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button></td>
        </tr>`).join('')}
        </tbody></table></div>`;
}

function renderLogoList(){
    const el=document.getElementById('logoList');
    if(!el)return;
    if(!LOGOS.length){el.innerHTML='<p class="text-gray-500 text-sm text-center py-4">Å½Ã¡dnÃ¡ loga</p>';return;}
    el.innerHTML=`<div class="bg-gray-800 rounded-xl overflow-hidden"><table class="w-full text-sm">
        <thead class="bg-gray-700"><tr><th class="text-left p-3 text-gray-400">NÃ¡zev</th><th class="text-left p-3 text-gray-400">Velikost</th><th class="text-left p-3 text-gray-400">Cena/ks</th><th class="p-3"></th></tr></thead><tbody>
        ${LOGOS.map(l=>`<tr class="border-t border-gray-700">
            <td class="p-3 text-white">${l.name}</td>
            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${l.size==='L'?'bg-red-900/40 text-red-400':l.size==='M'?'bg-yellow-900/40 text-yellow-400':'bg-green-900/40 text-green-400'}">${l.size}</span></td>
            <td class="p-3 font-bold text-white">${l.price} KÄ</td>
            <td class="p-3"><button onclick="deleteLogo(${l.id})" class="bg-red-800 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button></td>
        </tr>`).join('')}
        </tbody></table></div>`;
}

async function deleteSupplier(id){
    if(!confirm('Smazat dodavatele?'))return;
    try{await db.from('suppliers').delete().eq('id',id);}catch(e){}
    SUPPLIERS=SUPPLIERS.filter(s=>s.id!==id);localStorage.setItem('supp',JSON.stringify(SUPPLIERS));
    renderSupplierList();notify('ğŸ—‘ï¸ Dodavatel smazÃ¡n!');
}

async function deleteCustomer(id){
    if(!confirm('Smazat zÃ¡kaznÃ­ka?'))return;
    try{await db.from('customers').delete().eq('id',id);}catch(e){}
    CUSTOMERS=CUSTOMERS.filter(c=>c.id!==id);localStorage.setItem('cust',JSON.stringify(CUSTOMERS));
    renderCustomerList();notify('ğŸ—‘ï¸ ZÃ¡kaznÃ­k smazÃ¡n!');
}

async function deleteLogo(id){
    if(!confirm('Smazat logo?'))return;
    try{await db.from('logos').delete().eq('id',id);}catch(e){}
    LOGOS=LOGOS.filter(l=>l.id!==id);localStorage.setItem('logos',JSON.stringify(LOGOS));
    renderLogoList();notify('ğŸ—‘ï¸ Logo smazÃ¡no!');
}

// Logo selector for Potisk tasks
function openSelectLogo(tid){
    currentMatTaskId=tid;
    selectedWarehouseItem=null;
    document.getElementById('matQtySection').classList.add('hidden');
    document.getElementById('matSearchInput').value='';
    renderLogoSelectList(LOGOS);
    document.getElementById('modalSelectMat').classList.remove('hidden');
}

function renderLogoSelectList(items){
    const el=document.getElementById('matSelectList');
    if(!items||!items.length){el.innerHTML='<p class="text-gray-500 text-center py-4">Å½Ã¡dnÃ¡ loga - pÅ™idej v Sklad materiÃ¡lÅ¯ â†’ Loga</p>';return;}
    el.innerHTML=items.map(l=>`
        <div onclick="selectWarehouseItem(${l.id})" class="bg-gray-800 hover:bg-gray-700 p-3 rounded-xl cursor-pointer transition-colors border border-gray-700 hover:border-blue-500">
            <div class="flex justify-between items-center">
                <div><p class="text-white font-semibold">${l.name}</p><span class="px-2 py-0.5 rounded text-xs font-bold ${l.size==='L'?'bg-red-900/40 text-red-400':l.size==='M'?'bg-yellow-900/40 text-yellow-400':'bg-green-900/40 text-green-400'}">${l.size==='S'?'MalÃ©':l.size==='M'?'StÅ™ednÃ­':'VelkÃ©'}</span></div>
                <p class="text-white font-bold">${l.price} KÄ/ks</p>
            </div>
        </div>`).join('');
    // Override selectWarehouseItem to work with logos too
    LOGOS.forEach(l=>{ if(!WAREHOUSE.find(w=>w.id===l.id)) WAREHOUSE.push(l); });
}


function openEditTask(tid){
    const task = TASKS.find(t=>t.id===tid);
    if(!task) return;
    
    // Fill form fields
    document.getElementById('editTaskId').value = tid;
    document.getElementById('edit_task_number').value = task.task_number||'';
    document.getElementById('edit_task_name').value = task.task_name||'';
    document.getElementById('edit_supplier').value = task.supplier||'';
    document.getElementById('edit_goods_type').value = task.goods_type||'';
    document.getElementById('edit_order_number').value = task.order_number||'';
    document.getElementById('edit_aviso_number').value = task.aviso_number||'';
    document.getElementById('edit_description').value = task.description||'';
    document.getElementById('edit_priority').value = task.priority||0;
    document.getElementById('edit_status').value = task.status||'pending';
    document.getElementById('edit_norm').value = task.norm||'';
    
    // Fill assigned_to multiselect - show ALL employees
    const sel = document.getElementById('edit_assigned_to');
    const currentAssigned = task.assigned_to ? JSON.parse(task.assigned_to) : [];
    
    // For manager - show employees from their section
    // For admin - show all employees
    let availableUsers = USERS.filter(u => u.role === 'employee');
    if(CU.role === 'manager') {
        const managerSecs = (CU.section||'all').split(',');
        if(!managerSecs.includes('all')) {
            availableUsers = USERS.filter(u => {
                if(u.role !== 'employee') return false;
                const userSecs = (u.section||'').split(',');
                return userSecs.some(s => managerSecs.includes(s));
            });
        }
    }
    
    sel.innerHTML = availableUsers.map(u => {
        const isSelected = currentAssigned.includes(u.id);
        const userSecs = (u.section||'').split(',').map(s=>sn(s)).join(', ');
        return `<option value="${u.id}" ${isSelected?'selected':''}>${u.full_name} â€” ${userSecs}</option>`;
    }).join('');
    
    closeModal('modalDetail');
    document.getElementById('modalEditTask').classList.remove('hidden');
}

async function submitEditTask(ev){
    ev.preventDefault();
    const fd = new FormData(ev.target);
    const tid = parseInt(document.getElementById('editTaskId').value);
    const assignedTo = Array.from(ev.target.assigned_to.selectedOptions).map(o=>parseInt(o.value));
    
    const updates = {
        task_number: fd.get('task_number'),
        task_name: fd.get('task_name'),
        supplier: fd.get('supplier'),
        goods_type: fd.get('goods_type'),
        order_number: fd.get('order_number'),
        aviso_number: fd.get('aviso_number'),
        description: fd.get('description'),
        priority: parseInt(fd.get('priority'))||0,
        status: fd.get('status'),
        norm: fd.get('norm') ? parseFloat(fd.get('norm')) : null,
        assigned_to: JSON.stringify(assignedTo),
    };
    
    await updDB(tid, updates);
    closeModal('modalEditTask');
    await loadData();
    showView(VIEW);
    notify('âœ… Ãškol upraven!');
}


// ==================== MANUAL/HISTORICAL TASK ====================
let manualTimeEntries = [];
let manualMaterials = [];

function openManualTask(sec){
    manualTimeEntries = [];
    manualMaterials = [];
    document.getElementById('formManualTask').reset();
    document.getElementById('manualTimeEntries').innerHTML = '';
    document.getElementById('manualMaterials').innerHTML = '';

    // Set section
    if(sec && sec !== 'tasks') document.getElementById('manualSection').value = sec;

    // Fill created_by with all users
    const cb = document.getElementById('manualCreatedBy');
    cb.innerHTML = USERS.map(u => `<option value="${u.id}" ${u.id===CU.id?'selected':''}>${u.full_name} (${tx(u.role)})</option>`).join('');

    // Set default dates to today
    const now = new Date();
    const localNow = new Date(now - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
    document.querySelector('#formManualTask [name="created_at_manual"]').value = localNow;
    document.querySelector('#formManualTask [name="completed_at_manual"]').value = localNow;

    document.getElementById('modalManualTask').classList.remove('hidden');
}

function addManualTimeEntry(){
    const id = Date.now();
    manualTimeEntries.push(id);
    const div = document.createElement('div');
    div.id = 'mte_' + id;
    div.className = 'bg-gray-700 rounded-xl p-3 space-y-2';
    div.innerHTML = `
        <div class="flex justify-between items-center">
            <p class="text-gray-400 text-xs font-semibold">ZÃ¡znam prÃ¡ce</p>
            <button type="button" onclick="document.getElementById('mte_${id}').remove()" class="text-red-400 hover:text-red-300 text-xs">âœ• Odebrat</button>
        </div>
        <div class="grid grid-cols-3 gap-2">
            <div><label class="block text-gray-500 text-xs mb-1">ZamÄ›stnanec *</label>
            <select name="mte_user_${id}" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                ${USERS.filter(u=>u.role==='employee').map(u=>`<option value="${u.id}">${u.full_name}</option>`).join('')}
            </select></div>
            <div><label class="block text-gray-500 text-xs mb-1">ÄŒas prÃ¡ce (hod) *</label>
            <input type="number" name="mte_hours_${id}" step="0.25" min="0" placeholder="napÅ™. 2.5" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
            <div><label class="block text-gray-500 text-xs mb-1">Datum prÃ¡ce</label>
            <input type="date" name="mte_date_${id}" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
        </div>`;
    document.getElementById('manualTimeEntries').appendChild(div);
}

function addManualMaterial(){
    const id = Date.now();
    manualMaterials.push(id);
    const div = document.createElement('div');
    div.id = 'mmat_' + id;
    div.className = 'bg-gray-700 rounded-xl p-3';
    div.innerHTML = `
        <div class="flex justify-between items-center mb-2">
            <p class="text-gray-400 text-xs font-semibold">MateriÃ¡l</p>
            <button type="button" onclick="document.getElementById('mmat_${id}').remove()" class="text-red-400 hover:text-red-300 text-xs">âœ• Odebrat</button>
        </div>
        <div class="grid grid-cols-4 gap-2">
            <div class="col-span-2"><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label>
            <input type="text" name="mmat_name_${id}" list="warehouseDatalist" placeholder="nÃ¡zev materiÃ¡lu" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
            <div><label class="block text-gray-500 text-xs mb-1">MnoÅ¾stvÃ­ *</label>
            <input type="number" name="mmat_qty_${id}" step="0.1" min="0" placeholder="1" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
            <div><label class="block text-gray-500 text-xs mb-1">Cena/ks (KÄ)</label>
            <input type="number" name="mmat_price_${id}" step="0.01" min="0" placeholder="0" class="w-full px-2 py-1.5 bg-gray-600 border border-gray-500 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
        </div>`;
    document.getElementById('manualMaterials').appendChild(div);
}

async function submitManualTask(ev){
    ev.preventDefault();
    const fd = new FormData(ev.target);

    // Collect time entries from dynamic fields
    const timeEntries = [];
    document.querySelectorAll('[id^="mte_"]').forEach(el => {
        const id = el.id.replace('mte_','');
        const userId = parseInt(fd.get('mte_user_'+id));
        const hours = parseFloat(fd.get('mte_hours_'+id));
        const date = fd.get('mte_date_'+id);
        if(userId && hours > 0){
            timeEntries.push({
                userId: userId,
                duration: Math.round(hours * 3600),
                ts: date ? new Date(date).toISOString() : new Date().toISOString(),
                note: 'HistorickÃ½ zÃ¡znam'
            });
        }
    });

    // Collect materials
    const materials = [];
    document.querySelectorAll('[id^="mmat_"]').forEach(el => {
        const id = el.id.replace('mmat_','');
        const name = fd.get('mmat_name_'+id);
        const qty = parseFloat(fd.get('mmat_qty_'+id));
        const price = parseFloat(fd.get('mmat_price_'+id))||0;
        if(name && qty > 0){
            materials.push({name, qty, price, unit:'ks'});
        }
    });

    // Billing
    const billing = {
        billed_to: fd.get('billed_to')||'',
        billed_date: fd.get('billed_date')||'',
        billed_amount: parseFloat(fd.get('billed_amount'))||0,
        billed_note: fd.get('billed_note')||''
    };

    const createdByManual = parseInt(fd.get('created_by_manual'))||CU.id;
    const createdAt = fd.get('created_at_manual') ? new Date(fd.get('created_at_manual')).toISOString() : new Date().toISOString();
    const completedAt = fd.get('completed_at_manual') ? new Date(fd.get('completed_at_manual')).toISOString() : new Date().toISOString();

    const newTask = {
        task_number: fd.get('task_number'),
        task_name: fd.get('task_name'),
        supplier: fd.get('supplier')||'',
        goods_type: fd.get('goods_type')||'',
        order_number: fd.get('order_number')||'',
        aviso_number: fd.get('aviso_number')||'',
        customer: fd.get('customer')||'',
        description: fd.get('description')||'',
        section: fd.get('section'),
        priority: parseInt(fd.get('priority'))||0,
        status: 'completed',
        created_by: createdByManual,
        created_at: createdAt,
        completed_at: completedAt,
        completed_pieces: parseInt(fd.get('completed_pieces'))||0,
        time_entries: JSON.stringify(timeEntries),
        materials: JSON.stringify(materials),
        billing: JSON.stringify(billing),
        assigned_to: '[]',
        active_workers: '[]',
        transport_time: 0,
        hidden_extra_time: 0,
        hidden_extra_cost: 0,
        hidden_extra_note: ''
    };

    try{
        const {data,error} = await db.from('tasks').insert([newTask]).select();
        if(data && data[0]) TASKS.unshift(data[0]);
        else throw error;
    } catch(e){
        newTask.id = Date.now();
        TASKS.unshift(newTask);
        saveLoc();
    }

    closeModal('modalManualTask');
    showView(VIEW);
    notify('âœ… HistorickÃ½ Ãºkol uloÅ¾en do vÃ½kazÅ¯!');
}

function expSinglePDF(tid){
    const t=TASKS.find(x=>x.id===tid);
    if(!t)return;
    const entries=t.time_entries?JSON.parse(t.time_entries):[];
    const mats=t.materials?JSON.parse(t.materials):[];
    const totalSec=entries.reduce((s,e)=>s+(e.duration||0),0);
    const dispPhase = (normSection(task.section)==='prijem') ? getPhase(task.id, task) : 'general';
    const dispSec = (normSection(task.section)==='prijem')
        ? entries.filter(e=>(e.phase||'general')===dispPhase).reduce((s,e)=>s+(e.duration||0),0)
        : totalSec;
    const labor=(totalSec/3600)*180;
    const matC=mats.reduce((s,m)=>s+(m.qty*m.price),0);
    const billing=t.billing?JSON.parse(t.billing):{};
    const creator=USERS.find(u=>u.id===t.created_by);
    const byDay={};
    entries.forEach(e=>{
        const day=e.ts?new Date(e.ts).toLocaleDateString('cs-CZ'):'NeznÃ¡mÃ½';
        if(!byDay[day])byDay[day]=[];
        byDay[day].push(e);
    });
    let html=`<html><head><meta charset="UTF-8"><style>
        body{font-family:Arial,sans-serif;margin:20px;color:#111;font-size:12px;}
        h1{color:#E30613;font-size:20px;margin-bottom:4px;}
        h2{font-size:14px;color:#333;border-bottom:2px solid #E30613;padding-bottom:4px;margin-top:16px;}
        .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin:8px 0;}
        .box{background:#f5f5f5;border-radius:6px;padding:8px;}
        .box p:first-child{color:#666;font-size:10px;margin:0;}
        .box p:last-child{font-weight:bold;font-size:14px;margin:0;}
        table{width:100%;border-collapse:collapse;margin-top:8px;}
        th{background:#E30613;color:white;padding:6px 8px;text-align:left;font-size:11px;}
        td{padding:5px 8px;border-bottom:1px solid #eee;}
        tr:nth-child(even) td{background:#f9f9f9;}
        .billing{background:#f0fff4;border:1px solid #86efac;border-radius:6px;padding:12px;margin-top:8px;}
    </style></head><body>
    <h1>ARDONÂ® Work Manager - Report Ãºkolu</h1>
    <p style="color:#666;font-size:11px;">VygenerovÃ¡no: ${new Date().toLocaleString('cs-CZ')}</p>
    <h2>ZÃ¡kladnÃ­ informace</h2>
    <div class="grid">
        <div class="box"><p>ÄŒÃ­slo Ãºkolu</p><p>#${t.task_number}</p></div>
        <div class="box"><p>NÃ¡zev</p><p>${t.task_name}</p></div>
        <div class="box"><p>Dodavatel</p><p>${t.supplier||'-'}</p></div>
        <div class="box"><p>Ãšsek</p><p>${sn(t.section)}</p></div>
        <div class="box"><p>Zadal/a</p><p>${creator?.full_name||'-'}</p></div>
        <div class="box"><p>Datum zadÃ¡nÃ­</p><p>${new Date(t.created_at).toLocaleString('cs-CZ')}</p></div>
        <div class="box"><p>ÄŒ. objednÃ¡vky</p><p>${t.order_number||'-'}</p></div>
        <div class="box"><p>ÄŒ. avÃ­za</p><p>${t.aviso_number||'-'}</p></div>
    </div>
    <h2>VÃ½sledky</h2>
    <div class="grid">
        <div class="box"><p>CelkovÃ½ Äas</p><p>${fmt(totalSec)}</p></div>
        <div class="box"><p>PoÄet kusÅ¯</p><p>${t.completed_pieces||0}</p></div>
        <div class="box"><p>NÃ¡klady prÃ¡ce</p><p>${labor.toFixed(2)} KÄ</p></div>
        <div class="box"><p>NÃ¡klady materiÃ¡lu</p><p>${matC.toFixed(2)} KÄ</p></div>
        <div class="box" style="border:2px solid #E30613"><p>Celkem nÃ¡klady</p><p style="color:#E30613">${(labor+matC).toFixed(2)} KÄ</p></div>
        ${t.completed_pieces>0?`<div class="box"><p>PrÅ¯mÄ›r/kus</p><p>${((labor+matC)/t.completed_pieces).toFixed(2)} KÄ</p></div>`:''}
    </div>
    <h2>ZÃ¡znamy prÃ¡ce po dnech</h2>`;
    Object.entries(byDay).forEach(([day,dayEntries])=>{
        const daySec=dayEntries.reduce((s,e)=>s+(e.duration||0),0);
        html+=`<p style="font-weight:bold;margin-top:10px;">ğŸ“… ${day} Â· celkem ${fmt(daySec)}</p>
        <table><tr><th>ZamÄ›stnanec</th><th>ÄŒas</th><th>OdpracovÃ¡no</th><th>NÃ¡klady</th></tr>`;
        dayEntries.forEach(e=>{
            const w=USERS.find(u=>u.id===e.userId);
            const cost=((e.duration||0)/3600)*(w?.hourly_rate||180);
            html+=`<tr><td>${w?.full_name||'?'}</td><td>${e.ts?new Date(e.ts).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}):'-'}</td><td>${fmt(e.duration||0)}</td><td>${cost.toFixed(2)} KÄ</td></tr>`;
        });
        html+='</table>';
    });
    if(mats.length>0){
        html+=`<h2>MateriÃ¡ly</h2><table><tr><th>MateriÃ¡l</th><th>MnoÅ¾stvÃ­</th><th>Cena/ks</th><th>Celkem</th></tr>`;
        mats.forEach(m=>{html+=`<tr><td>${m.name}</td><td>${m.qty} ${m.unit||'ks'}</td><td>${m.price} KÄ</td><td>${(m.qty*m.price).toFixed(2)} KÄ</td></tr>`;});
        html+='</table>';
    }
    if(billing.billed_to){
        html+=`<h2>VyÃºÄtovÃ¡nÃ­</h2><div class="billing"><strong>Komu:</strong> ${billing.billed_to} | <strong>Datum:</strong> ${billing.billed_date?new Date(billing.billed_date).toLocaleDateString('cs-CZ'):'-'} | <strong>ÄŒÃ¡stka:</strong> ${billing.billed_amount||0} KÄ${billing.billed_note?`<br><strong>PoznÃ¡mka:</strong> ${billing.billed_note}`:''}</div>`;
    }
    html+='</body></html>';
    const w=window.open('','_blank');
    w.document.write(html);
    w.document.close();
    setTimeout(()=>w.print(),500);
}

function notify(msg){const el=document.createElement('div');el.className='fixed bottom-6 right-6 bg-green-800 text-white px-6 py-4 rounded-xl shadow-2xl z-50 font-medium';el.textContent=msg;document.body.appendChild(el);setTimeout(()=>el.remove(),4000);}
function closeModal(id){document.getElementById(id).classList.add('hidden');}

// Mobile: ensure login triggers on touch and Enter
document.addEventListener('DOMContentLoaded', ()=>{
  const btn=document.getElementById('lbl_loginBtn');
  if(btn){
    btn.addEventListener('touchend', (e)=>{ e.preventDefault(); doLogin(); }, {passive:false});
  }
  const form=document.getElementById('loginForm');
  if(form){
    form.addEventListener('submit',(e)=>{ e.preventDefault(); doLogin(); });
  }
});
</script>

<!-- WAREHOUSE MODAL -->
<div id="modalWarehouse" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">ğŸ“¦ SprÃ¡va skladu materiÃ¡lÅ¯</h2>
            <button onclick="closeModal('modalWarehouse')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <div class="p-2 border-b border-gray-800 flex">
            <button onclick="whTab('materials')" id="wt_materials" class="flex-1 py-2 text-sm font-bold rounded-lg ardon-red text-white mx-1">ğŸ“¦ MateriÃ¡l</button>
            <button onclick="whTab('logos')" id="wt_logos" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ–¨ï¸ Loga (Potisk)</button>
            <button onclick="whTab('suppliers')" id="wt_suppliers" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ­ DodavatelÃ©</button>
            <button onclick="whTab('customers')" id="wt_customers" class="flex-1 py-2 text-sm font-bold rounded-lg bg-gray-800 text-gray-300 mx-1">ğŸ‘¤ ZÃ¡kaznÃ­ci</button>
        </div>

        <!-- MATERIALS TAB -->
        <div id="whTab_materials" class="p-6 space-y-4">
            <form id="formWarehouse" onsubmit="submitWarehouseItem(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat materiÃ¡l do skladu</p>
                <div class="grid grid-cols-3 gap-3">
                    <div class="col-span-2"><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label><input type="text" name="name" required placeholder="napÅ™. Karton A4" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Cena/kus (KÄ) *</label><input type="number" name="price" required step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Jednotka</label><select name="unit" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><option value="ks">ks</option><option value="m">m</option><option value="kg">kg</option><option value="l">l</option><option value="bal">bal</option></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Kategorie</label><input type="text" name="category" placeholder="napÅ™. Obal" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="ardon-red hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat</button>
            </form>
            <div id="warehouseList" class="space-y-2"></div>
        </div>

        <!-- LOGOS TAB (Potisk) -->
        <div id="whTab_logos" class="hidden p-6 space-y-4">
            <form id="formLogo" onsubmit="submitLogoItem(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat typ loga pro Potisk</p>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev *</label><input type="text" name="name" required placeholder="napÅ™. Logo zÃ¡kaznÃ­ka" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Velikost</label><select name="size" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"><option value="S">S - MalÃ©</option><option value="M">M - StÅ™ednÃ­</option><option value="L">L - VelkÃ©</option></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Cena/ks (KÄ) *</label><input type="number" name="price" required step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-blue-700 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat logo</button>
            </form>
            <div id="logoList" class="space-y-2"></div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="whTab_suppliers" class="hidden p-6 space-y-4">
            <form id="formSupplier" onsubmit="submitSupplier(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat dodavatele</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev dodavatele *</label><input type="text" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Kontakt (volitelnÃ©)</label><input type="text" name="contact" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat dodavatele</button>
            </form>
            <div id="supplierList" class="space-y-2"></div>
        </div>

        <!-- CUSTOMERS TAB -->
        <div id="whTab_customers" class="hidden p-6 space-y-4">
            <form id="formCustomer" onsubmit="submitCustomer(event)" class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-400 text-sm font-semibold">PÅ™idat zÃ¡kaznÃ­ka (Potisk)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev zÃ¡kaznÃ­ka *</label><input type="text" name="name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label><input type="text" name="note" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <button type="submit" class="bg-purple-700 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ PÅ™idat zÃ¡kaznÃ­ka</button>
            </form>
            <div id="customerList" class="space-y-2"></div>
        </div>
    </div>
</div>

<!-- SELECT MATERIAL MODAL -->
<div id="modalSelectMat" class="hidden fixed inset-0 modal-bg z-[60] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-5 border-b border-gray-800">
            <h2 class="text-lg font-bold">ğŸ“¦ Vybrat materiÃ¡l ze skladu</h2>
            <button onclick="closeModal('modalSelectMat')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <div class="p-5 space-y-3">
            <input type="text" id="matSearchInput" onkeyup="filterWarehouse()" placeholder="Hledat materiÃ¡l..." class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none text-sm">
            <div id="matSelectList" class="space-y-2"></div>
            <div id="matQtySection" class="hidden bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-white font-semibold" id="matSelectedName"></p>
                <div class="flex items-center gap-3">
                    <div class="flex-1"><label class="block text-gray-400 text-xs mb-1">MnoÅ¾stvÃ­</label><input type="number" id="matQtyInput" value="1" min="1" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                    <div class="flex-1"><label class="block text-gray-400 text-xs mb-1">Cena/ks</label><input type="number" id="matPriceInput" step="0.01" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none"></div>
                </div>
                <button onclick="confirmSelectMat()" class="w-full ardon-red hover:bg-red-700 text-white py-2 rounded-lg font-bold">âœ… PÅ™idat k Ãºkolu</button>
            </div>
        </div>
    </div>
</div>


<!-- EDIT TASK MODAL -->
<div id="modalEditTask" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <h2 class="text-xl font-bold">âœï¸ Upravit Ãºkol</h2>
            <button onclick="closeModal('modalEditTask')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formEditTask" onsubmit="submitEditTask(event)" class="p-6 space-y-4">
            <input type="hidden" name="task_id" id="editTaskId">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒÃ­slo Ãºkolu</label><input type="text" name="task_number" id="edit_task_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev Ãºkolu</label><input type="text" name="task_name" id="edit_task_name" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Dodavatel</label><input type="text" name="supplier" id="edit_supplier" list="suppliersList" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">NÃ¡zev / Logo / Popis</label><input type="text" name="goods_type" id="edit_goods_type" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒ. objednÃ¡vky</label><input type="text" name="order_number" id="edit_order_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
                <div><label class="block text-gray-400 text-sm mb-1">ÄŒ. avÃ­za</label><input type="text" name="aviso_number" id="edit_aviso_number" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Popis prÃ¡ce</label><textarea name="description" id="edit_description" rows="2" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none resize-none"></textarea></div>
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-gray-400 text-sm mb-1">Priorita</label>
                <select name="priority" id="edit_priority" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="0">Bez priority</option>
                    <option value="1">ğŸ”´ Priorita 1 - UrgentnÃ­</option>
                    <option value="2">ğŸŸ¡ Priorita 2 - StÅ™ednÃ­</option>
                    <option value="3">ğŸŸ¢ Priorita 3 - NormÃ¡lnÃ­</option>
                </select></div>
                <div><label class="block text-gray-400 text-sm mb-1">Stav</label>
                <select name="status" id="edit_status" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none">
                    <option value="pending">â³ ÄŒekÃ¡</option>
                    <option value="inProgress">â–¶ï¸ ProbÃ­hÃ¡</option>
                    <option value="completed">âœ… DokonÄeno</option>
                </select></div>
            </div>
            <div>
                <label class="block text-gray-400 text-sm mb-1">ğŸ‘¥ PÅ™iÅ™adit zamÄ›stnancÅ¯m <span class="text-gray-500 text-xs">(Ctrl+klik = vÃ­ce)</span></label>
                <select name="assigned_to" id="edit_assigned_to" multiple class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none h-36">
                </select>
                <p class="text-gray-600 text-xs mt-1">PodrÅ¾te Ctrl (nebo Cmd na Mac) pro vÃ½bÄ›r vÃ­ce zamÄ›stnancÅ¯. <span class="text-yellow-500">Bez vÃ½bÄ›ru = vidÃ­ vÅ¡ichni zamÄ›stnanci Ãºseku.</span></p>
            </div>
            <div><label class="block text-gray-400 text-sm mb-1">Norma (ks/hod)</label><input type="number" name="norm" id="edit_norm" class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg focus:border-red-500 focus:outline-none"></div>
            <div class="flex gap-3 pt-2">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold transition-colors">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
                <button type="button" onclick="closeModal('modalEditTask')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>


<!-- MANUAL/HISTORICAL TASK MODAL -->
<div id="modalManualTask" class="hidden fixed inset-0 modal-bg z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[95vh] overflow-y-auto border border-gray-700">
        <div class="flex justify-between items-center p-6 border-b border-gray-800">
            <div>
                <h2 class="text-xl font-bold">ğŸ“‹ HistorickÃ½ / archivnÃ­ Ãºkol</h2>
                <p class="text-gray-500 text-sm mt-1">RuÄnÃ­ zadÃ¡nÃ­ dokonÄenÃ©ho Ãºkolu s vlastnÃ­mi Äasy a materiÃ¡ly</p>
            </div>
            <button onclick="closeModal('modalManualTask')" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <form id="formManualTask" onsubmit="submitManualTask(event)" class="p-6 space-y-5">

            <!-- ZÃ¡kladnÃ­ info -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ“ ZÃ¡kladnÃ­ informace</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ­slo Ãºkolu *</label>
                    <input type="text" name="task_number" required placeholder="napÅ™. 41" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev Ãºkolu *</label>
                    <input type="text" name="task_name" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Dodavatel</label>
                    <input type="text" name="supplier" list="suppliersList" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">NÃ¡zev / Logo / Popis</label>
                    <input type="text" name="goods_type" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒ. objednÃ¡vky</label>
                    <input type="text" name="order_number" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒ. avÃ­za</label>
                    <input type="text" name="aviso_number" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ZÃ¡kaznÃ­k (Potisk)</label>
                    <input type="text" name="customer" list="customersList" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Ãšsek *</label>
                    <select name="section" id="manualSection" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                        <option value="exqc">ExQC</option>
                        <option value="blistrovani">BlistrovÃ¡nÃ­</option>
                        <option value="potisk">Potisk</option><option value="prijem">PÅ™Ã­jem</option><option value="extra_prace">Extra prÃ¡ce</option>
                        <option value="prace_z_domu">PrÃ¡ce z domu</option>
                        <option value="grafika">Grafika</option>
                    </select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Priorita</label>
                    <select name="priority" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm">
                        <option value="0">Bez priority</option>
                        <option value="1">ğŸ”´ P1 - UrgentnÃ­</option>
                        <option value="2">ğŸŸ¡ P2 - StÅ™ednÃ­</option>
                        <option value="3">ğŸŸ¢ P3 - NormÃ¡lnÃ­</option>
                    </select></div>
                </div>
                <div><label class="block text-gray-500 text-xs mb-1">Popis prÃ¡ce</label>
                <textarea name="description" rows="2" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm resize-none"></textarea></div>
            </div>

            <!-- Kdo a kdy -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ‘¤ Kdo a kdy</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Zadal/a Ãºkol</label>
                    <select name="created_by_manual" id="manualCreatedBy" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></select></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum zadÃ¡nÃ­</label>
                    <input type="datetime-local" name="created_at_manual" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">Datum dokonÄenÃ­</label>
                    <input type="datetime-local" name="completed_at_manual" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoÄet kusÅ¯</label>
                    <input type="number" name="completed_pieces" placeholder="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>

            <!-- ÄŒasy zamÄ›stnancÅ¯ -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-gray-300 font-bold text-sm">â±ï¸ ÄŒasy zamÄ›stnancÅ¯</p>
                    <button type="button" onclick="addManualTimeEntry()" class="bg-blue-700 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold">+ PÅ™idat Äas</button>
                </div>
                <p class="text-gray-600 text-xs">PÅ™idej Äas pro kaÅ¾dÃ©ho zamÄ›stnance kterÃ½ na Ãºkolu pracoval</p>
                <div id="manualTimeEntries" class="space-y-2"></div>
            </div>

            <!-- MateriÃ¡ly -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <div class="flex justify-between items-center">
                    <p class="text-gray-300 font-bold text-sm">ğŸ“¦ MateriÃ¡ly</p>
                    <button type="button" onclick="addManualMaterial()" class="bg-green-700 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold">+ PÅ™idat materiÃ¡l</button>
                </div>
                <div id="manualMaterials" class="space-y-2"></div>
            </div>

            <!-- VyÃºÄtovÃ¡nÃ­ -->
            <div class="bg-gray-800 rounded-xl p-4 space-y-3">
                <p class="text-gray-300 font-bold text-sm">ğŸ’° VyÃºÄtovÃ¡nÃ­ (volitelnÃ©)</p>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-gray-500 text-xs mb-1">VyÃºÄtovÃ¡no komu</label>
                    <input type="text" name="billed_to" placeholder="napÅ™. KomÃ¡rek" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">Datum vyÃºÄtovÃ¡nÃ­</label>
                    <input type="date" name="billed_date" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">ÄŒÃ¡stka (KÄ)</label>
                    <input type="number" name="billed_amount" step="0.01" placeholder="0.00" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                    <div><label class="block text-gray-500 text-xs mb-1">PoznÃ¡mka</label>
                    <input type="text" name="billed_note" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:border-red-500 focus:outline-none text-sm"></div>
                </div>
            </div>

            <div class="flex gap-3">
                <button type="submit" class="flex-1 ardon-red hover:bg-red-700 text-white py-3 rounded-xl font-bold text-lg transition-colors">ğŸ’¾ UloÅ¾it historickÃ½ Ãºkol</button>
                <button type="button" onclick="closeModal('modalManualTask')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white py-3 rounded-xl font-bold">ZruÅ¡it</button>
            </div>
        </form>
    </div>
</div>

<datalist id="warehouseDatalist"></datalist>
</body>
</html>
